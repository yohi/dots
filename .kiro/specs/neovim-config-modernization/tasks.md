# 実装タスク: neovim-config-modernization

## タスク概要

Neovim設定のモダナイゼーション: Vim scriptからLuaへの完全移行、LSP設定の一元化、レガシーコードの削除を段階的に実施する。

---

## 実装計画

- [x] 1. 安全な移行基盤を確立する
  - 作業ブランチを作成し、ロールバック手順を確認する
  - 現状の設定が正常に動作することを検証する
  - バックアップとリカバリ手順を文書化する
  - _Requirements: 全要件（移行の前提条件）_

- [x] 2. Lua設定の受け皿を構築する
- [x] 2.1 エントリポイントと設定ディレクトリを作成する
  - `init.lua` を新規作成し、互換モードで既存 `init.vim` を読み込む機能を実装する
  - `lua/config/` ディレクトリを作成する
  - `lua/utils/` ディレクトリを作成する
  - エントリポイントが既存設定を正常にロードできることを確認する
  - _Requirements: 1 (受け入れ基準 1, 2)_

- [x] 2.2 プラグイン管理の初期設定を準備する
  - `lazy.lua` のロード順序を `init.lua` に組み込む
  - leader キー設定がプラグインロード前に実行されることを確認する
  - プラグイン管理システムが正常に動作することを検証する
  - _Requirements: 1 (受け入れ基準 1, 3) (Note: 要件4.1の遅延ロードは後続フェーズで実装)_

- [x] 3. 基本オプション設定をLuaに移植する
- [x] 3.1 コアオプションを移植する
  - `rc/basic.vim` の内容を分析し、有効な設定のみを `config/options.lua` に変換する
  - エンコーディング、インデント、タブ幅、ファイル形式の設定を移植する
  - バックアップとスワップファイルの設定を移植する
  - TODOマーカーとコメントアウトコードは除外する
  - _Requirements: 1, 2.1_
  - _Note: Phase 1（移行基盤）の完了とPhase 2.1（Lua設定ディレクトリの作成）が前提となります。これにより `config/options.lua` への移植先が確保されます_

- [x] 3.2 UI設定を統合する
  - `rc/ui.vim` の内容を `config/options.lua` に統合する
  - 行番号、カーソル行、検索ハイライト、コマンドライン表示の設定を移植する
  - カラースキームとウィンドウ表示設定を移植する
  - _Requirements: 1_

- [x] 3.3 検索設定を統合する
  - `rc/search.vim` の内容を `config/options.lua` に統合する
  - 大文字小文字の扱い、インクリメンタル検索の設定を移植する
  - _Requirements: 1_

- [x] 3.4 性能とセキュリティ設定を追加する
  - `updatetime` を明示的に300msに設定する
  - `exrc` と `secure` オプションで外部ソース実行を制限する
  - 設定値が期待通りに適用されることを確認する
  - _Requirements: 1, 2.1_
  - _Note: 要件4（起動性能）の受け入れ基準2と要件5（セキュリティ）の受け入れ基準3,4を満たすための設定を `config/options.lua` に追加します。実装上の依存関係はPhase 1とPhase 2.1のみです_

- [ ] 4. キーマップと自動コマンドをLuaに移植する
- [x] 4.1 汎用キーマップを移植する
  - `rc/keymap.vim` の内容を分析し、有効なキーマップのみを `config/keymaps.lua` に変換する
  - モードごとに `vim.keymap.set` を使用してキーマップを定義する
  - 未使用キーマップとコメントアウトされたマッピングは除外する
  - 主要キーマップ（`;` → `:`, 分割移動等）が動作することを確認する
  - _Requirements: 1, 3 (受け入れ基準 3.2)_

- [x] 4.2 自動コマンドを移植する
  - `rc/basic.vim` 内の `augroup` を `config/autocmds.lua` に変換する
  - `vim.api.nvim_create_augroup` と `vim.api.nvim_create_autocmd` を使用する
  - WezTerm IME連携用の自動コマンドを移植する
  - コメントアウトされた自動コマンドは除外する
  - _Requirements: 1, 3 (受け入れ基準 3.2)_

- [ ] 5. LSP設定を一元化する
- [ ] 5.1 LSPサーバ設定を統合する
  - `lua/lsp.lua` と `lua/plugins/lsp_cfg.lua` の設定を分析する
  - 重複する10個のLSPサーバ設定を単一の `lsp_servers` テーブルに統合する
  - `vim.lsp.config()` と `vim.lsp.enable()` を使用してサーバを設定・有効化する
  - 各サーバのファイルタイプ、ルートマーカー、固有設定を定義する
  - _Requirements: 2 (受け入れ基準 1, 2, 4)_

- [ ] 5.2 LSP共通設定を統合する
  - `lua/lsp.lua` の診断設定を `plugins/lsp_cfg.lua` に移動する
  - `vim.diagnostic.config()` で診断表示方法を一元管理する
  - 補完能力とLSP関連キーマップを統合する
  - _Requirements: 2 (受け入れ基準 3)_

- [ ] 5.3 LSPアタッチを検証する
  - Python、Lua、YAML、Shell、PHP等の各ファイルタイプでLSPが正常にアタッチされることを確認する
  - `:LspInfo` コマンドで各サーバの状態を検証する
  - サーバ未インストール時に適切な警告が表示されることを確認する
  - _Requirements: 2 (全受け入れ基準の検証)_

- [ ] 6. APIキー管理ユーティリティを実装する
  - `utils/apikey.lua` を作成し、環境変数からAPIキーを取得する機能を実装する
  - キーが未設定の場合に警告を表示し、適切な戻り値を返す機能を実装する
  - `get_api_key()` 関数のインターフェースを定義する
  - ユニットテスト用の検証を行う
  - _Requirements: 5 (受け入れ基準 1, 2)_

- [ ] 7. エントリポイントを完成させる
- [ ] 7.1 init.luaを完成させる
  - 互換モードの記述を削除する
  - 設定モジュールのロード順序を確定する（options → keymaps → autocmds → lazy）
  - 各モジュールを `require` でロードする実装を完成させる
  - ロード順序を誤った場合のリスクを最小化する
  - _Requirements: 1_

- [ ] 7.2 段階的切り替えを実施する
  - 各モジュール移植完了ごとに `init.lua` を更新する
  - 対応する `runtime!` 呼び出しを削除する
  - 各切り替え後にNeovimが正常に起動することを確認する
  - _Requirements: 1, 3_

- [ ] 8. レガシーコードを削除する
- [ ] 8.1 Vim script設定ファイルを削除する
  - `init.vim` を削除する（または `.bak` にリネーム）
  - `rc/` ディレクトリ全体を削除する
  - `lua/lsp.lua` を削除する
  - 削除前にGitの状態を確認し、リバート可能な状態にする
  - _Requirements: 1 (受け入れ基準 2), 2 (受け入れ基準 2), 3 (受け入れ基準 1, 4)_

- [ ] 8.2 削除後の動作を検証する
  - `nvim --headless +qa` がエラーなく終了することを確認する
  - `:checkhealth` で重大エラーがないことを確認する
  - 主要機能（LSP、補完、キーマップ）が正常に動作することを確認する
  - _Requirements: 全要件_

- [ ] 9. 起動性能を最適化する
- [ ] 9.1 プラグイン遅延ロードを設定する
  - `plugins/*.lua` の各プラグイン定義で `event`, `cmd`, `ft` による遅延ロードを設定する
  - 起動時に必須でないプラグインを特定し、遅延ロード対象とする
  - `:Lazy profile` で起動時間を測定する
  - _Requirements: 4 (受け入れ基準 1)_

- [ ] 9.2 自動更新チェックを無効化する
  - `lazy.lua` の `checker.enabled` を `false` に設定する
  - `lazy-lock.json` がGit管理下にあることを確認する
  - 自動更新が実行されないことを確認する
  - _Requirements: 4 (受け入れ基準 3)_

- [ ] 10. 最終検証とテストを実施する
- [ ] 10.1 統合テストを実施する
  - Neovim起動テスト: エラーなく起動し、全モジュールがロードされることを確認する
  - LSPアタッチテスト: 各ファイルタイプでLSPが正常にアタッチされることを確認する
  - キーマップテスト: 主要キーマップが期待通りに動作することを確認する
  - WezTerm連携テスト: IME制御が正常に動作することを手動確認する
  - _Requirements: 全要件_

- [ ] 10.2 移行チェックリストを完了する
  - 全ての移行テストチェックリスト項目を確認する
  - 起動時間、LSPステータス、セキュリティ設定を検証する
  - 設計書の完了条件がすべて満たされていることを確認する
  - _Requirements: 全要件_

- [ ] 10.3 ドキュメントを更新する
  - 移行完了を記録し、新しい設定構造を文書化する
  - トラブルシューティング情報を追加する
  - ロールバック手順の有効性を確認する
  - _Requirements: 全要件_

---

## 実装時の注意事項

- 各フェーズ完了後に必ずNeovim起動テストを実施し、問題があれば即座にロールバック
- `nvim --headless +qa` と `:checkhealth` でエラーチェックを徹底
- 段階的移行により、常に動作する設定を維持
- LSPサーバ設定は `lsp_servers` テーブルの追加のみで完結するよう設計
- APIキーは環境変数から取得し、設定ファイルにハードコードしない
- プラグインバージョンは `lazy-lock.json` で固定し、Gitで管理する
