# 実装タスク

- [ ] 1. エントリポイントとヘルプの確立
- [ ] 1.1 デフォルト実行でヘルプを表示し、公開ターゲットだけを列挙する
  - `make` と `make help` で同一のヘルプが表示されるようにする
  - 公開/内部ターゲットの判定ルールを適用し、内部ターゲットはヘルプ表示から除外する
  - ヘルプ出力がカテゴリ別に整理され、主要な導線（セットアップ/インストール/チェック等）が一目で分かるようにする
  - `make` / `make help` 実行時にファイル作成やディレクトリ作成などの副作用が発生しないことを保証する
  - _Requirements: 1.1, 1.2_

- [ ] 1.2 公開ターゲットのカテゴリと命名規則を要件に合わせて整備する
  - 要件で定義されたカテゴリ（システム設定、パッケージ、設定、管理、プリセット、段階的セットアップ等）に沿って公開ターゲットを揃える
  - 新規/整理後のターゲット名がハイフン区切りかつ動詞開始（`install-`, `setup-`, `update-`, `check-`, `clean-`）になるよう統一する
  - 内部ターゲットは先頭アンダースコアの命名に統一し、公開ターゲットと混在しないようにする
  - 既存の入口ターゲット（`quick`, `dev-setup`, `full`, `minimal` 等）がヘルプから見つけやすい配置になるよう調整する
  - _Requirements: 1.2, 1.4_

- [ ] 2. 既存ターゲット互換と廃止予定ターゲット管理
- [ ] 2.1 (P) 短縮エイリアスを維持し、主要導線が壊れないようにする
  - 既存の短縮エイリアス（`i`, `s`, `h`, `s1`〜`s5`, `ss`, `sg` など）が従来どおりに動作するようにする
  - 短縮エイリアスが「廃止予定の旧名エイリアス」と混在しないよう、責務を分離して管理できる状態にする
  - 短縮エイリアス経由でもヘルプ/公開ターゲット体系の期待される振る舞いが維持されることを確認する
  - _Requirements: 1.3_

- [ ] 2.2 (P) 旧ターゲット名→新ターゲット名の互換エイリアスを提供する
  - 旧ターゲット名が呼び出された場合に、新ターゲット名へ確実に誘導されるようにする
  - デフォルトでは廃止警告を出さず、後方互換の振る舞いを維持する
  - 旧名・新名いずれの経路でも失敗時に非0終了コードが返ることを担保する
  - _Requirements: 1.3, 2.1, 2.4_

- [ ] 2.3 廃止ガイダンス出力とタイムラインポリシーを実装する
  - 廃止予定マップに「旧名/新名/廃止開始日/削除予定日/ステータス」を保持し、運用で更新できるようにする
  - `MAKE_DEPRECATION_WARN/QUIET/STRICT` に応じて、ガイダンスの出力有無・出力先（stderr）・終了コードを切り替える
  - warning/transition/removed の各フェーズで、要求されたメッセージ形式と終了コードを満たす
  - 最小警告期間などタイムラインポリシーの検証を行い、ポリシー違反は早期に検知して失敗させる
  - _Requirements: 2.2, 2.3, 2.4_

- [ ] 3. Bitwarden 連携（WITH_BW オプトイン）
- [ ] 3.1 WITH_BW のオプトインセマンティクスを全ターゲットに適用する
  - `WITH_BW=1` の場合のみ Bitwarden 連携を有効化し、未設定/`WITH_BW=0` は完全にスキップする
  - 汎用ターゲットは Bitwarden 連携をスキップして正常終了し、`bw-*` ターゲットは案内を出して失敗（exit 1）する
  - 環境変数としての設定と Make 引数としての指定の両方で有効化でき、CI/ローカルで同一の挙動になるようにする
  - 既存のレガシースクリプトが `WITH_BW` を認識しない場合でも、破壊的変更を起こさず従来動作を維持する
  - _Requirements: 2.5, 2.6, 2.7, 2.8, 3.1_

- [ ] 3.2 Bitwarden 状態判定とエラーハンドリングを整備し、秘匿情報を出力しない
  - Bitwarden CLI の状態を判定し、操作可能/不可の理由（未導入、未ログイン、ロック等）を人間可読に案内できるようにする
  - `WITH_BW=1` で必要な前提（例: `bw`, `jq`）が不足している場合は、具体的な解決手順を示して失敗（exit 1）する
  - `jq` が利用できない環境では、最小限の状態判定をフォールバック（grep 等）で行えるようにする
  - どの失敗モードでも、シークレット値やセッションキーが stdout/stderr/ログに出ないよう出力契約を統一する
  - _Requirements: 3.2, 3.3, 3.7_

- [ ] 3.3 `bw-unlock` を eval パターンで提供し、BW_SESSION を永続化しない
  - 成功時は `export BW_SESSION="..."` 形式のみを stdout に出力し、`eval` で設定できるようにする
  - `BW_SESSION` が既に設定済みかつ有効な場合は、再アンロックせず既存セッションを再出力する
  - `BW_PASSWORD` が設定されている場合は、非対話的にアンロックできるようにする
  - 失敗時は stderr のみで案内し、要件どおりの終了コード（`WITH_BW` 未設定時は警告のみ）を返す
  - _Requirements: 3.4, 3.5, 3.6, 3.8_

- [ ] 3.4 シークレット取得を自動化フローに接続し、シナリオ別エラーを満たす
  - 指定アイテム名からシークレットを取得し、必要なコマンド実行へ渡せるようにする
  - 未ログイン/ロック/未導入/ネットワークエラー/未発見の各シナリオで、期待されるメッセージと終了コードを満たす
  - 汎用ターゲットは `WITH_BW` 未設定時に安全にスキップし、Bitwarden 専用ターゲットは明確に失敗させる
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 4. 冪等性基盤と安全な再実行
- [ ] 4.1 (P) 冪等性検出メソッドを共通化し、パース時副作用ゼロを保証する
  - 許可された冪等性検出メソッド（ファイル存在/バージョン/マーカー/コマンド成功）を共通の仕組みとして提供する
  - マーカーファイルを規定ディレクトリに作成し、権限や内容フォーマットの要件を満たす
  - バージョン比較、シンボリックリンク一致、コマンド存在などの標準パターンを提供する
  - `make` / `make help` の実行時にファイルシステム変更が発生しない（パース時副作用ゼロ）ことを担保する
  - _Requirements: 4.1, 4.3, 4.4, 4.5_

- [ ] 4.2 公開ターゲットごとに冪等性検出を宣言し、充足時は安全にスキップできるようにする
  - 公開ターゲットが利用する冪等性検出メソッドを明示し、要件の宣言テーブルに整合するよう揃える
  - 依存が未満たしの場合は不足を報告して失敗し、充足している場合は再インストールせず完了できるようにする
  - スキップ時は `[SKIP] <target> is already completed.` 形式で stdout に表示する
  - _Requirements: 4.2, 4.7_

- [ ] 4.3 マーカーのクリーンアップと強制再実行の導線を提供する
  - マーカーファイルの全削除/個別削除を行える管理ターゲットを提供する
  - 現在の冪等性状態を一覧化するターゲットを提供し、問題切り分けに使えるようにする
  - `FORCE=1` 設定時は冪等性チェックをスキップして再実行できるようにする
  - _Requirements: 4.6, 4.7_

- [ ] 5. Devcontainer 内のテスト環境
- [ ] 5.1 (P) Devcontainer を用意し、コンテナ内で Make ターゲットのテストが完結するようにする
  - ベースイメージと必要な依存関係を揃え、コンテナ内で Make ターゲットが実行できる状態にする
  - Bitwarden CLI を指定バージョン以上でインストールできるようにする
  - ホスト依存がある操作は、コンテナ内での代替または前提条件チェックにより明示する
  - _Requirements: 5.1, 5.2_

- [ ] 5.2 クレデンシャル転送と起動時ブートストラップを実装する
  - `BW_SESSION` と `WITH_BW` をホストからコンテナへ安全に転送できるようにする
  - コンテナ作成時に依存関係検証とテストセットアップを自動実行し、`WITH_BW=1` の場合のみ疎通確認を実施する
  - _Requirements: 5.3, 5.4_

- [ ] 5.3 モック/統合テストを Make ターゲットとして提供し、CI/ローカル双方で検証できるようにする
  - 認証不要のモックテストで Bitwarden 連携の主要分岐を再現し、失敗モードの挙動を検証できるようにする
  - `BW_SESSION` 必須の統合テストを用意し、未設定時は明確に失敗させる
  - `make test` で冪等性/ヘルプ/エイリアスと Bitwarden 連携の検証をまとめて実行できるようにする
  - _Requirements: 5.5_

