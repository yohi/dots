# ギャップ分析: Makefile Bitwarden連携とリファクタリング

## 1. 概要
本ドキュメントは、既存のMakefileシステムと新機能要件（Bitwarden連携、構造改革、Devcontainer対応）との間のギャップを分析した結果である。
現状のコードベースはモジュール化が進んでいるものの、シークレット管理機能が完全に欠落しており、テスト環境も標準化されていない。

## 2. 現状分析 (Current State)

### 2.1 構成と構造
- **モジュール化**: `mk/` ディレクトリに機能別のMakefile（`system.mk`, `install.mk`等）が分割配置されており、ルートの `Makefile` でこれらをincludeしている。
- **命名規則**: 多くのターゲットはハイフン区切り（`install-homebrew`, `setup-vim`）に従っているが、`shortcuts.mk` や `menu.mk` には短縮形エイリアスも存在する。
- **依存関係管理**: `mk/install.mk` 内の `install-apps` ターゲットが `Brewfile` を参照している。

### 2.2 Bitwarden (CLI) の状況
- **インストール**: `Brewfile` に `brew "bitwarden-cli"` が含まれており、`make install-apps` を実行済みであれば `bw` コマンドは利用可能である。
- **利用状況**: 現在のMakefile群 (`mk/*.mk`) 内で `bw` コマンドを使用している箇所は存在しない。
- **シークレット管理**: APIキーや認証情報は、ユーザーの手動入力か、既存の環境変数に依存しており、体系的な注入メカニズムがない。

### 2.3 開発・テスト環境
- **Devcontainer**: プロジェクトルートに `.devcontainer` 設定が存在しない（`vim/.devcontainer` は存在するが、ドットファイル全体のテスト用ではない）。
- **テスト**: `make` ターゲットの動作を検証する自動化された手段がなく、ホスト環境に依存している。

## 3. ギャップ詳細 (Identified Gaps)

### 3.1 Bitwarden連携 (Critical)
- **欠如機能**:
  - `bw login` / `bw unlock` のステート管理（セッションキーのハンドリング）。
  - アイテム名やIDからシークレットを取得する共通関数またはターゲット。
  - シークレットが見つからない場合の安全なフォールバック処理。
- **課題**: Makeの各行は独立したシェルで実行されるため、`BW_SESSION` 環境変数の永続化が難しい。`eval $(make bw-unlock)` のようなパターンか、ファイルベースの一時保存（セキュリティリスクあり）か、都度入力かの設計判断が必要。

### 3.2 構造リファクタリング
- **必要アクション**:
  - `mk/bitwarden.mk` の新規作成。
  - 既存の「シークレットを必要とする可能性のあるターゲット」の洗い出し（現状は明示的な依存がないため、将来の拡張への準備となる）。
  - `help` ターゲットへのBitwarden関連コマンドの統合。

### 3.3 Devcontainer対応
- **欠如機能**: Makefile自体をクリーンな環境で実行・テストするためのDevcontainer定義。
- **必要アクション**:
  - `.devcontainer/devcontainer.json` および `Dockerfile` の作成。
  - テスト用コンテナ内での `bw` CLI 利用可否の検証（ホスト側の認証情報のパススルー等）。

## 4. 推奨実装アプローチ

### 4.1 Bitwardenモジュール (`mk/bitwarden.mk`)
- **ターゲット設計**:
  - `bw-login`: APIキーまたはメールアドレスでのログイン。
  - `bw-unlock`: セッションキー生成と表示（`eval`用）。
  - `bw-get-item-%`: パターンマッチで任意のアイテムを取得。
- **ヘルパー関数**:
  - Makeの `define` や `shell` 関数を使用し、`bw get password <name>` をラップしてエラーハンドリングを追加する。

### 4.2 Devcontainer
- **構成**:
  - Ubuntuベースのイメージを使用。
  - `make`, `gcc`, `git`, `curl` 等の基本ツールをプリインストール。
  - `bw` CLI もプリインストールし、テスト実行可能な状態にする。

### 4.3 互換性維持
- 既存の `make install` 等はBitwardenを必須とせず、オプション（`WITH_BW=1` など）または特定のターゲット（`make setup-secrets`）でのみ発動するように設計する。

## 5. リスクと対策
- **セッション管理**: Makeの制約上、セッションキーの維持が最大の課題。ユーザー体験を損なわないよう、`expect` コマンドやラッパースクリプトの併用も検討する。
- **セキュリティ**: ログ出力にシークレットが含まれないよう、`@` (silent command) を徹底し、ログ記録機能を実装する場合はフィルタリングを行う。

## 6. 結論
既存のコードベースはモジュール化されており拡張は容易である。`mk/bitwarden.mk` の追加とルートへのDevcontainer定義の追加により、既存機能を破壊することなく要件を満たすことが可能である。最大の技術的課題はMake内でのBitwardenセッションの取り回しである。
