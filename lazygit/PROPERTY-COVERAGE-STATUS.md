# プロパティカバレッジステータス

## 概要

このドキュメントは、設計仕様で定義されたプロパティベーステストの実装ステータスを追跡します。プロパティベーステストは、正確性プロパティがすべての有効な入力に対して保持されることを検証し、例ベースのテストよりも強力な保証を提供します。

**現在のカバレッジ**: 19.35%（31の要件のうち6つに対応するプロパティテストがある）

## 定義されたプロパティ

設計ドキュメントでは、プロパティベーステストを通じて検証すべき5つの正確性プロパティが定義されています:

### プロパティ 1: 複数候補生成
**ステータス**: ❌ 未実装

**定義**: 任意の有効なdiff入力に対して、AIシステムは2個以上のコミットメッセージ候補を生成すること。

**検証**: 要件 2.1

**実装タスク**: tasks.mdの4.1

**重要な理由**: ユーザーが常に選択肢を持つことを保証し、AIアシスト選択の目的を損なう単一オプションシナリオを防ぎます。

---

### プロパティ 2: 正規表現解析の完全性
**ステータス**: ❌ 未実装

**定義**: 任意の改行区切りテキスト出力（各行が非空）に対して、正規表現パーサーは各行を個別のメッセージ候補として抽出すること。

**検証**: 要件 5.4

**実装タスク**: tasks.mdの5.1

**重要な理由**: AI生成候補が解析中に失われないことを保証し、ユーザーのための完全なオプションセットを維持します。

---

### プロパティ 3: シェルインジェクション防止
**ステータス**: ❌ 未実装

**定義**: 任意のコミットメッセージテキスト（特殊文字を含む）に対して、エスケープ処理後のコマンド文字列はシェルインジェクションを引き起こさないこと。

**検証**: 要件 4.2、8.3

**実装タスク**: tasks.mdの7.1

**重要な理由**: 悪意のあるまたは偶発的な特殊文字が意図しないコマンドを実行できないことを保証する重要なセキュリティプロパティ。

---

### プロパティ 4: Conventional Commits形式準拠
**ステータス**: ❌ 未実装

**定義**: 任意のdiff入力に対して、生成されるすべてのコミットメッセージは有効なConventional Commits形式（`<type>(<scope>): <description>`または`<type>: <description>`）に従うこと。

**検証**: 要件 6.1

**実装タスク**: tasks.mdの4.2

**重要な理由**: 生成されたすべてのメッセージで一貫したコミット履歴形式を保証し、リポジトリ標準を維持します。

---

### プロパティ 5: Markdown除去
**ステータス**: ❌ 未実装

**定義**: 任意のdiff入力に対して、生成されたコミットメッセージにMarkdown記号（`**`、`*`、`` ` ``、`#`、`-`など）が含まれないこと。

**検証**: 要件 6.3

**実装タスク**: tasks.mdの4.3

**重要な理由**: コミットメッセージの形式アーティファクトを防ぎ、gitログに適したクリーンなプレーンテキスト出力を保証します。

---

## 現在のテストカバレッジ

### 実装されたテスト

プロジェクトには包括的な統合テストとユニットテストがあります:

1. **test-complete-workflow.sh** - エンドツーエンドワークフローをカバーする23の統合テスト
2. **test-error-handling.sh** - エラーシナリオ用の12テスト
3. **test-timeout-handling.sh** - タイムアウト動作用の5テスト
4. **test-all-error-scenarios.sh** - 様々なエラー条件用の11テスト
5. **test-lazygit-commit-integration.sh** - LazyGit統合用の5テスト
6. **test-menu-integration.sh** - メニュー機能用の7テスト
7. **test-regex-parser.sh** - パーサー動作用の7テスト
8. **test-commit-escape.sh** - エスケープ処理用の8テスト
9. **test-ai-backend-integration.sh** - バックエンド固有のテスト

**合計**: 78以上のテスト、すべて合格

### ギャップ分析

プロジェクトには優れた例ベースのテストカバレッジがありますが、以下を行うプロパティベーステストが欠けています:

1. **ランダム入力でテスト**: 現在のテストは固定例を使用；プロパティテストは数千のランダム入力を生成
2. **エッジケースを発見**: プロパティテストは例ベースのテストが見逃すバグをしばしば発見
3. **形式的保証を提供**: プロパティは実行可能な仕様として機能

## 推奨事項

### 優先度 1: セキュリティプロパティ

プロパティ3（シェルインジェクション防止）を最初に実装:
- セキュリティにとって重要
- 実装が比較的簡単
- システムの安全性に大きな影響

**推奨アプローチ**:
```python
from hypothesis import given, strategies as st

@given(st.text())
def test_shell_injection_prevention(message):
    escaped = apply_quote_filter(message)
    result = subprocess.run(f'echo {escaped}', shell=True, capture_output=True)
    assert result.returncode == 0
    # コマンドインジェクションが発生しなかったことを確認
```

### 優先度 2: 形式準拠

プロパティ4と5（Conventional CommitsとMarkdown除去）を実装:
- コア機能を検証
- 一貫した出力品質を保証
- 一緒にテスト可能

**推奨アプローチ**:
```python
@given(valid_diff_content())
def test_conventional_commits_format(diff):
    candidates = generate_commit_messages(diff)
    pattern = r'^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .+'
    for candidate in candidates:
        assert re.match(pattern, candidate)

@given(valid_diff_content())
def test_no_markdown(diff):
    candidates = generate_commit_messages(diff)
    markdown_symbols = ['**', '*', '`', '#', '---', '```']
    for candidate in candidates:
        for symbol in markdown_symbols:
            assert symbol not in candidate
```

### 優先度 3: 機能プロパティ

プロパティ1と2（複数候補と解析完全性）を実装:
- コアワークフローを検証
- ユーザーエクスペリエンス品質を保証
- セキュリティプロパティよりリスクが低い

## 実装戦略

### フェーズ 1: セットアップ（1〜2時間）
1. プロパティテストフレームワークを選択:
   - Python: `hypothesis`（bashスクリプトテストに推奨）
   - JavaScript: `fast-check`
   - Bash: `shunit2`を使用したカスタムジェネレーター

2. テストインフラストラクチャを作成:
   - プロパティテストランナースクリプト
   - diff、メッセージなどの入力ジェネレーター
   - 既存のテストスイートとの統合

### フェーズ 2: 実装（4〜6時間）
1. プロパティ3を実装（セキュリティクリティカル）
2. プロパティ4と5を実装（形式検証）
3. プロパティ1と2を実装（機能検証）

### フェーズ 3: 統合（1〜2時間）
1. CI/CDパイプラインにプロパティテストを追加
2. プロパティテスト実行をドキュメント化
3. カバレッジメトリクスを更新

## プロパティベーステストのメリット

1. **より強力な保証**: プロパティは例だけでなくすべての入力に対して保持
2. **バグ発見**: 手動テストで見逃されたエッジケースをしばしば発見
3. **生きたドキュメント**: プロパティは実行可能な仕様として機能
4. **リグレッション防止**: ランダムテストが予期しない方法でリグレッションをキャッチ
5. **信頼性**: 正確性に対する数学的信頼を提供

## 現在のステータスサマリー

✅ **強み**:
- 包括的な統合テストスイート（78以上のテスト）
- 例を使用してすべての機能要件を検証
- 優れたエラー処理カバレッジ
- よくドキュメント化されたテスト手順

❌ **ギャップ**:
- プロパティベーステストが実装されていない
- 限定的なランダム入力テスト
- セキュリティプロパティの形式的検証なし
- カバレッジメトリクス（19.35%）が欠落しているプロパティテストを反映

## 次のステップ

1. **即時**: プロジェクトステータスでこのギャップをドキュメント化
2. **短期**: プロパティ3を実装（セキュリティクリティカル）
3. **中期**: 残りのプロパティを実装
4. **長期**: プロパティテストをCI/CDに統合

## 参照

- 設計ドキュメント: `.kiro/specs/lazygit-ai-commit/design.md`（セクション: 正確性プロパティ）
- タスクドキュメント: `.kiro/specs/lazygit-ai-commit/tasks.md`（タスク 4.1、4.2、4.3、5.1、7.1）
- テストガイド: `TESTING-GUIDE.md`

---

**最終更新**: 2025年11月27日
**ステータス**: ドキュメント完了、実装保留中
