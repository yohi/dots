---
description: Makefile分割・保守に関するルール - プロジェクトのMakefileを機能別に分割し、保守性を向上させるためのガイドライン
globs:
  - "Makefile"
  - "mk/*.mk"
  - "**/*.mk"
alwaysApply: false
---

# Makefile Organization Rules
このプロジェクトのMakefile分割・保守に関するルール

## 全般的な方針

### 1. Makefileの構造化
- 大きなMakefile（1000行以上）は機能別に分割する
- メインMakefileはincludeディレクティブと最小限のターゲットのみを含む
- 分割ファイルは`mk/`ディレクトリに格納する

### 2. ファイル命名規則
- 分割ファイル名は機能を表す英語名.mkとする
- ファイル名は**小文字のみ**を使用
- 複合語は**ハイフン1つ**で区切る（例: `sticky-keys.mk`）
- アンダースコアは使用しない
- 略語は避け、意味が明確な名前を使用する

#### 命名規則の例
- 推奨: `system.mk`, `install.mk`, `sticky-keys.mk`, `help-short.mk`
- 非推奨: `sys.mk`（略語）, `install_apps.mk`（アンダースコア）

#### レガシー例外
以下のファイルは歴史的経緯により命名規則から外れているが、互換性のため維持：
- `cc-sdd.mk`: 外部ツール名に由来（ハイフン2つ）
- `deprecated-targets.mk`: 長い名前だが意味が明確

新規ファイル作成時はこれらを参考にせず、上記の命名規則に従うこと。

## 分割ファイルの分類と責任範囲

### Core Files（基本ファイル）
システムの基盤となるファイル。他のファイルから参照される。

| ファイル | 責任範囲 |
|---------|---------|
| `variables.mk` | 変数定義、PHONYターゲット宣言の集約 |
| `idempotency.mk` | 冪等性管理（マーカー、チェック機能、FORCEフラグ） |
| `help.mk` | ヘルプメッセージとターゲット説明 |
| `help-short.mk` | 短縮形ヘルプ（クイックリファレンス） |
| `presets.mk` | セットアッププリセット定義 |

### Functional Files（機能別ファイル）
個別の機能領域を担当するファイル。

| ファイル | 責任範囲 |
|---------|---------|
| `system.mk` | システムレベル設定（ロケール、基本パッケージ） |
| `fonts.mk` | フォント管理（Nerd Fonts、Google Fonts、日本語フォント） |
| `install.mk` | アプリケーションインストール（Homebrew、DEB、Flatpak） |
| `setup.mk` | 設定ファイルのセットアップ（vim, zsh, git等） |
| `gnome.mk` | GNOME関連設定（テーマ、外観） |
| `mozc.mk` | 日本語入力関連（Mozc、辞書） |
| `extensions.mk` | GNOME拡張機能のインストール・設定 |
| `clipboard.mk` | クリップボード管理ツール設定 |
| `sticky-keys.mk` | SHIFTキー固定モード設定・解除 |
| `shortcuts.mk` | キーボードショートカット設定 |
| `clean.mk` | クリーンアップ関連 |

### Infrastructure Files（インフラ・運用ファイル）
システム運用・管理に関するファイル。

| ファイル | 責任範囲 |
|---------|---------|
| `bitwarden.mk` | 認証・秘密管理（Bitwarden CLI連携） |
| `memory.mk` | メモリ最適化・監視 |
| `stages.mk` | 段階的セットアップ管理（ステージ1-5） |
| `menu.mk` | インタラクティブメニューシステム |

### AI & Tools Files（AI・開発ツールファイル）
AI開発支援ツールとその設定。

| ファイル | 責任範囲 |
|---------|---------|
| `codex.mk` | Codex CLI のインストール・設定 |
| `opencode.mk` | OpenCode（opencode）のインストール・設定 |
| `superclaude.mk` | SuperClaude Framework のインストール・管理 |
| `cc-sdd.mk` | cc-sdd（Spec-Driven Development）のセットアップ |

### Meta Files（メタ・管理ファイル）
統合機能やプロジェクト管理に関するファイル。

| ファイル | 責任範囲 |
|---------|---------|
| `main.mk` | 統合ターゲット（setup-all等）、デバッグ機能 |
| `deprecated-targets.mk` | 非推奨ターゲットの互換性維持 |
| `test.mk` | テスト関連（モック、インテグレーション） |

## コーディング規則

### 1. include順序
メインMakefileでのinclude順序は以下の論理構造を遵守：

```makefile
# ============================================================
# Core: 基盤（他ファイルから参照される）
# ============================================================
include mk/variables.mk
include mk/idempotency.mk
include mk/help.mk
include mk/help-short.mk
include mk/presets.mk

# ============================================================
# Infrastructure: 認証・秘密管理
# ============================================================
include mk/bitwarden.mk

# ============================================================
# Functional: 機能別（アルファベット順を推奨）
# ============================================================
include mk/system.mk
include mk/fonts.mk
include mk/install.mk
include mk/setup.mk
include mk/gnome.mk
include mk/mozc.mk
include mk/extensions.mk
include mk/clipboard.mk
include mk/sticky-keys.mk
include mk/clean.mk

# ============================================================
# Meta: 統合・ステージ管理
# ============================================================
include mk/main.mk
include mk/stages.mk
include mk/menu.mk
include mk/shortcuts.mk
include mk/deprecated-targets.mk

# ============================================================
# Infrastructure: パフォーマンス
# ============================================================
include mk/memory.mk

# ============================================================
# AI & Tools: AI開発支援ツール
# ============================================================
include mk/codex.mk
include mk/opencode.mk
include mk/superclaude.mk
include mk/cc-sdd.mk

# ============================================================
# Testing: テスト
# ============================================================
include mk/test.mk
```

### 2. ターゲット命名規則
- アクション-対象の形式：`setup-vim`, `install-homebrew`
- 複数単語はハイフンで区切る：`setup-gnome-extensions`
- 動詞から始める：`install-`, `setup-`, `clean-`, `backup-`, `check-`, `test-`
- 状態確認系：`check-`プレフィックス（例: `check-superclaude`）
- テスト系：`test-`プレフィックス（例: `test-bw-mock`）

### 3. コメント記述
- ファイル冒頭に機能説明を記述
- 各ターゲットの前に1行コメントで説明
- 複雑な処理にはセクションコメントを追加
- 日本語と英語の併用可（ファイル内で一貫性を保つ）

```makefile
# ============================================================
# セクション名（機能の大分類）
# ============================================================

# ターゲットの説明（1行）
target-name: ## ヘルプ用の説明（make helpで表示）
    @echo "処理内容"
```

### 4. エコーメッセージ統一
絵文字と日本語を使用してユーザーフレンドリーに：

```makefile
@echo "🚀 セットアップを開始中..."      # 開始
@echo "📦 パッケージをインストール中..."  # 進行中
@echo "✅ インストールが完了しました"     # 成功
@echo "⚠️  警告: 設定ファイルが見つかりません" # 警告
@echo "❌ エラー: インストールに失敗しました"  # エラー
@echo "ℹ️  情報: 再起動が必要です"        # 情報
@echo "[SKIP] 既に完了済みです"          # スキップ（冪等性）
```

### 5. 変数の管理
- **推奨**: 全ての共有変数は`variables.mk`で定義
- ファイル固有の変数はそのファイル冒頭で定義可
- 変数名は`UPPER_CASE_WITH_UNDERSCORES`を使用

```makefile
# variables.mk（共有変数）
DOTFILES_DIR := $(CURDIR)
CONFIG_DIR := $(HOME)/.config
HOME_DIR := $(HOME)

# 個別ファイル（ファイル固有変数）
SUPERCLAUDE_MODES := MODE_Brainstorming.md ...
```

### 6. PHONYターゲット管理
- **推奨**: 全てのPHONYターゲットは`variables.mk`に集約
- ファイル生成を伴わないターゲットは必ずPHONY指定
- 新規ターゲット追加時は`variables.mk`のPHONYリストを更新

```makefile
# variables.mk
.PHONY: all help setup-system install-packages-homebrew \
        setup-config-vim setup-config-zsh ...
```

### 7. エラーハンドリング
- 継続可能なエラーには`|| true`を使用
- 重要な処理の失敗時は適切なエラーメッセージを出力
- 条件分岐でファイル/コマンドの存在確認を行う

```makefile
@if command -v brew >/dev/null 2>&1; then \
    brew install package || echo "⚠️ インストールに失敗しました"; \
else \
    echo "❌ Homebrewが見つかりません"; \
fi
```

## 冪等性管理ガイドライン

### マーカーファイルの使用
時間のかかる処理は冪等性チェックを実装する：

```makefile
# idempotency.mkで定義されたマクロを使用
target-name:
    @if $(call check_marker,target-name); then \
        echo "$(call IDEMPOTENCY_SKIP_MSG,target-name)"; \
        exit 0; \
    fi
    # 実際の処理
    @$(call create_marker,target-name,1.0.0)
```

### FORCEフラグ
マーカーを無視して再実行する場合：
```bash
make FORCE=1 target-name
```

### バージョンチェック
バージョン依存の処理には`check_min_version`マクロを使用：
```makefile
@$(call check_min_version,node --version,Node.js,18.0.0)
```

### シンボリックリンクチェック
設定ファイルのリンク状態確認には`check_symlink`マクロを使用：
```makefile
@$(call check_symlink,$(HOME)/.zshrc,$(DOTFILES_DIR)/zsh/.zshrc)
```

## 段階的セットアップガイドライン

### ステージングパターン
大規模セットアップは`stages.mk`のパターンに従う：

```makefile
.PHONY: stage1
stage1: ## ステージ1: 説明
    @set -e; \
    echo "🚀 ステージ1を開始..."; \
    $(MAKE) sub-target-1 || { echo "❌ 失敗"; exit 1; }; \
    $(MAKE) sub-target-2 || { echo "❌ 失敗"; exit 1; }; \
    echo "✅ ステージ1完了"
```

### ステージ完了チェック
各ステージの完了状態をチェックするマクロを定義：
```makefile
define _check_stage_N
    command -v required-tool >/dev/null 2>&1
endef
```

## テスト規則

### テストファイルの構造
`test.mk`は以下の構造に従う：

1. **モックテスト**: 外部依存なしで実行可能
   - ターゲット名: `test-*-mock`
   - 例: `test-bw-mock`

2. **インテグレーションテスト**: 実環境が必要
   - ターゲット名: `test-*-integration`
   - 例: `test-bw-integration`

3. **統合テストターゲット**:
   - `test-unit`: 単体テスト
   - `test`: 全テスト実行

### テストの命名規則
```makefile
test-{機能}-{種類}:
# 例: test-bw-mock, test-bw-integration
```

## 新機能追加時のガイドライン

### 1. 機能の分類フロー
```
新機能の追加
    ↓
├─ システム設定 → system.mk または fonts.mk
├─ アプリインストール → install.mk
├─ 設定ファイル → setup.mk
├─ GNOME関連 → gnome.mk または extensions.mk
├─ AI/開発ツール → 既存ファイルまたは新規.mk
├─ インフラ/運用 → 既存ファイルまたは新規.mk
└─ その他 → 適切なカテゴリの新規.mkファイル
```

### 2. 新規ファイル追加時のチェックリスト
- [ ] 命名規則に従った名前か
- [ ] ファイル冒頭にコメントで責任範囲を記述
- [ ] Makefileのinclude順序に追加（適切なセクション）
- [ ] `variables.mk`のPHONYリストに追加
- [ ] `help.mk`にヘルプメッセージ追加（必要に応じて）
- [ ] 統合ターゲット（`setup-all`等）への組み込み検討

### 3. ヘルプメッセージの更新
新しいターゲットを追加したら`help.mk`も同時に更新：
```makefile
target-name: ## この説明がmake helpで表示される
```

## 保守性向上のポイント

### 1. 単一責任の原則
- 各ファイルは単一の機能領域に責任を持つ
- 1ファイルが200行を超えたら分割を検討

### 2. 依存関係の明確化
- ターゲット間の依存関係を明確にする
- 前提条件の確認処理を含める

### 3. テスタビリティ
- デバッグ用ターゲットで各機能の状態確認を可能にする
- `check-*`ターゲットで現在の状態を確認可能に

### 4. ドキュメント化
- READMEファイルに分割構造の説明を記載
- 各ファイルの役割と使用方法を明記

## 注意事項

### 1. Ubuntu特有の設定
- Ubuntu 24.04/25.04対応のパッケージ名使用
- PPAの可用性確認
- 権限が必要な処理はsudo使用

### 2. 日本語環境対応
- ロケール設定、日本語フォント、日本語入力（Mozc）

### 3. 開発環境の一貫性
- 複数のエディタ（VS Code、Cursor）対応
- シンボリックリンクによる設定の同期

これらのルールに従って、保守しやすく拡張可能なMakefile構造を維持してください。
