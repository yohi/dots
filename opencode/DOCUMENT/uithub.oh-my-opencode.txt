├── bunfig.toml
├── src/ (47600 tokens)
    ├── hooks/ (14600 tokens)
    │   ├── atlas/ (1300 tokens)
    │   │   ├── hook-name.ts
    │   │   ├── index.ts
    │   │   ├── subagent-session-id.ts
    │   │   ├── write-edit-tool-policy.ts
    │   │   ├── sisyphus-path.ts
    │   │   ├── types.ts (200 tokens)
    │   │   ├── is-abort-error.ts (200 tokens)
    │   │   ├── session-last-agent.ts (200 tokens)
    │   │   └── atlas-hook.ts (300 tokens)
    │   ├── no-sisyphus-gpt/ (100 tokens)
    │   │   └── index.ts
    │   ├── task-reminder/ (100 tokens)
    │   │   └── index.ts
    │   ├── anthropic-effort/ (100 tokens)
    │   │   └── index.ts
    │   ├── comment-checker/ (300 tokens)
    │   │   ├── index.ts
    │   │   └── types.ts (200 tokens)
    │   ├── task-resume-info/ (100 tokens)
    │   │   └── index.ts
    │   ├── agent-usage-reminder/ (200 tokens)
    │   │   ├── index.ts
    │   │   └── types.ts
    │   ├── category-skill-reminder/ (100 tokens)
    │   │   └── index.ts
    │   ├── hashline-read-enhancer/ (100 tokens)
    │   │   └── index.ts
    │   ├── start-work/ (100 tokens)
    │   │   └── index.ts
    │   ├── compaction-context-injector/ (100 tokens)
    │   │   └── index.ts
    │   ├── directory-agents-injector/ (300 tokens)
    │   │   ├── index.ts
    │   │   ├── constants.ts
    │   │   └── storage.ts
    │   ├── directory-readme-injector/ (500 tokens)
    │   │   ├── index.ts
    │   │   ├── constants.ts
    │   │   ├── storage.ts
    │   │   └── finder.ts (200 tokens)
    │   ├── keyword-detector/ (600 tokens)
    │   │   ├── analyze/ (100 tokens)
    │   │   │   └── index.ts
    │   │   ├── search/ (100 tokens)
    │   │   │   └── index.ts
    │   │   ├── types.ts
    │   │   ├── index.ts
    │   │   └── constants.ts (200 tokens)
    │   ├── question-label-truncator/ (100 tokens)
    │   │   └── index.ts
    │   ├── thinking-block-validator/ (100 tokens)
    │   │   └── index.ts
    │   ├── ultrawork-model-override/ (100 tokens)
    │   │   └── index.ts
    │   ├── write-existing-file-guard/ (100 tokens)
    │   │   └── index.ts
    │   ├── claude-code-hooks/ (300 tokens)
    │   │   ├── index.ts
    │   │   ├── plugin-config.ts
    │   │   └── session-hook-state.ts
    │   ├── non-interactive-env/ (300 tokens)
    │   │   ├── types.ts
    │   │   ├── index.ts
    │   │   └── detector.ts
    │   ├── ralph-loop/ (1200 tokens)
    │   │   ├── message-storage-directory.ts
    │   │   ├── index.ts
    │   │   ├── constants.ts
    │   │   ├── types.ts (200 tokens)
    │   │   ├── with-timeout.ts (200 tokens)
    │   │   ├── loop-session-recovery.ts (200 tokens)
    │   │   └── continuation-prompt-builder.ts (300 tokens)
    │   ├── session-recovery/ (600 tokens)
    │   │   ├── storage/ (400 tokens)
    │   │   │   ├── message-dir.ts
    │   │   │   ├── part-id.ts
    │   │   │   └── part-content.ts (200 tokens)
    │   │   ├── index.ts
    │   │   └── constants.ts
    │   ├── prometheus-md-only/ (200 tokens)
    │   │   ├── index.ts
    │   │   └── agent-matcher.ts
    │   ├── todo-continuation-enforcer/ (600 tokens)
    │   │   ├── message-directory.ts
    │   │   ├── todo.ts
    │   │   ├── abort-detection.ts (200 tokens)
    │   │   └── constants.ts (200 tokens)
    │   ├── sisyphus-junior-notepad/ (100 tokens)
    │   │   └── index.ts
    │   ├── edit-error-recovery/ (100 tokens)
    │   │   └── index.ts
    │   ├── stop-continuation-guard/ (100 tokens)
    │   │   └── index.ts
    │   ├── compaction-todo-preserver/ (100 tokens)
    │   │   └── index.ts
    │   ├── background-notification/ (400 tokens)
    │   │   ├── index.ts
    │   │   ├── types.ts
    │   │   └── hook.ts (200 tokens)
    │   ├── rules-injector/ (800 tokens)
    │   │   ├── index.ts
    │   │   ├── finder.ts
    │   │   ├── output-path.ts (200 tokens)
    │   │   ├── constants.ts (200 tokens)
    │   │   └── cache.ts (200 tokens)
    │   ├── tasks-todowrite-disabler/ (300 tokens)
    │   │   ├── index.ts
    │   │   └── hook.ts (200 tokens)
    │   ├── json-error-recovery/ (100 tokens)
    │   │   └── index.ts
    │   ├── think-mode/ (200 tokens)
    │   │   ├── index.ts
    │   │   └── types.ts
    │   ├── anthropic-context-window-limit-recovery/ (900 tokens)
    │   │   ├── recovery-strategy.ts
    │   │   ├── storage-paths.ts
    │   │   ├── index.ts
    │   │   ├── storage.ts (200 tokens)
    │   │   ├── client.ts (200 tokens)
    │   │   └── tool-part-types.ts (200 tokens)
    │   ├── interactive-bash-session/ (300 tokens)
    │   │   ├── index.ts
    │   │   ├── types.ts
    │   │   └── constants.ts
    │   ├── auto-slash-command/ (400 tokens)
    │   │   ├── index.ts
    │   │   ├── constants.ts
    │   │   └── types.ts (200 tokens)
    │   ├── auto-update-checker/ (2400 tokens)
    │   │   ├── checker/ (700 tokens)
    │   │   │   ├── jsonc-strip.ts
    │   │   │   ├── local-dev-version.ts (200 tokens)
    │   │   │   ├── latest-version.ts (200 tokens)
    │   │   │   └── package-json-locator.ts (200 tokens)
    │   │   ├── index.ts
    │   │   ├── checker.ts (200 tokens)
    │   │   ├── types.ts (200 tokens)
    │   │   ├── hook/ (800 tokens)
    │   │   │   ├── model-cache-warning.ts (200 tokens)
    │   │   │   ├── spinner-toast.ts (200 tokens)
    │   │   │   ├── config-errors-toast.ts (200 tokens)
    │   │   │   └── startup-toasts.ts (200 tokens)
    │   │   ├── checker.test.ts (200 tokens)
    │   │   └── version-channel.ts (200 tokens)
    │   ├── delegate-task-retry/ (300 tokens)
    │   │   ├── index.ts
    │   │   └── hook.ts (200 tokens)
    │   ├── unstable-agent-babysitter/ (100 tokens)
    │   │   └── index.ts
    │   ├── session-todo-status.ts (200 tokens)
    │   └── empty-task-response-detector.ts (200 tokens)
    ├── tools/ (7600 tokens)
    │   ├── glob/ (400 tokens)
    │   │   ├── index.ts
    │   │   ├── constants.ts
    │   │   ├── types.ts
    │   │   └── result-formatter.ts (200 tokens)
    │   ├── grep/ (200 tokens)
    │   │   ├── index.ts
    │   │   └── types.ts (200 tokens)
    │   ├── call-omo-agent/ (900 tokens)
    │   │   ├── message-storage-directory.ts
    │   │   ├── message-dir.ts
    │   │   ├── index.ts
    │   │   ├── tool-context-with-metadata.ts
    │   │   ├── constants.ts
    │   │   ├── types.ts (200 tokens)
    │   │   └── subagent-session-prompter.ts (200 tokens)
    │   ├── background-task/ (1400 tokens)
    │   │   ├── message-dir.ts
    │   │   ├── delay.ts
    │   │   ├── truncate-text.ts
    │   │   ├── index.ts
    │   │   ├── tools.ts
    │   │   ├── constants.ts (200 tokens)
    │   │   ├── session-messages.ts (200 tokens)
    │   │   ├── clients.ts (200 tokens)
    │   │   └── time-format.ts (300 tokens)
    │   ├── look-at/ (300 tokens)
    │   │   ├── index.ts
    │   │   ├── types.ts
    │   │   └── constants.ts
    │   ├── skill-mcp/ (300 tokens)
    │   │   ├── index.ts
    │   │   ├── types.ts
    │   │   └── constants.ts
    │   ├── skill/ (200 tokens)
    │   │   ├── index.ts
    │   │   └── constants.ts
    │   ├── slashcommand/ (600 tokens)
    │   │   ├── index.ts
    │   │   ├── tools.ts
    │   │   ├── skill-command-converter.ts (200 tokens)
    │   │   └── types.ts (200 tokens)
    │   ├── session-manager/ (100 tokens)
    │   │   └── index.ts
    │   ├── lsp/ (800 tokens)
    │   │   ├── client.ts
    │   │   ├── language-config.ts
    │   │   ├── config.ts
    │   │   ├── tools.ts
    │   │   ├── constants.ts
    │   │   ├── index.ts
    │   │   └── lsp-manager-temp-directory-cleanup.ts (200 tokens)
    │   ├── delegate-task/ (900 tokens)
    │   │   ├── sisyphus-junior-agent.ts
    │   │   ├── index.ts
    │   │   ├── sync-continuation-deps.ts
    │   │   ├── model-string-parser.ts
    │   │   ├── sync-task-deps.ts
    │   │   ├── time-formatter.ts (200 tokens)
    │   │   └── executor.ts (200 tokens)
    │   ├── interactive-bash/ (300 tokens)
    │   │   ├── index.ts
    │   │   └── constants.ts (200 tokens)
    │   ├── ast-grep/ (500 tokens)
    │   │   ├── index.ts
    │   │   ├── constants.ts
    │   │   └── process-output-timeout.ts (300 tokens)
    │   ├── task/ (100 tokens)
    │   │   └── index.ts
    │   └── hashline-edit/ (600 tokens)
    │   │   ├── types.ts (200 tokens)
    │   │   ├── index.ts (200 tokens)
    │   │   └── hash-computation.ts (200 tokens)
    ├── features/ (8700 tokens)
    │   ├── claude-code-session-state/
    │   │   └── index.ts
    │   ├── background-agent/ (1300 tokens)
    │   │   ├── message-dir.ts
    │   │   ├── opencode-client.ts
    │   │   ├── spawner/ (400 tokens)
    │   │   │   ├── concurrency-key-from-launch-input.ts
    │   │   │   ├── spawner-context.ts
    │   │   │   └── parent-directory-resolver.ts (200 tokens)
    │   │   ├── index.ts
    │   │   ├── result-handler-context.ts
    │   │   ├── result-handler.ts
    │   │   ├── duration-formatter.ts
    │   │   ├── format-duration.ts
    │   │   └── error-classifier.ts (200 tokens)
    │   ├── builtin-commands/ (700 tokens)
    │   │   ├── index.ts
    │   │   ├── types.ts
    │   │   └── templates/ (500 tokens)
    │   │   │   ├── stop-continuation.ts (200 tokens)
    │   │   │   └── stop-continuation.test.ts (300 tokens)
    │   ├── claude-code-agent-loader/ (200 tokens)
    │   │   ├── index.ts
    │   │   └── types.ts
    │   ├── claude-code-command-loader/ (100 tokens)
    │   │   └── index.ts
    │   ├── skill-mcp-manager/ (500 tokens)
    │   │   ├── index.ts
    │   │   ├── connection-type.ts (200 tokens)
    │   │   └── env-cleaner.ts (200 tokens)
    │   ├── run-continuation-state/ (300 tokens)
    │   │   ├── constants.ts
    │   │   ├── index.ts
    │   │   └── types.ts
    │   ├── boulder-state/ (400 tokens)
    │   │   ├── index.ts
    │   │   ├── constants.ts
    │   │   └── types.ts (200 tokens)
    │   ├── claude-tasks/ (300 tokens)
    │   │   ├── index.ts
    │   │   └── types.ts (200 tokens)
    │   ├── hook-message-injector/ (500 tokens)
    │   │   ├── constants.ts
    │   │   ├── index.ts
    │   │   └── types.ts (300 tokens)
    │   ├── mcp-oauth/ (300 tokens)
    │   │   ├── index.ts
    │   │   ├── schema.ts
    │   │   └── resource-indicator.ts
    │   ├── builtin-skills/ (400 tokens)
    │   │   ├── index.ts
    │   │   ├── skills/ (200 tokens)
    │   │   │   ├── index.ts
    │   │   │   └── git-master-skill-metadata.ts
    │   │   └── types.ts
    │   ├── tmux-subagent/ (1000 tokens)
    │   │   ├── session-message-count.ts
    │   │   ├── polling-constants.ts
    │   │   ├── tmux-grid-constants.ts
    │   │   ├── event-handlers.ts
    │   │   ├── index.ts (200 tokens)
    │   │   ├── session-status-parser.ts (200 tokens)
    │   │   └── decision-engine.ts (200 tokens)
    │   ├── task-toast-manager/ (300 tokens)
    │   │   ├── index.ts
    │   │   └── types.ts (200 tokens)
    │   ├── tool-metadata-store/ (100 tokens)
    │   │   └── index.ts
    │   ├── opencode-skill-loader/ (1400 tokens)
    │   │   ├── merger/ (500 tokens)
    │   │   │   ├── scope-priority.ts
    │   │   │   ├── skills-config-normalizer.ts (200 tokens)
    │   │   │   └── builtin-skill-converter.ts (200 tokens)
    │   │   ├── allowed-tools-parser.ts
    │   │   ├── skill-deduplication.ts
    │   │   ├── skill-resolution-options.ts
    │   │   ├── loaded-skill-template-extractor.ts
    │   │   ├── skill-content.ts
    │   │   ├── skill-definition-record.ts (200 tokens)
    │   │   └── index.ts (200 tokens)
    │   ├── claude-code-mcp-loader/ (300 tokens)
    │   │   ├── index.ts
    │   │   └── env-expander.ts (200 tokens)
    │   ├── context-injector/ (100 tokens)
    │   │   └── index.ts
    │   └── claude-code-plugin-loader/ (500 tokens)
    │   │   ├── index.ts
    │   │   ├── plugin-path-resolver.ts (200 tokens)
    │   │   └── hook-loader.ts (200 tokens)
    ├── cli/ (4100 tokens)
    │   ├── index.ts
    │   ├── get-local-version/ (200 tokens)
    │   │   ├── index.ts
    │   │   └── types.ts
    │   ├── run/ (600 tokens)
    │   │   ├── events.ts
    │   │   ├── display-chars.ts
    │   │   ├── index.ts (200 tokens)
    │   │   └── agent-profile-colors.ts (200 tokens)
    │   ├── config-manager/ (1200 tokens)
    │   │   ├── generate-omo-config.ts
    │   │   ├── ensure-config-directory-exists.ts
    │   │   ├── jsonc-provider-editor.ts
    │   │   ├── opencode-config-format.ts (200 tokens)
    │   │   ├── npm-dist-tags.ts (200 tokens)
    │   │   ├── plugin-name-with-version.ts (200 tokens)
    │   │   └── deep-merge-record.ts (300 tokens)
    │   ├── doctor/ (1400 tokens)
    │   │   ├── index.ts
    │   │   ├── formatter.ts (200 tokens)
    │   │   └── checks/ (1100 tokens)
    │   │   │   ├── model-resolution-effective-model.ts (200 tokens)
    │   │   │   ├── model-resolution-types.ts (300 tokens)
    │   │   │   ├── config.test.ts (300 tokens)
    │   │   │   └── tools-lsp.ts (300 tokens)
    │   ├── install.ts
    │   ├── provider-model-id-transform.ts
    │   ├── index.test.ts (200 tokens)
    │   └── model-fallback-types.ts (200 tokens)
    ├── shared/ (6100 tokens)
    │   ├── tmux/ (900 tokens)
    │   │   ├── index.ts
    │   │   ├── types.ts
    │   │   ├── tmux-utils/ (300 tokens)
    │   │   │   ├── environment.ts
    │   │   │   └── pane-dimensions.ts (200 tokens)
    │   │   ├── constants.ts (200 tokens)
    │   │   └── tmux-utils.ts (200 tokens)
    │   ├── record-type-guard.ts
    │   ├── command-executor/ (700 tokens)
    │   │   ├── home-directory.ts
    │   │   ├── embedded-commands.ts (200 tokens)
    │   │   ├── shell-path.ts (200 tokens)
    │   │   └── execute-command.ts (200 tokens)
    │   ├── git-worktree/ (800 tokens)
    │   │   ├── types.ts
    │   │   ├── index.ts
    │   │   ├── parse-status-porcelain.ts (200 tokens)
    │   │   ├── parse-status-porcelain-line.ts (200 tokens)
    │   │   └── parse-diff-numstat.ts (200 tokens)
    │   ├── claude-config-dir.ts
    │   ├── truncate-description.ts
    │   ├── open-code-client-shapes.ts
    │   ├── command-executor.ts
    │   ├── opencode-storage-paths.ts
    │   ├── model-sanitizer.ts
    │   ├── opencode-config-dir-types.ts
    │   ├── migration.ts
    │   ├── config-errors.ts
    │   ├── session-tools-store.ts
    │   ├── hook-disabled.ts
    │   ├── safe-create-hook.ts (200 tokens)
    │   ├── logger.ts (200 tokens)
    │   ├── disabled-tools.ts (200 tokens)
    │   ├── merge-categories.ts (200 tokens)
    │   ├── first-message-variant.ts (200 tokens)
    │   ├── model-resolution-types.ts (200 tokens)
    │   ├── skill-path-resolver.ts (200 tokens)
    │   ├── tool-name.ts (200 tokens)
    │   ├── open-code-client-accessors.ts (200 tokens)
    │   ├── normalize-sdk-response.ts (200 tokens)
    │   ├── first-message-variant.test.ts (200 tokens)
    │   └── frontmatter.ts (300 tokens)
    ├── mcp/ (500 tokens)
    │   ├── grep-app.ts
    │   ├── types.ts
    │   ├── context7.ts
    │   └── index.ts (200 tokens)
    ├── config/ (2700 tokens)
    │   ├── schema/ (2300 tokens)
    │   │   ├── babysitting.ts
    │   │   ├── commands.ts
    │   │   ├── notification.ts
    │   │   ├── comment-checker.ts
    │   │   ├── sisyphus-agent.ts
    │   │   ├── claude-code.ts
    │   │   ├── git-master.ts
    │   │   ├── websearch.ts (200 tokens)
    │   │   ├── ralph-loop.ts (200 tokens)
    │   │   ├── sisyphus.ts (200 tokens)
    │   │   ├── internal/ (200 tokens)
    │   │   │   └── permission.ts (200 tokens)
    │   │   ├── background-task.ts (200 tokens)
    │   │   ├── tmux.ts (200 tokens)
    │   │   ├── browser-automation.ts (200 tokens)
    │   │   └── agent-names.ts (200 tokens)
    │   ├── index.ts (200 tokens)
    │   └── schema.ts (200 tokens)
    ├── plugin-state.ts
    ├── agents/ (900 tokens)
    │   ├── sisyphus-junior/ (100 tokens)
    │   │   └── index.ts
    │   ├── builtin-agents/ (100 tokens)
    │   │   └── environment-context.ts
    │   ├── prometheus/ (200 tokens)
    │   │   └── index.ts (200 tokens)
    │   ├── atlas/ (200 tokens)
    │   │   └── index.ts (200 tokens)
    │   └── env-context.ts (300 tokens)
    ├── plugin-handlers/ (800 tokens)
    │   ├── category-config-resolver.ts
    │   ├── index.ts
    │   ├── agent-key-remapper.ts (200 tokens)
    │   ├── plan-model-inheritance.ts (200 tokens)
    │   └── agent-priority-order.ts (200 tokens)
    ├── plugin/ (1300 tokens)
    │   ├── types.ts (200 tokens)
    │   ├── recent-synthetic-idles.ts (200 tokens)
    │   ├── session-status-normalizer.ts (200 tokens)
    │   ├── messages-transform.ts (200 tokens)
    │   ├── available-categories.ts (200 tokens)
    │   └── session-agent-resolver.ts (300 tokens)
    └── index.compaction-model-agnostic.static.test.ts (200 tokens)
├── .github/ (1200 tokens)
    ├── assets/ (500 tokens)
    │   ├── omo.png
    │   ├── hephaestus.png
    │   ├── sisyphus.png
    │   ├── sisyphuslabs.png
    │   └── orchestrator-atlas.png
    ├── ISSUE_TEMPLATE/ (100 tokens)
    │   └── config.yml
    ├── workflows/ (200 tokens)
    │   └── lint-workflows.yml (200 tokens)
    ├── pull_request_template.md (200 tokens)
    └── FUNDING.yml (200 tokens)
├── test-setup.ts
├── script/ (500 tokens)
    ├── build-schema.ts
    ├── build-schema.test.ts (200 tokens)
    └── build-schema-document.ts (200 tokens)
├── packages/ (1900 tokens)
    ├── darwin-x64/ (100 tokens)
    │   └── package.json
    ├── darwin-arm64/ (100 tokens)
    │   └── package.json
    ├── windows-x64/ (100 tokens)
    │   └── package.json
    ├── darwin-x64-baseline/ (200 tokens)
    │   └── package.json (200 tokens)
    ├── linux-x64/ (200 tokens)
    │   └── package.json (200 tokens)
    ├── windows-x64-baseline/ (200 tokens)
    │   └── package.json (200 tokens)
    ├── linux-arm64/ (200 tokens)
    │   └── package.json (200 tokens)
    ├── linux-x64-musl/ (200 tokens)
    │   └── package.json (200 tokens)
    ├── linux-arm64-musl/ (200 tokens)
    │   └── package.json (200 tokens)
    ├── linux-x64-baseline/ (200 tokens)
    │   └── package.json (200 tokens)
    └── linux-x64-musl-baseline/ (200 tokens)
    │   └── package.json (200 tokens)
├── tsconfig.json (200 tokens)
├── .gitignore (200 tokens)
└── .opencode/ (200 tokens)
    └── background-tasks.json (200 tokens)


/bunfig.toml:
--------------------------------------------------------------------------------
1 | [test]
2 | preload = ["./test-setup.ts"]
3 | 


--------------------------------------------------------------------------------
/src/hooks/atlas/hook-name.ts:
--------------------------------------------------------------------------------
1 | export const HOOK_NAME = "atlas"
2 | 


--------------------------------------------------------------------------------
/src/tools/glob/index.ts:
--------------------------------------------------------------------------------
1 | export { createGlobTools } from "./tools"
2 | 


--------------------------------------------------------------------------------
/src/tools/grep/index.ts:
--------------------------------------------------------------------------------
1 | export { createGrepTools } from "./tools"
2 | 


--------------------------------------------------------------------------------
/src/features/claude-code-session-state/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./state"
2 | 


--------------------------------------------------------------------------------
/src/hooks/no-sisyphus-gpt/index.ts:
--------------------------------------------------------------------------------
1 | export { createNoSisyphusGptHook } from "./hook"
2 | 


--------------------------------------------------------------------------------
/src/hooks/task-reminder/index.ts:
--------------------------------------------------------------------------------
1 | export { createTaskReminderHook } from "./hook";
2 | 


--------------------------------------------------------------------------------
/src/features/background-agent/message-dir.ts:
--------------------------------------------------------------------------------
1 | export { getMessageDir } from "../../shared"
2 | 


--------------------------------------------------------------------------------
/src/hooks/anthropic-effort/index.ts:
--------------------------------------------------------------------------------
1 | export { createAnthropicEffortHook } from "./hook";
2 | 


--------------------------------------------------------------------------------
/src/hooks/comment-checker/index.ts:
--------------------------------------------------------------------------------
1 | export { createCommentCheckerHooks } from "./hook"
2 | 


--------------------------------------------------------------------------------
/src/hooks/task-resume-info/index.ts:
--------------------------------------------------------------------------------
1 | export { createTaskResumeInfoHook } from "./hook";
2 | 


--------------------------------------------------------------------------------
/src/features/builtin-commands/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./types"
2 | export * from "./commands"
3 | 


--------------------------------------------------------------------------------
/src/hooks/agent-usage-reminder/index.ts:
--------------------------------------------------------------------------------
1 | export { createAgentUsageReminderHook } from "./hook";
2 | 


--------------------------------------------------------------------------------
/src/cli/index.ts:
--------------------------------------------------------------------------------
1 | #!/usr/bin/env bun
2 | import { runCli } from "./cli-program"
3 | 
4 | runCli()
5 | 


--------------------------------------------------------------------------------
/src/features/claude-code-agent-loader/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./types"
2 | export * from "./loader"
3 | 


--------------------------------------------------------------------------------
/src/hooks/category-skill-reminder/index.ts:
--------------------------------------------------------------------------------
1 | export { createCategorySkillReminderHook } from "./hook"
2 | 


--------------------------------------------------------------------------------
/src/hooks/hashline-read-enhancer/index.ts:
--------------------------------------------------------------------------------
1 | export { createHashlineReadEnhancerHook } from "./hook"
2 | 


--------------------------------------------------------------------------------
/src/hooks/start-work/index.ts:
--------------------------------------------------------------------------------
1 | export { HOOK_NAME, createStartWorkHook } from "./start-work-hook"
2 | 


--------------------------------------------------------------------------------
/src/tools/call-omo-agent/message-storage-directory.ts:
--------------------------------------------------------------------------------
1 | export { getMessageDir } from "../../shared"
2 | 


--------------------------------------------------------------------------------
/src/features/claude-code-command-loader/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./types"
2 | export * from "./loader"
3 | 


--------------------------------------------------------------------------------
/src/hooks/compaction-context-injector/index.ts:
--------------------------------------------------------------------------------
1 | export { createCompactionContextInjector } from "./hook"
2 | 


--------------------------------------------------------------------------------
/src/hooks/directory-agents-injector/index.ts:
--------------------------------------------------------------------------------
1 | export { createDirectoryAgentsInjectorHook } from "./hook";
2 | 


--------------------------------------------------------------------------------
/src/hooks/directory-readme-injector/index.ts:
--------------------------------------------------------------------------------
1 | export { createDirectoryReadmeInjectorHook } from "./hook";
2 | 


--------------------------------------------------------------------------------
/src/hooks/keyword-detector/analyze/index.ts:
--------------------------------------------------------------------------------
1 | export { ANALYZE_PATTERN, ANALYZE_MESSAGE } from "./default"
2 | 


--------------------------------------------------------------------------------
/src/hooks/keyword-detector/search/index.ts:
--------------------------------------------------------------------------------
1 | export { SEARCH_PATTERN, SEARCH_MESSAGE } from "./default"
2 | 


--------------------------------------------------------------------------------
/src/hooks/question-label-truncator/index.ts:
--------------------------------------------------------------------------------
1 | export { createQuestionLabelTruncatorHook } from "./hook";
2 | 


--------------------------------------------------------------------------------
/src/hooks/thinking-block-validator/index.ts:
--------------------------------------------------------------------------------
1 | export { createThinkingBlockValidatorHook } from "./hook"
2 | 


--------------------------------------------------------------------------------
/src/hooks/ultrawork-model-override/index.ts:
--------------------------------------------------------------------------------
1 | export { createUltraworkModelOverrideHook } from "./hook"
2 | 


--------------------------------------------------------------------------------
/src/hooks/write-existing-file-guard/index.ts:
--------------------------------------------------------------------------------
1 | export { createWriteExistingFileGuardHook } from "./hook"
2 | 


--------------------------------------------------------------------------------
/.github/assets/omo.png:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/code-yeongyu/oh-my-opencode/v3.7.4/.github/assets/omo.png


--------------------------------------------------------------------------------
/src/hooks/claude-code-hooks/index.ts:
--------------------------------------------------------------------------------
1 | export { createClaudeCodeHooksHook } from "./claude-code-hooks-hook"
2 | 


--------------------------------------------------------------------------------
/src/tools/background-task/message-dir.ts:
--------------------------------------------------------------------------------
1 | export { getMessageDir } from "../../shared/opencode-message-dir"
2 | 


--------------------------------------------------------------------------------
/src/tools/call-omo-agent/message-dir.ts:
--------------------------------------------------------------------------------
1 | export { getMessageDir } from "../../shared/opencode-message-dir"
2 | 


--------------------------------------------------------------------------------
/src/features/skill-mcp-manager/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./types"
2 | export { SkillMcpManager } from "./manager"
3 | 


--------------------------------------------------------------------------------
/src/hooks/non-interactive-env/types.ts:
--------------------------------------------------------------------------------
1 | export interface NonInteractiveEnvConfig {
2 |   disabled?: boolean
3 | }
4 | 


--------------------------------------------------------------------------------
/src/shared/tmux/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./types"
2 | export * from "./constants"
3 | export * from "./tmux-utils"
4 | 


--------------------------------------------------------------------------------
/.github/assets/hephaestus.png:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/code-yeongyu/oh-my-opencode/v3.7.4/.github/assets/hephaestus.png


--------------------------------------------------------------------------------
/.github/assets/sisyphus.png:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/code-yeongyu/oh-my-opencode/v3.7.4/.github/assets/sisyphus.png


--------------------------------------------------------------------------------
/src/cli/get-local-version/index.ts:
--------------------------------------------------------------------------------
1 | export { getLocalVersion } from "./get-local-version"
2 | export * from "./types"
3 | 


--------------------------------------------------------------------------------
/src/features/run-continuation-state/constants.ts:
--------------------------------------------------------------------------------
1 | export const CONTINUATION_MARKER_DIR = ".sisyphus/run-continuation"
2 | 


--------------------------------------------------------------------------------
/src/hooks/ralph-loop/message-storage-directory.ts:
--------------------------------------------------------------------------------
1 | export { getMessageDir } from "../../shared/opencode-message-dir"
2 | 


--------------------------------------------------------------------------------
/src/hooks/session-recovery/storage/message-dir.ts:
--------------------------------------------------------------------------------
1 | export { getMessageDir } from "../../../shared/opencode-message-dir"
2 | 


--------------------------------------------------------------------------------
/.github/assets/sisyphuslabs.png:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/code-yeongyu/oh-my-opencode/v3.7.4/.github/assets/sisyphuslabs.png


--------------------------------------------------------------------------------
/src/features/boulder-state/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./types"
2 | export * from "./constants"
3 | export * from "./storage"
4 | 


--------------------------------------------------------------------------------
/src/hooks/prometheus-md-only/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./constants"
2 | export { createPrometheusMdOnlyHook } from "./hook"
3 | 


--------------------------------------------------------------------------------
/src/hooks/todo-continuation-enforcer/message-directory.ts:
--------------------------------------------------------------------------------
1 | export { getMessageDir } from "../../shared/opencode-message-dir"
2 | 


--------------------------------------------------------------------------------
/src/features/claude-tasks/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./types"
2 | export * from "./storage"
3 | export * from "./session-storage"
4 | 


--------------------------------------------------------------------------------
/src/features/hook-message-injector/constants.ts:
--------------------------------------------------------------------------------
1 | export { OPENCODE_STORAGE, MESSAGE_STORAGE, PART_STORAGE } from "../../shared"
2 | 


--------------------------------------------------------------------------------
/src/hooks/keyword-detector/types.ts:
--------------------------------------------------------------------------------
1 | export interface KeywordDetectorState {
2 |   detected: boolean
3 |   injected: boolean
4 | }
5 | 


--------------------------------------------------------------------------------
/src/shared/tmux/types.ts:
--------------------------------------------------------------------------------
1 | export interface SpawnPaneResult {
2 |   success: boolean
3 |   paneId?: string  // e.g., "%42"
4 | }
5 | 


--------------------------------------------------------------------------------
/src/tools/look-at/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./types"
2 | export * from "./constants"
3 | export { createLookAt } from "./tools"
4 | 


--------------------------------------------------------------------------------
/src/features/mcp-oauth/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./schema"
2 | export * from "./oauth-authorization-flow"
3 | export * from "./provider"
4 | 


--------------------------------------------------------------------------------
/src/features/run-continuation-state/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./types"
2 | export * from "./constants"
3 | export * from "./storage"
4 | 


--------------------------------------------------------------------------------
/src/tools/skill-mcp/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./constants"
2 | export * from "./types"
3 | export { createSkillMcpTool } from "./tools"
4 | 


--------------------------------------------------------------------------------
/src/tools/skill/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./constants"
2 | export * from "./types"
3 | export { skill, createSkillTool } from "./tools"
4 | 


--------------------------------------------------------------------------------
/.github/assets/orchestrator-atlas.png:
--------------------------------------------------------------------------------
https://raw.githubusercontent.com/code-yeongyu/oh-my-opencode/v3.7.4/.github/assets/orchestrator-atlas.png


--------------------------------------------------------------------------------
/src/hooks/sisyphus-junior-notepad/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./constants"
2 | 
3 | export { createSisyphusJuniorNotepadHook } from "./hook"
4 | 


--------------------------------------------------------------------------------
/src/tools/call-omo-agent/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./types"
2 | export * from "./constants"
3 | export { createCallOmoAgent } from "./tools"
4 | 


--------------------------------------------------------------------------------
/src/features/builtin-skills/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./types"
2 | export { createBuiltinSkills, type CreateBuiltinSkillsOptions } from "./skills"
3 | 


--------------------------------------------------------------------------------
/src/tools/slashcommand/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./types"
2 | export { slashcommand, createSlashcommandTool, discoverCommandsSync } from "./tools"
3 | 


--------------------------------------------------------------------------------
/src/tools/session-manager/index.ts:
--------------------------------------------------------------------------------
1 | export { createSessionManagerTools } from "./tools"
2 | export * from "./types"
3 | export * from "./constants"
4 | 


--------------------------------------------------------------------------------
/src/tools/background-task/delay.ts:
--------------------------------------------------------------------------------
1 | export function delay(ms: number): Promise<void> {
2 |   return new Promise((resolve) => setTimeout(resolve, ms))
3 | }
4 | 


--------------------------------------------------------------------------------
/src/hooks/edit-error-recovery/index.ts:
--------------------------------------------------------------------------------
1 | export {
2 |   createEditErrorRecoveryHook,
3 |   EDIT_ERROR_PATTERNS,
4 |   EDIT_ERROR_REMINDER,
5 | } from "./hook";
6 | 


--------------------------------------------------------------------------------
/src/hooks/stop-continuation-guard/index.ts:
--------------------------------------------------------------------------------
1 | export { createStopContinuationGuardHook } from "./hook"
2 | export type { StopContinuationGuard } from "./hook"
3 | 


--------------------------------------------------------------------------------
/src/tools/lsp/client.ts:
--------------------------------------------------------------------------------
1 | export { validateCwd } from "./lsp-process"
2 | export { lspManager } from "./lsp-server"
3 | export { LSPClient } from "./lsp-client"
4 | 


--------------------------------------------------------------------------------
/src/features/background-agent/opencode-client.ts:
--------------------------------------------------------------------------------
1 | import type { PluginInput } from "@opencode-ai/plugin"
2 | 
3 | export type OpencodeClient = PluginInput["client"]
4 | 


--------------------------------------------------------------------------------
/src/hooks/compaction-todo-preserver/index.ts:
--------------------------------------------------------------------------------
1 | export type { CompactionTodoPreserver } from "./hook"
2 | export { createCompactionTodoPreserverHook } from "./hook"
3 | 


--------------------------------------------------------------------------------
/src/features/tmux-subagent/session-message-count.ts:
--------------------------------------------------------------------------------
1 | export function getMessageCount(data: unknown): number {
2 |   return Array.isArray(data) ? data.length : 0
3 | }
4 | 


--------------------------------------------------------------------------------
/src/hooks/atlas/index.ts:
--------------------------------------------------------------------------------
1 | export { HOOK_NAME } from "./hook-name"
2 | export { createAtlasHook } from "./atlas-hook"
3 | export type { AtlasHookOptions } from "./types"
4 | 


--------------------------------------------------------------------------------
/src/hooks/background-notification/index.ts:
--------------------------------------------------------------------------------
1 | export { createBackgroundNotificationHook } from "./hook"
2 | export type { BackgroundNotificationHookConfig } from "./types"
3 | 


--------------------------------------------------------------------------------
/src/hooks/rules-injector/index.ts:
--------------------------------------------------------------------------------
1 | export { createRulesInjectorHook } from "./hook";
2 | export { calculateDistance, findProjectRoot, findRuleFiles } from "./finder";
3 | 


--------------------------------------------------------------------------------
/src/hooks/tasks-todowrite-disabler/index.ts:
--------------------------------------------------------------------------------
1 | export { createTasksTodowriteDisablerHook } from "./hook";
2 | export type { TasksTodowriteDisablerConfig } from "./hook";
3 | 


--------------------------------------------------------------------------------
/src/mcp/grep-app.ts:
--------------------------------------------------------------------------------
1 | export const grep_app = {
2 |   type: "remote" as const,
3 |   url: "https://mcp.grep.app",
4 |   enabled: true,
5 |   oauth: false as const,
6 | }
7 | 


--------------------------------------------------------------------------------
/src/tools/slashcommand/tools.ts:
--------------------------------------------------------------------------------
1 | export { discoverCommandsSync } from "./command-discovery"
2 | export { createSlashcommandTool, slashcommand } from "./slashcommand-tool"
3 | 


--------------------------------------------------------------------------------
/src/shared/record-type-guard.ts:
--------------------------------------------------------------------------------
1 | export function isRecord(value: unknown): value is Record<string, unknown> {
2 | 	return typeof value === "object" && value !== null
3 | }
4 | 


--------------------------------------------------------------------------------
/src/hooks/keyword-detector/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./detector"
2 | export * from "./constants"
3 | export * from "./types"
4 | 
5 | export { createKeywordDetectorHook } from "./hook"
6 | 


--------------------------------------------------------------------------------
/src/hooks/agent-usage-reminder/types.ts:
--------------------------------------------------------------------------------
1 | export interface AgentUsageState {
2 |   sessionID: string;
3 |   agentUsed: boolean;
4 |   reminderCount: number;
5 |   updatedAt: number;
6 | }
7 | 


--------------------------------------------------------------------------------
/src/tools/look-at/types.ts:
--------------------------------------------------------------------------------
1 | export interface LookAtArgs {
2 |   file_path?: string
3 |   image_data?: string  // base64 encoded image data (for clipboard images)
4 |   goal: string
5 | }
6 | 


--------------------------------------------------------------------------------
/src/tools/lsp/language-config.ts:
--------------------------------------------------------------------------------
1 | import { EXT_TO_LANG } from "./constants"
2 | 
3 | export function getLanguageId(ext: string): string {
4 |   return EXT_TO_LANG[ext] || "plaintext"
5 | }
6 | 


--------------------------------------------------------------------------------
/src/hooks/json-error-recovery/index.ts:
--------------------------------------------------------------------------------
1 | export {
2 |   createJsonErrorRecoveryHook,
3 |   JSON_ERROR_TOOL_EXCLUDE_LIST,
4 |   JSON_ERROR_PATTERNS,
5 |   JSON_ERROR_REMINDER,
6 | } from "./hook"
7 | 


--------------------------------------------------------------------------------
/src/hooks/think-mode/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./detector"
2 | export * from "./switcher"
3 | export * from "./types"
4 | 
5 | export { clearThinkModeState, createThinkModeHook } from "./hook"
6 | 


--------------------------------------------------------------------------------
/test-setup.ts:
--------------------------------------------------------------------------------
1 | import { beforeEach } from "bun:test"
2 | import { _resetForTesting } from "./src/features/claude-code-session-state/state"
3 | 
4 | beforeEach(() => {
5 |   _resetForTesting()
6 | })
7 | 


--------------------------------------------------------------------------------
/src/hooks/rules-injector/finder.ts:
--------------------------------------------------------------------------------
1 | export { findProjectRoot } from "./project-root-finder";
2 | export { calculateDistance } from "./rule-distance";
3 | export { findRuleFiles } from "./rule-file-finder";
4 | 


--------------------------------------------------------------------------------
/src/tools/delegate-task/sisyphus-junior-agent.ts:
--------------------------------------------------------------------------------
1 | import { getAgentDisplayName } from "../../shared/agent-display-names"
2 | 
3 | export const SISYPHUS_JUNIOR_AGENT = getAgentDisplayName("sisyphus-junior")
4 | 


--------------------------------------------------------------------------------
/src/tools/interactive-bash/index.ts:
--------------------------------------------------------------------------------
1 | import { interactive_bash } from "./tools"
2 | import { startBackgroundCheck } from "./tmux-path-resolver"
3 | 
4 | export { interactive_bash, startBackgroundCheck }
5 | 


--------------------------------------------------------------------------------
/src/hooks/non-interactive-env/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./constants"
2 | export * from "./detector"
3 | export * from "./types"
4 | 
5 | export { createNonInteractiveEnvHook } from "./non-interactive-env-hook"
6 | 


--------------------------------------------------------------------------------
/src/shared/command-executor/home-directory.ts:
--------------------------------------------------------------------------------
1 | import { homedir } from "node:os"
2 | 
3 | export function getHomeDirectory(): string {
4 | 	return process.env.HOME || process.env.USERPROFILE || homedir()
5 | }
6 | 


--------------------------------------------------------------------------------
/src/tools/background-task/truncate-text.ts:
--------------------------------------------------------------------------------
1 | export function truncateText(text: string, maxLength: number): string {
2 |   if (text.length <= maxLength) return text
3 |   return text.slice(0, maxLength) + "..."
4 | }
5 | 


--------------------------------------------------------------------------------
/src/features/task-toast-manager/index.ts:
--------------------------------------------------------------------------------
1 | export { TaskToastManager, getTaskToastManager, initTaskToastManager } from "./manager"
2 | export type { TrackedTask, TaskStatus, TaskToastOptions, ModelFallbackInfo } from "./types"
3 | 


--------------------------------------------------------------------------------
/src/hooks/atlas/subagent-session-id.ts:
--------------------------------------------------------------------------------
1 | export function extractSessionIdFromOutput(output: string): string {
2 |   const match = output.match(/Session ID:\s*(ses_[a-zA-Z0-9]+)/)
3 |   return match?.[1] ?? "<session_id>"
4 | }
5 | 


--------------------------------------------------------------------------------
/src/tools/background-task/index.ts:
--------------------------------------------------------------------------------
1 | export {
2 |   createBackgroundTask,
3 |   createBackgroundOutput,
4 |   createBackgroundCancel,
5 | } from "./tools"
6 | 
7 | export type * from "./types"
8 | export * from "./constants"
9 | 


--------------------------------------------------------------------------------
/src/hooks/anthropic-context-window-limit-recovery/recovery-strategy.ts:
--------------------------------------------------------------------------------
1 | export { runAggressiveTruncationStrategy } from "./aggressive-truncation-strategy"
2 | export { runSummarizeRetryStrategy } from "./summarize-retry-strategy"
3 | 


--------------------------------------------------------------------------------
/src/shared/git-worktree/types.ts:
--------------------------------------------------------------------------------
1 | export type GitFileStatus = "modified" | "added" | "deleted"
2 | 
3 | export interface GitFileStat {
4 |   path: string
5 |   added: number
6 |   removed: number
7 |   status: GitFileStatus
8 | }
9 | 


--------------------------------------------------------------------------------
/src/features/tool-metadata-store/index.ts:
--------------------------------------------------------------------------------
1 | export {
2 |   clearPendingStore,
3 |   consumeToolMetadata,
4 |   getPendingStoreSize,
5 |   storeToolMetadata,
6 | } from "./store"
7 | export type { PendingToolMetadata } from "./store"
8 | 


--------------------------------------------------------------------------------
/src/hooks/atlas/write-edit-tool-policy.ts:
--------------------------------------------------------------------------------
1 | const WRITE_EDIT_TOOLS = ["Write", "Edit", "write", "edit"]
2 | 
3 | export function isWriteOrEditToolName(toolName: string): boolean {
4 |   return WRITE_EDIT_TOOLS.includes(toolName)
5 | }
6 | 


--------------------------------------------------------------------------------
/src/tools/lsp/config.ts:
--------------------------------------------------------------------------------
1 | export { findServerForExtension, getAllServers, getConfigPaths_ } from "./server-resolution"
2 | export { getLanguageId } from "./language-config"
3 | export { isServerInstalled } from "./server-installation"
4 | 


--------------------------------------------------------------------------------
/src/cli/run/events.ts:
--------------------------------------------------------------------------------
1 | export type { EventState } from "./event-state"
2 | export { createEventState } from "./event-state"
3 | export { serializeError } from "./event-formatting"
4 | export { processEvents } from "./event-stream-processor"
5 | 


--------------------------------------------------------------------------------
/src/hooks/background-notification/types.ts:
--------------------------------------------------------------------------------
1 | import type { BackgroundTask } from "../../features/background-agent"
2 | 
3 | export interface BackgroundNotificationHookConfig {
4 |   formatNotification?: (tasks: BackgroundTask[]) => string
5 | }
6 | 


--------------------------------------------------------------------------------
/src/tools/skill-mcp/types.ts:
--------------------------------------------------------------------------------
1 | export interface SkillMcpArgs {
2 |   mcp_name: string
3 |   tool_name?: string
4 |   resource_name?: string
5 |   prompt_name?: string
6 |   arguments?: string | Record<string, unknown>
7 |   grep?: string
8 | }
9 | 


--------------------------------------------------------------------------------
/src/config/schema/babysitting.ts:
--------------------------------------------------------------------------------
1 | import { z } from "zod"
2 | 
3 | export const BabysittingConfigSchema = z.object({
4 |   timeout_ms: z.number().default(120000),
5 | })
6 | 
7 | export type BabysittingConfig = z.infer<typeof BabysittingConfigSchema>
8 | 


--------------------------------------------------------------------------------
/src/hooks/session-recovery/storage/part-id.ts:
--------------------------------------------------------------------------------
1 | export function generatePartId(): string {
2 |   const timestamp = Date.now().toString(16)
3 |   const random = Math.random().toString(36).substring(2, 10)
4 |   return `prt_${timestamp}${random}`
5 | }
6 | 


--------------------------------------------------------------------------------
/src/cli/run/display-chars.ts:
--------------------------------------------------------------------------------
1 | const isCI = Boolean(process.env.CI || process.env.GITHUB_ACTIONS)
2 | 
3 | export const displayChars = {
4 |   treeEnd: isCI ? "`-" : "└─",
5 |   treeIndent: "   ",
6 |   treeJoin: isCI ? "   " : "      ",
7 | } as const
8 | 


--------------------------------------------------------------------------------
/src/hooks/interactive-bash-session/index.ts:
--------------------------------------------------------------------------------
1 | export { createInteractiveBashSessionHook } from "./hook"
2 | export { createInteractiveBashSessionTracker } from "./interactive-bash-session-tracker"
3 | export { parseTmuxCommand } from "./tmux-command-parser"
4 | 


--------------------------------------------------------------------------------
/src/hooks/prometheus-md-only/agent-matcher.ts:
--------------------------------------------------------------------------------
1 | import { PROMETHEUS_AGENT } from "./constants"
2 | 
3 | export function isPrometheusAgent(agentName: string | undefined): boolean {
4 |   return agentName?.toLowerCase().includes(PROMETHEUS_AGENT) ?? false
5 | }
6 | 


--------------------------------------------------------------------------------
/src/hooks/todo-continuation-enforcer/todo.ts:
--------------------------------------------------------------------------------
1 | import type { Todo } from "./types"
2 | 
3 | export function getIncompleteCount(todos: Todo[]): number {
4 |   return todos.filter((todo) => todo.status !== "completed" && todo.status !== "cancelled").length
5 | }
6 | 


--------------------------------------------------------------------------------
/src/features/mcp-oauth/schema.ts:
--------------------------------------------------------------------------------
1 | import { z } from "zod"
2 | 
3 | export const McpOauthSchema = z.object({
4 |   clientId: z.string().optional(),
5 |   scopes: z.array(z.string()).optional(),
6 | })
7 | 
8 | export type McpOauth = z.infer<typeof McpOauthSchema>
9 | 


--------------------------------------------------------------------------------
/src/tools/skill-mcp/constants.ts:
--------------------------------------------------------------------------------
1 | export const SKILL_MCP_TOOL_NAME = "skill_mcp"
2 | 
3 | export const SKILL_MCP_DESCRIPTION = `Invoke MCP server operations from skill-embedded MCPs. Requires mcp_name plus exactly one of: tool_name, resource_name, or prompt_name.`
4 | 


--------------------------------------------------------------------------------
/src/hooks/auto-slash-command/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./detector"
2 | export * from "./executor"
3 | export * from "./constants"
4 | export * from "./types"
5 | 
6 | export { createAutoSlashCommandHook } from "./hook"
7 | export type { AutoSlashCommandHookOptions } from "./hook"
8 | 


--------------------------------------------------------------------------------
/src/hooks/directory-agents-injector/constants.ts:
--------------------------------------------------------------------------------
1 | import { join } from "node:path";
2 | import { OPENCODE_STORAGE } from "../../shared";
3 | export const AGENTS_INJECTOR_STORAGE = join(
4 |   OPENCODE_STORAGE,
5 |   "directory-agents",
6 | );
7 | export const AGENTS_FILENAME = "AGENTS.md";
8 | 


--------------------------------------------------------------------------------
/src/hooks/directory-readme-injector/constants.ts:
--------------------------------------------------------------------------------
1 | import { join } from "node:path";
2 | import { OPENCODE_STORAGE } from "../../shared";
3 | export const README_INJECTOR_STORAGE = join(
4 |   OPENCODE_STORAGE,
5 |   "directory-readme",
6 | );
7 | export const README_FILENAME = "README.md";
8 | 


--------------------------------------------------------------------------------
/src/shared/tmux/tmux-utils/environment.ts:
--------------------------------------------------------------------------------
 1 | export type SplitDirection = "-h" | "-v"
 2 | 
 3 | export function isInsideTmux(): boolean {
 4 | 	return Boolean(process.env.TMUX)
 5 | }
 6 | 
 7 | export function getCurrentPaneId(): string | undefined {
 8 | 	return process.env.TMUX_PANE
 9 | }
10 | 


--------------------------------------------------------------------------------
/src/tools/delegate-task/index.ts:
--------------------------------------------------------------------------------
1 | export { createDelegateTask, resolveCategoryConfig, buildSystemContent } from "./tools"
2 | export type { DelegateTaskToolOptions, SyncSessionCreatedEvent, BuildSystemContentInput } from "./tools"
3 | export type * from "./types"
4 | export * from "./constants"
5 | 


--------------------------------------------------------------------------------
/src/hooks/auto-update-checker/checker/jsonc-strip.ts:
--------------------------------------------------------------------------------
1 | export function stripJsonComments(json: string): string {
2 |   return json
3 |     .replace(/\\"|"(?:\\"|[^"])*"|(\/\/.*|\/\*[\s\S]*?\*\/)/g, (match, group) =>
4 |       group ? "" : match
5 |     )
6 |     .replace(/,(\s*[}\]])/g, "$1")
7 | }
8 | 


--------------------------------------------------------------------------------
/src/hooks/ralph-loop/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./types"
2 | export * from "./constants"
3 | export { readState, writeState, clearState, incrementIteration } from "./storage"
4 | 
5 | export { createRalphLoopHook } from "./ralph-loop-hook"
6 | export type { RalphLoopHook } from "./ralph-loop-hook"
7 | 


--------------------------------------------------------------------------------
/src/features/opencode-skill-loader/merger/scope-priority.ts:
--------------------------------------------------------------------------------
 1 | import type { SkillScope } from "../types"
 2 | 
 3 | export const SCOPE_PRIORITY: Record<SkillScope, number> = {
 4 |   builtin: 1,
 5 |   config: 2,
 6 |   user: 3,
 7 |   opencode: 4,
 8 |   project: 5,
 9 |   "opencode-project": 6,
10 | }
11 | 


--------------------------------------------------------------------------------
/src/tools/call-omo-agent/tool-context-with-metadata.ts:
--------------------------------------------------------------------------------
 1 | export type ToolContextWithMetadata = {
 2 | 	sessionID: string
 3 | 	messageID: string
 4 | 	agent: string
 5 | 	abort: AbortSignal
 6 | 	metadata?: (input: {
 7 | 		title?: string
 8 | 		metadata?: Record<string, unknown>
 9 | 	}) => void
10 | }
11 | 


--------------------------------------------------------------------------------
/src/cli/config-manager/generate-omo-config.ts:
--------------------------------------------------------------------------------
1 | import type { InstallConfig } from "../types"
2 | import { generateModelConfig } from "../model-fallback"
3 | 
4 | export function generateOmoConfig(installConfig: InstallConfig): Record<string, unknown> {
5 |   return generateModelConfig(installConfig)
6 | }
7 | 


--------------------------------------------------------------------------------
/src/hooks/delegate-task-retry/index.ts:
--------------------------------------------------------------------------------
1 | export type { DelegateTaskErrorPattern, DetectedError } from "./patterns"
2 | export { DELEGATE_TASK_ERROR_PATTERNS, detectDelegateTaskError } from "./patterns"
3 | export { buildRetryGuidance } from "./guidance"
4 | export { createDelegateTaskRetryHook } from "./hook"
5 | 


--------------------------------------------------------------------------------
/src/hooks/ralph-loop/constants.ts:
--------------------------------------------------------------------------------
1 | export const HOOK_NAME = "ralph-loop"
2 | export const DEFAULT_STATE_FILE = ".sisyphus/ralph-loop.local.md"
3 | export const COMPLETION_TAG_PATTERN = /<promise>(.*?)<\/promise>/is
4 | export const DEFAULT_MAX_ITERATIONS = 100
5 | export const DEFAULT_COMPLETION_PROMISE = "DONE"
6 | 


--------------------------------------------------------------------------------
/src/features/background-agent/spawner/concurrency-key-from-launch-input.ts:
--------------------------------------------------------------------------------
1 | import type { LaunchInput } from "../types"
2 | 
3 | export function getConcurrencyKeyFromLaunchInput(input: LaunchInput): string {
4 |   return input.model
5 |     ? `${input.model.providerID}/${input.model.modelID}`
6 |     : input.agent
7 | }
8 | 


--------------------------------------------------------------------------------
/src/mcp/types.ts:
--------------------------------------------------------------------------------
 1 | import { z } from "zod"
 2 | 
 3 | export const McpNameSchema = z.enum(["websearch", "context7", "grep_app"])
 4 | 
 5 | export type McpName = z.infer<typeof McpNameSchema>
 6 | 
 7 | export const AnyMcpNameSchema = z.string().min(1)
 8 | 
 9 | export type AnyMcpName = z.infer<typeof AnyMcpNameSchema>
10 | 


--------------------------------------------------------------------------------
/src/tools/lsp/tools.ts:
--------------------------------------------------------------------------------
1 | export { lsp_goto_definition } from "./goto-definition-tool"
2 | export { lsp_find_references } from "./find-references-tool"
3 | export { lsp_symbols } from "./symbols-tool"
4 | export { lsp_diagnostics } from "./diagnostics-tool"
5 | export { lsp_prepare_rename, lsp_rename } from "./rename-tools"
6 | 


--------------------------------------------------------------------------------
/src/features/builtin-skills/skills/index.ts:
--------------------------------------------------------------------------------
1 | export { playwrightSkill, agentBrowserSkill } from "./playwright"
2 | export { playwrightCliSkill } from "./playwright-cli"
3 | export { frontendUiUxSkill } from "./frontend-ui-ux"
4 | export { gitMasterSkill } from "./git-master"
5 | export { devBrowserSkill } from "./dev-browser"
6 | 


--------------------------------------------------------------------------------
/src/tools/lsp/constants.ts:
--------------------------------------------------------------------------------
1 | export const DEFAULT_MAX_REFERENCES = 200
2 | export const DEFAULT_MAX_SYMBOLS = 200
3 | export const DEFAULT_MAX_DIAGNOSTICS = 200
4 | 
5 | export { SYMBOL_KIND_MAP, SEVERITY_MAP, EXT_TO_LANG } from "./language-mappings"
6 | export { BUILTIN_SERVERS, LSP_INSTALL_HINTS } from "./server-definitions"
7 | 


--------------------------------------------------------------------------------
/src/hooks/unstable-agent-babysitter/index.ts:
--------------------------------------------------------------------------------
 1 | export { createUnstableAgentBabysitterHook } from "./unstable-agent-babysitter-hook"
 2 | export {
 3 |   buildReminder,
 4 |   extractMessages,
 5 |   getMessageInfo,
 6 |   getMessageParts,
 7 |   isUnstableTask,
 8 |   THINKING_SUMMARY_MAX_CHARS,
 9 | } from "./task-message-analyzer"
10 | 


--------------------------------------------------------------------------------
/src/hooks/interactive-bash-session/types.ts:
--------------------------------------------------------------------------------
 1 | export interface InteractiveBashSessionState {
 2 |   sessionID: string;
 3 |   tmuxSessions: Set<string>;
 4 |   updatedAt: number;
 5 | }
 6 | 
 7 | export interface SerializedInteractiveBashSessionState {
 8 |   sessionID: string;
 9 |   tmuxSessions: string[];
10 |   updatedAt: number;
11 | }
12 | 


--------------------------------------------------------------------------------
/src/shared/claude-config-dir.ts:
--------------------------------------------------------------------------------
 1 | import { homedir } from "node:os"
 2 | import { join } from "node:path"
 3 | 
 4 | export function getClaudeConfigDir(): string {
 5 |   const envConfigDir = process.env.CLAUDE_CONFIG_DIR
 6 |   if (envConfigDir) {
 7 |     return envConfigDir
 8 |   }
 9 |   
10 |   return join(homedir(), ".claude")
11 | }
12 | 


--------------------------------------------------------------------------------
/src/features/tmux-subagent/polling-constants.ts:
--------------------------------------------------------------------------------
1 | export const SESSION_TIMEOUT_MS = 10 * 60 * 1000
2 | 
3 | // Stability detection constants (prevents premature closure - see issue #1330)
4 | // Mirrors the proven pattern from background-agent/manager.ts
5 | export const MIN_STABILITY_TIME_MS = 10 * 1000
6 | export const STABLE_POLLS_REQUIRED = 3
7 | 


--------------------------------------------------------------------------------
/src/hooks/directory-agents-injector/storage.ts:
--------------------------------------------------------------------------------
1 | import { AGENTS_INJECTOR_STORAGE } from "./constants";
2 | import { createInjectedPathsStorage } from "../../shared/session-injected-paths";
3 | 
4 | export const {
5 |   loadInjectedPaths,
6 |   saveInjectedPaths,
7 |   clearInjectedPaths,
8 | } = createInjectedPathsStorage(AGENTS_INJECTOR_STORAGE);
9 | 


--------------------------------------------------------------------------------
/src/hooks/directory-readme-injector/storage.ts:
--------------------------------------------------------------------------------
1 | import { README_INJECTOR_STORAGE } from "./constants";
2 | import { createInjectedPathsStorage } from "../../shared/session-injected-paths";
3 | 
4 | export const {
5 |   loadInjectedPaths,
6 |   saveInjectedPaths,
7 |   clearInjectedPaths,
8 | } = createInjectedPathsStorage(README_INJECTOR_STORAGE);
9 | 


--------------------------------------------------------------------------------
/src/tools/delegate-task/sync-continuation-deps.ts:
--------------------------------------------------------------------------------
 1 | import { pollSyncSession } from "./sync-session-poller"
 2 | import { fetchSyncResult } from "./sync-result-fetcher"
 3 | 
 4 | export const syncContinuationDeps = {
 5 |   pollSyncSession,
 6 |   fetchSyncResult,
 7 | }
 8 | 
 9 | export type SyncContinuationDeps = typeof syncContinuationDeps
10 | 


--------------------------------------------------------------------------------
/src/features/background-agent/index.ts:
--------------------------------------------------------------------------------
1 | export * from "./types"
2 | export { BackgroundManager, type SubagentSessionCreatedEvent, type OnSubagentSessionCreated } from "./manager"
3 | export { TaskHistory, type TaskHistoryEntry } from "./task-history"
4 | export { ConcurrencyManager } from "./concurrency"
5 | export { TaskStateManager } from "./state"
6 | 


--------------------------------------------------------------------------------
/src/shared/truncate-description.ts:
--------------------------------------------------------------------------------
 1 | export function truncateDescription(description: string, maxLength: number = 120): string {
 2 |   if (!description) {
 3 |     return description
 4 |   }
 5 | 
 6 |   if (description.length <= maxLength) {
 7 |     return description
 8 |   }
 9 | 
10 |   return description.slice(0, maxLength - 3) + "..."
11 | }
12 | 


--------------------------------------------------------------------------------
/src/config/schema/commands.ts:
--------------------------------------------------------------------------------
 1 | import { z } from "zod"
 2 | 
 3 | export const BuiltinCommandNameSchema = z.enum([
 4 |   "init-deep",
 5 |   "ralph-loop",
 6 |   "ulw-loop",
 7 |   "cancel-ralph",
 8 |   "refactor",
 9 |   "start-work",
10 |   "stop-continuation",
11 | ])
12 | 
13 | export type BuiltinCommandName = z.infer<typeof BuiltinCommandNameSchema>
14 | 


--------------------------------------------------------------------------------
/src/hooks/session-recovery/index.ts:
--------------------------------------------------------------------------------
1 | export { createSessionRecoveryHook } from "./hook"
2 | export type { SessionRecoveryHook, SessionRecoveryOptions } from "./hook"
3 | 
4 | export { detectErrorType } from "./detect-error-type"
5 | export type { RecoveryErrorType } from "./detect-error-type"
6 | 
7 | export type { MessageData, ResumeConfig } from "./types"
8 | 


--------------------------------------------------------------------------------
/src/shared/open-code-client-shapes.ts:
--------------------------------------------------------------------------------
1 | export type ProviderListResponse = { data?: { connected?: string[] } }
2 | export type ModelListResponse = {
3 | 	data?: Array<{ id?: string; provider?: string }>
4 | }
5 | 
6 | export type ProviderListFunction = () => Promise<ProviderListResponse>
7 | export type ModelListFunction = () => Promise<ModelListResponse>
8 | 


--------------------------------------------------------------------------------
/src/cli/config-manager/ensure-config-directory-exists.ts:
--------------------------------------------------------------------------------
 1 | import { existsSync, mkdirSync } from "node:fs"
 2 | import { getConfigDir } from "./config-context"
 3 | 
 4 | export function ensureConfigDirectoryExists(): void {
 5 |   const configDir = getConfigDir()
 6 |   if (!existsSync(configDir)) {
 7 |     mkdirSync(configDir, { recursive: true })
 8 |   }
 9 | }
10 | 


--------------------------------------------------------------------------------
/src/config/schema/notification.ts:
--------------------------------------------------------------------------------
1 | import { z } from "zod"
2 | 
3 | export const NotificationConfigSchema = z.object({
4 |   /** Force enable session-notification even if external notification plugins are detected (default: false) */
5 |   force_enable: z.boolean().optional(),
6 | })
7 | 
8 | export type NotificationConfig = z.infer<typeof NotificationConfigSchema>
9 | 


--------------------------------------------------------------------------------
/src/features/claude-code-mcp-loader/index.ts:
--------------------------------------------------------------------------------
 1 | /**
 2 |  * MCP Configuration Loader
 3 |  *
 4 |  * Loads Claude Code .mcp.json format configurations from multiple scopes
 5 |  * and transforms them to OpenCode SDK format
 6 |  */
 7 | 
 8 | export * from "./types"
 9 | export * from "./loader"
10 | export * from "./transformer"
11 | export * from "./env-expander"
12 | 


--------------------------------------------------------------------------------
/src/hooks/session-recovery/constants.ts:
--------------------------------------------------------------------------------
1 | export { OPENCODE_STORAGE, MESSAGE_STORAGE, PART_STORAGE } from "../../shared"
2 | 
3 | export const THINKING_TYPES = new Set(["thinking", "redacted_thinking", "reasoning"])
4 | export const META_TYPES = new Set(["step-start", "step-finish"])
5 | export const CONTENT_TYPES = new Set(["text", "tool", "tool_use", "tool_result"])
6 | 


--------------------------------------------------------------------------------
/src/plugin-state.ts:
--------------------------------------------------------------------------------
 1 | export interface ModelCacheState {
 2 |   modelContextLimitsCache: Map<string, number>;
 3 |   anthropicContext1MEnabled: boolean;
 4 | }
 5 | 
 6 | export function createModelCacheState(): ModelCacheState {
 7 |   return {
 8 |     modelContextLimitsCache: new Map<string, number>(),
 9 |     anthropicContext1MEnabled: false,
10 |   };
11 | }
12 | 


--------------------------------------------------------------------------------
/src/shared/command-executor.ts:
--------------------------------------------------------------------------------
1 | export { executeHookCommand } from "./command-executor/execute-hook-command"
2 | export type { CommandResult, ExecuteHookOptions } from "./command-executor/execute-hook-command"
3 | 
4 | export { executeCommand } from "./command-executor/execute-command"
5 | export { resolveCommandsInText } from "./command-executor/resolve-commands-in-text"
6 | 


--------------------------------------------------------------------------------
/src/config/schema/comment-checker.ts:
--------------------------------------------------------------------------------
1 | import { z } from "zod"
2 | 
3 | export const CommentCheckerConfigSchema = z.object({
4 |   /** Custom prompt to replace the default warning message. Use {{comments}} placeholder for detected comments XML. */
5 |   custom_prompt: z.string().optional(),
6 | })
7 | 
8 | export type CommentCheckerConfig = z.infer<typeof CommentCheckerConfigSchema>
9 | 


--------------------------------------------------------------------------------
/src/features/background-agent/result-handler-context.ts:
--------------------------------------------------------------------------------
 1 | import type { OpencodeClient } from "./constants"
 2 | import type { ConcurrencyManager } from "./concurrency"
 3 | import type { TaskStateManager } from "./state"
 4 | 
 5 | export interface ResultHandlerContext {
 6 |   client: OpencodeClient
 7 |   concurrencyManager: ConcurrencyManager
 8 |   state: TaskStateManager
 9 | }
10 | 


--------------------------------------------------------------------------------
/src/shared/opencode-storage-paths.ts:
--------------------------------------------------------------------------------
1 | import { join } from "node:path"
2 | import { getOpenCodeStorageDir } from "./data-path"
3 | 
4 | export const OPENCODE_STORAGE = getOpenCodeStorageDir()
5 | export const MESSAGE_STORAGE = join(OPENCODE_STORAGE, "message")
6 | export const PART_STORAGE = join(OPENCODE_STORAGE, "part")
7 | export const SESSION_STORAGE = join(OPENCODE_STORAGE, "session")


--------------------------------------------------------------------------------
/src/tools/ast-grep/index.ts:
--------------------------------------------------------------------------------
1 | export { createAstGrepTools } from "./tools"
2 | export { ensureAstGrepBinary, getCachedBinaryPath, getCacheDir } from "./downloader"
3 | export { getAstGrepPath, isCliAvailable, ensureCliAvailable, startBackgroundInit } from "./cli"
4 | export { checkEnvironment, formatEnvironmentCheck } from "./constants"
5 | export type { EnvironmentCheckResult } from "./constants"
6 | 


--------------------------------------------------------------------------------
/src/tools/look-at/constants.ts:
--------------------------------------------------------------------------------
1 | export const MULTIMODAL_LOOKER_AGENT = "multimodal-looker" as const
2 | 
3 | export const LOOK_AT_DESCRIPTION = `Analyze media files (PDFs, images, diagrams) that require interpretation beyond raw text. Extracts specific information or summaries from documents, describes visual content. Use when you need analyzed/extracted data rather than literal file contents.`
4 | 


--------------------------------------------------------------------------------
/.github/ISSUE_TEMPLATE/config.yml:
--------------------------------------------------------------------------------
1 | blank_issues_enabled: false
2 | contact_links:
3 |   - name: Discord Community
4 |     url: https://discord.gg/PUwSMR9XNk
5 |     about: Join our Discord server for real-time discussions and community support
6 |   - name: Documentation
7 |     url: https://github.com/code-yeongyu/oh-my-opencode#readme
8 |     about: Read the comprehensive documentation and guides
9 | 


--------------------------------------------------------------------------------
/src/features/opencode-skill-loader/allowed-tools-parser.ts:
--------------------------------------------------------------------------------
 1 | export function parseAllowedTools(allowedTools: string | string[] | undefined): string[] | undefined {
 2 |   if (!allowedTools) return undefined
 3 | 
 4 |   if (Array.isArray(allowedTools)) {
 5 |     return allowedTools.map((tool) => tool.trim()).filter(Boolean)
 6 |   }
 7 | 
 8 |   return allowedTools.split(/\s+/).filter(Boolean)
 9 | }
10 | 


--------------------------------------------------------------------------------
/src/hooks/atlas/sisyphus-path.ts:
--------------------------------------------------------------------------------
1 | /**
2 |  * Cross-platform check if a path is inside .sisyphus/ directory.
3 |  * Handles both forward slashes (Unix) and backslashes (Windows).
4 |  * Uses path segment matching (not substring) to avoid false positives like "not-sisyphus/file.txt"
5 |  */
6 | export function isSisyphusPath(filePath: string): boolean {
7 |   return /\.sisyphus[/\\]/.test(filePath)
8 | }
9 | 


--------------------------------------------------------------------------------
/src/mcp/context7.ts:
--------------------------------------------------------------------------------
 1 | export const context7 = {
 2 |   type: "remote" as const,
 3 |   url: "https://mcp.context7.com/mcp",
 4 |   enabled: true,
 5 |   headers: process.env.CONTEXT7_API_KEY
 6 |     ? { Authorization: `Bearer ${process.env.CONTEXT7_API_KEY}` }
 7 |     : undefined,
 8 |   // Disable OAuth auto-detection - Context7 uses API key header, not OAuth
 9 |   oauth: false as const,
10 | }
11 | 


--------------------------------------------------------------------------------
/src/config/schema/sisyphus-agent.ts:
--------------------------------------------------------------------------------
 1 | import { z } from "zod"
 2 | 
 3 | export const SisyphusAgentConfigSchema = z.object({
 4 |   disabled: z.boolean().optional(),
 5 |   default_builder_enabled: z.boolean().optional(),
 6 |   planner_enabled: z.boolean().optional(),
 7 |   replace_plan: z.boolean().optional(),
 8 | })
 9 | 
10 | export type SisyphusAgentConfig = z.infer<typeof SisyphusAgentConfigSchema>
11 | 


--------------------------------------------------------------------------------
/src/agents/sisyphus-junior/index.ts:
--------------------------------------------------------------------------------
 1 | export { buildDefaultSisyphusJuniorPrompt } from "./default"
 2 | export { buildGptSisyphusJuniorPrompt } from "./gpt"
 3 | 
 4 | export {
 5 |   SISYPHUS_JUNIOR_DEFAULTS,
 6 |   getSisyphusJuniorPromptSource,
 7 |   buildSisyphusJuniorPrompt,
 8 |   createSisyphusJuniorAgentWithOverrides,
 9 | } from "./agent"
10 | export type { SisyphusJuniorPromptSource } from "./agent"
11 | 


--------------------------------------------------------------------------------
/src/tools/delegate-task/model-string-parser.ts:
--------------------------------------------------------------------------------
 1 | /**
 2 |  * Parse a model string in "provider/model" format.
 3 |  */
 4 | export function parseModelString(model: string): { providerID: string; modelID: string } | undefined {
 5 |   const parts = model.split("/")
 6 |   if (parts.length >= 2) {
 7 |     return { providerID: parts[0], modelID: parts.slice(1).join("/") }
 8 |   }
 9 |   return undefined
10 | }
11 | 


--------------------------------------------------------------------------------
/src/shared/model-sanitizer.ts:
--------------------------------------------------------------------------------
 1 | type CommandSource = "claude-code" | "opencode"
 2 | 
 3 | export function sanitizeModelField(model: unknown, source: CommandSource = "claude-code"): string | undefined {
 4 |   if (source === "claude-code") {
 5 |     return undefined
 6 |   }
 7 |   
 8 |   if (typeof model === "string" && model.trim().length > 0) {
 9 |     return model.trim()
10 |   }
11 |   return undefined
12 | }
13 | 


--------------------------------------------------------------------------------
/src/agents/builtin-agents/environment-context.ts:
--------------------------------------------------------------------------------
1 | import type { AgentConfig } from "@opencode-ai/sdk"
2 | import { createEnvContext } from "../env-context"
3 | 
4 | export function applyEnvironmentContext(config: AgentConfig, directory?: string): AgentConfig {
5 |   if (!directory || !config.prompt) return config
6 |   const envContext = createEnvContext()
7 |   return { ...config, prompt: config.prompt + envContext }
8 | }
9 | 


--------------------------------------------------------------------------------
/src/cli/config-manager/jsonc-provider-editor.ts:
--------------------------------------------------------------------------------
 1 | import { modify, applyEdits } from "jsonc-parser"
 2 | 
 3 | export function modifyProviderInJsonc(
 4 |   content: string,
 5 |   newProviderValue: Record<string, unknown>
 6 | ): string {
 7 |   const edits = modify(content, ["provider"], newProviderValue, {
 8 |     formattingOptions: { tabSize: 2, insertSpaces: true },
 9 |   })
10 |   return applyEdits(content, edits)
11 | }
12 | 


--------------------------------------------------------------------------------
/src/features/context-injector/index.ts:
--------------------------------------------------------------------------------
 1 | export { ContextCollector, contextCollector } from "./collector"
 2 | export {
 3 |   createContextInjectorMessagesTransformHook,
 4 | } from "./injector"
 5 | export type {
 6 |   ContextSourceType,
 7 |   ContextPriority,
 8 |   ContextEntry,
 9 |   RegisterContextOptions,
10 |   PendingContext,
11 |   MessageContext,
12 |   OutputParts,
13 |   InjectionStrategy,
14 | } from "./types"
15 | 


--------------------------------------------------------------------------------
/src/hooks/claude-code-hooks/plugin-config.ts:
--------------------------------------------------------------------------------
 1 | /**
 2 |  * Plugin configuration for Claude Code hooks execution
 3 |  * Contains settings for hook command execution (zsh, etc.)
 4 |  */
 5 | 
 6 | const isWindows = process.platform === "win32"
 7 | 
 8 | export const DEFAULT_CONFIG = {
 9 |   // Windows doesn't have zsh by default, so we disable forceZsh on Windows
10 |   forceZsh: !isWindows,
11 |   zshPath: "/bin/zsh",
12 | }
13 | 


--------------------------------------------------------------------------------
/src/features/claude-code-plugin-loader/index.ts:
--------------------------------------------------------------------------------
 1 | export * from "./types"
 2 | export * from "./loader"
 3 | export * from "./discovery"
 4 | export * from "./plugin-path-resolver"
 5 | export * from "./command-loader"
 6 | export * from "./skill-loader"
 7 | export * from "./agent-loader"
 8 | export * from "./mcp-server-loader"
 9 | export * from "./hook-loader"
10 | export type { PluginLoaderOptions, ClaudeSettings } from "./types"
11 | 


--------------------------------------------------------------------------------
/src/features/tmux-subagent/tmux-grid-constants.ts:
--------------------------------------------------------------------------------
 1 | import { MIN_PANE_HEIGHT, MIN_PANE_WIDTH } from "./types"
 2 | 
 3 | export const MAIN_PANE_RATIO = 0.5
 4 | export const MAX_COLS = 2
 5 | export const MAX_ROWS = 3
 6 | export const MAX_GRID_SIZE = 4
 7 | export const DIVIDER_SIZE = 1
 8 | 
 9 | export const MIN_SPLIT_WIDTH = 2 * MIN_PANE_WIDTH + DIVIDER_SIZE
10 | export const MIN_SPLIT_HEIGHT = 2 * MIN_PANE_HEIGHT + DIVIDER_SIZE
11 | 


--------------------------------------------------------------------------------
/src/features/claude-code-agent-loader/types.ts:
--------------------------------------------------------------------------------
 1 | import type { AgentConfig } from "@opencode-ai/sdk"
 2 | 
 3 | export type AgentScope = "user" | "project"
 4 | 
 5 | export interface AgentFrontmatter {
 6 |   name?: string
 7 |   description?: string
 8 |   model?: string
 9 |   tools?: string
10 | }
11 | 
12 | export interface LoadedAgent {
13 |   name: string
14 |   path: string
15 |   config: AgentConfig
16 |   scope: AgentScope
17 | }
18 | 


--------------------------------------------------------------------------------
/src/hooks/auto-update-checker/index.ts:
--------------------------------------------------------------------------------
 1 | export { createAutoUpdateCheckerHook } from "./hook"
 2 | 
 3 | export {
 4 |   isPrereleaseVersion,
 5 |   isDistTag,
 6 |   isPrereleaseOrDistTag,
 7 |   extractChannel,
 8 | } from "./version-channel"
 9 | 
10 | export { checkForUpdate } from "./checker"
11 | export { invalidatePackage, invalidateCache } from "./cache"
12 | export type { UpdateCheckResult, AutoUpdateCheckerOptions } from "./types"
13 | 


--------------------------------------------------------------------------------
/src/plugin-handlers/category-config-resolver.ts:
--------------------------------------------------------------------------------
 1 | import type { CategoryConfig } from "../config/schema";
 2 | import { DEFAULT_CATEGORIES } from "../tools/delegate-task/constants";
 3 | 
 4 | export function resolveCategoryConfig(
 5 |   categoryName: string,
 6 |   userCategories?: Record<string, CategoryConfig>,
 7 | ): CategoryConfig | undefined {
 8 |   return userCategories?.[categoryName] ?? DEFAULT_CATEGORIES[categoryName];
 9 | }
10 | 


--------------------------------------------------------------------------------
/src/shared/opencode-config-dir-types.ts:
--------------------------------------------------------------------------------
 1 | export type OpenCodeBinaryType = "opencode" | "opencode-desktop"
 2 | 
 3 | export type OpenCodeConfigDirOptions = {
 4 |   binary: OpenCodeBinaryType
 5 |   version?: string | null
 6 |   checkExisting?: boolean
 7 | }
 8 | 
 9 | export type OpenCodeConfigPaths = {
10 |   configDir: string
11 |   configJson: string
12 |   configJsonc: string
13 |   packageJson: string
14 |   omoConfig: string
15 | }
16 | 


--------------------------------------------------------------------------------
/src/tools/glob/constants.ts:
--------------------------------------------------------------------------------
 1 | export { resolveGrepCli, resolveGrepCliWithAutoInstall, type GrepBackend } from "../grep/constants"
 2 | 
 3 | export const DEFAULT_TIMEOUT_MS = 60_000
 4 | export const DEFAULT_LIMIT = 100
 5 | export const DEFAULT_MAX_DEPTH = 20
 6 | export const DEFAULT_MAX_OUTPUT_BYTES = 10 * 1024 * 1024
 7 | 
 8 | export const RG_FILES_FLAGS = [
 9 |   "--files",
10 |   "--color=never",
11 |   "--glob=!.git/*",
12 | ] as const
13 | 


--------------------------------------------------------------------------------
/src/cli/doctor/index.ts:
--------------------------------------------------------------------------------
 1 | import type { DoctorOptions } from "./types"
 2 | import { runDoctor } from "./runner"
 3 | 
 4 | export async function doctor(options: DoctorOptions = { mode: "default" }): Promise<number> {
 5 |   const result = await runDoctor(options)
 6 |   return result.exitCode
 7 | }
 8 | 
 9 | export * from "./types"
10 | export { runDoctor } from "./runner"
11 | export { formatDoctorOutput, formatJsonOutput } from "./formatter"
12 | 


--------------------------------------------------------------------------------
/src/hooks/anthropic-context-window-limit-recovery/storage-paths.ts:
--------------------------------------------------------------------------------
1 | import { MESSAGE_STORAGE, PART_STORAGE } from "../../shared"
2 | 
3 | export { MESSAGE_STORAGE as MESSAGE_STORAGE_DIR, PART_STORAGE as PART_STORAGE_DIR }
4 | 
5 | export const TRUNCATION_MESSAGE =
6 | 	"[TOOL RESULT TRUNCATED - Context limit exceeded. Original output was too large and has been truncated to recover the session. Please re-run this tool if you need the full output.]"
7 | 


--------------------------------------------------------------------------------
/src/hooks/auto-slash-command/constants.ts:
--------------------------------------------------------------------------------
 1 | export const HOOK_NAME = "auto-slash-command" as const
 2 | 
 3 | export const AUTO_SLASH_COMMAND_TAG_OPEN = "<auto-slash-command>"
 4 | export const AUTO_SLASH_COMMAND_TAG_CLOSE = "</auto-slash-command>"
 5 | 
 6 | export const SLASH_COMMAND_PATTERN = /^\/([a-zA-Z][\w-]*)\s*(.*)/
 7 | 
 8 | export const EXCLUDED_COMMANDS = new Set([
 9 |   "ralph-loop",
10 |   "cancel-ralph",
11 |   "ulw-loop",
12 | ])
13 | 


--------------------------------------------------------------------------------
/src/cli/get-local-version/types.ts:
--------------------------------------------------------------------------------
 1 | export interface VersionInfo {
 2 |   currentVersion: string | null
 3 |   latestVersion: string | null
 4 |   isUpToDate: boolean
 5 |   isLocalDev: boolean
 6 |   isPinned: boolean
 7 |   pinnedVersion: string | null
 8 |   status: "up-to-date" | "outdated" | "local-dev" | "pinned" | "error" | "unknown"
 9 | }
10 | 
11 | export interface GetLocalVersionOptions {
12 |   directory?: string
13 |   json?: boolean
14 | }
15 | 


--------------------------------------------------------------------------------
/src/features/builtin-commands/types.ts:
--------------------------------------------------------------------------------
 1 | import type { CommandDefinition } from "../claude-code-command-loader"
 2 | 
 3 | export type BuiltinCommandName = "init-deep" | "ralph-loop" | "cancel-ralph" | "ulw-loop" | "refactor" | "start-work" | "stop-continuation" | "handoff"
 4 | 
 5 | export interface BuiltinCommandConfig {
 6 |   disabled_commands?: BuiltinCommandName[]
 7 | }
 8 | 
 9 | export type BuiltinCommands = Record<string, CommandDefinition>
10 | 


--------------------------------------------------------------------------------
/src/features/opencode-skill-loader/skill-deduplication.ts:
--------------------------------------------------------------------------------
 1 | import type { LoadedSkill } from "./types"
 2 | 
 3 | export function deduplicateSkillsByName(skills: LoadedSkill[]): LoadedSkill[] {
 4 |   const seen = new Set<string>()
 5 |   const result: LoadedSkill[] = []
 6 |   for (const skill of skills) {
 7 |     if (!seen.has(skill.name)) {
 8 |       seen.add(skill.name)
 9 |       result.push(skill)
10 |     }
11 |   }
12 |   return result
13 | }
14 | 


--------------------------------------------------------------------------------
/src/tools/ast-grep/constants.ts:
--------------------------------------------------------------------------------
1 | export type { EnvironmentCheckResult } from "./environment-check"
2 | export { checkEnvironment, formatEnvironmentCheck } from "./environment-check"
3 | export { CLI_LANGUAGES, NAPI_LANGUAGES, LANG_EXTENSIONS } from "./language-support"
4 | export { DEFAULT_TIMEOUT_MS, DEFAULT_MAX_OUTPUT_BYTES, DEFAULT_MAX_MATCHES } from "./language-support"
5 | export { findSgCliPathSync, getSgCliPath, setSgCliPath } from "./sg-cli-path"
6 | 


--------------------------------------------------------------------------------
/src/tools/background-task/tools.ts:
--------------------------------------------------------------------------------
 1 | export type {
 2 |   BackgroundCancelClient,
 3 |   BackgroundOutputClient,
 4 |   BackgroundOutputManager,
 5 |   BackgroundOutputMessage,
 6 |   BackgroundOutputMessagesResult,
 7 | } from "./clients"
 8 | 
 9 | export { createBackgroundTask } from "./create-background-task"
10 | export { createBackgroundOutput } from "./create-background-output"
11 | export { createBackgroundCancel } from "./create-background-cancel"
12 | 


--------------------------------------------------------------------------------
/src/cli/install.ts:
--------------------------------------------------------------------------------
 1 | import packageJson from "../../package.json" with { type: "json" }
 2 | import type { InstallArgs } from "./types"
 3 | import { runCliInstaller } from "./cli-installer"
 4 | import { runTuiInstaller } from "./tui-installer"
 5 | 
 6 | const VERSION = packageJson.version
 7 | 
 8 | export async function install(args: InstallArgs): Promise<number> {
 9 |   return args.tui ? runTuiInstaller(args, VERSION) : runCliInstaller(args, VERSION)
10 | }
11 | 


--------------------------------------------------------------------------------
/src/tools/lsp/index.ts:
--------------------------------------------------------------------------------
 1 | export * from "./types"
 2 | export * from "./constants"
 3 | export * from "./config"
 4 | export * from "./client"
 5 | export * from "./lsp-client-wrapper"
 6 | export * from "./lsp-formatters"
 7 | export * from "./workspace-edit"
 8 | // NOTE: lsp_servers removed - duplicates OpenCode's built-in LspServers
 9 | export { lsp_goto_definition, lsp_find_references, lsp_symbols, lsp_diagnostics, lsp_prepare_rename, lsp_rename } from "./tools"
10 | 


--------------------------------------------------------------------------------
/src/tools/skill/constants.ts:
--------------------------------------------------------------------------------
1 | export const TOOL_NAME = "skill" as const
2 | 
3 | export const TOOL_DESCRIPTION_NO_SKILLS = "Load a skill to get detailed instructions for a specific task. No skills are currently available."
4 | 
5 | export const TOOL_DESCRIPTION_PREFIX = `Load a skill to get detailed instructions for a specific task.
6 | 
7 | Skills provide specialized knowledge and step-by-step guidance.
8 | Use this when a task matches an available skill's description.`
9 | 


--------------------------------------------------------------------------------
/src/features/builtin-skills/skills/git-master-skill-metadata.ts:
--------------------------------------------------------------------------------
1 | export const GIT_MASTER_SKILL_NAME = "git-master"
2 | 
3 | export const GIT_MASTER_SKILL_DESCRIPTION =
4 |   "MUST USE for ANY git operations. Atomic commits, rebase/squash, history search (blame, bisect, log -S). STRONGLY RECOMMENDED: Use with task(category='quick', load_skills=['git-master'], ...) to save context. Triggers: 'commit', 'rebase', 'squash', 'who wrote', 'when was X added', 'find the commit that'."
5 | 


--------------------------------------------------------------------------------
/src/features/opencode-skill-loader/skill-resolution-options.ts:
--------------------------------------------------------------------------------
 1 | import type { BrowserAutomationProvider, GitMasterConfig } from "../../config/schema"
 2 | 
 3 | export interface SkillResolutionOptions {
 4 | 	gitMasterConfig?: GitMasterConfig
 5 | 	browserProvider?: BrowserAutomationProvider
 6 | 	disabledSkills?: Set<string>
 7 | 	/** Project directory to discover project-level skills from. Falls back to process.cwd() if not provided. */
 8 | 	directory?: string
 9 | }
10 | 


--------------------------------------------------------------------------------
/src/features/tmux-subagent/event-handlers.ts:
--------------------------------------------------------------------------------
1 | export { coerceSessionCreatedEvent } from "./session-created-event"
2 | export type { SessionCreatedEvent } from "./session-created-event"
3 | export { handleSessionCreated } from "./session-created-handler"
4 | export type { SessionCreatedHandlerDeps } from "./session-created-handler"
5 | export { handleSessionDeleted } from "./session-deleted-handler"
6 | export type { SessionDeletedHandlerDeps } from "./session-deleted-handler"
7 | 


--------------------------------------------------------------------------------
/src/features/builtin-skills/types.ts:
--------------------------------------------------------------------------------
 1 | import type { SkillMcpConfig } from "../skill-mcp-manager/types"
 2 | 
 3 | export interface BuiltinSkill {
 4 |   name: string
 5 |   description: string
 6 |   template: string
 7 |   license?: string
 8 |   compatibility?: string
 9 |   metadata?: Record<string, unknown>
10 |   allowedTools?: string[]
11 |   agent?: string
12 |   model?: string
13 |   subtask?: boolean
14 |   argumentHint?: string
15 |   mcpConfig?: SkillMcpConfig
16 | }
17 | 


--------------------------------------------------------------------------------
/src/shared/migration.ts:
--------------------------------------------------------------------------------
1 | export { AGENT_NAME_MAP, BUILTIN_AGENT_NAMES, migrateAgentNames } from "./migration/agent-names"
2 | export { HOOK_NAME_MAP, migrateHookNames } from "./migration/hook-names"
3 | export { MODEL_VERSION_MAP, migrateModelVersions } from "./migration/model-versions"
4 | export { MODEL_TO_CATEGORY_MAP, migrateAgentConfigToCategory, shouldDeleteAgentConfig } from "./migration/agent-category"
5 | export { migrateConfigFile } from "./migration/config-migration"
6 | 


--------------------------------------------------------------------------------
/src/features/boulder-state/constants.ts:
--------------------------------------------------------------------------------
 1 | /**
 2 |  * Boulder State Constants
 3 |  */
 4 | 
 5 | export const BOULDER_DIR = ".sisyphus"
 6 | export const BOULDER_FILE = "boulder.json"
 7 | export const BOULDER_STATE_PATH = `${BOULDER_DIR}/${BOULDER_FILE}`
 8 | 
 9 | export const NOTEPAD_DIR = "notepads"
10 | export const NOTEPAD_BASE_PATH = `${BOULDER_DIR}/${NOTEPAD_DIR}`
11 | 
12 | /** Prometheus plan directory pattern */
13 | export const PROMETHEUS_PLANS_DIR = ".sisyphus/plans"
14 | 


--------------------------------------------------------------------------------
/src/shared/config-errors.ts:
--------------------------------------------------------------------------------
 1 | export type ConfigLoadError = {
 2 |   path: string
 3 |   error: string
 4 | }
 5 | 
 6 | let configLoadErrors: ConfigLoadError[] = []
 7 | 
 8 | export function getConfigLoadErrors(): ConfigLoadError[] {
 9 |   return configLoadErrors
10 | }
11 | 
12 | export function clearConfigLoadErrors(): void {
13 |   configLoadErrors = []
14 | }
15 | 
16 | export function addConfigLoadError(error: ConfigLoadError): void {
17 |   configLoadErrors.push(error)
18 | }
19 | 


--------------------------------------------------------------------------------
/src/tools/delegate-task/sync-task-deps.ts:
--------------------------------------------------------------------------------
 1 | import { createSyncSession } from "./sync-session-creator"
 2 | import { sendSyncPrompt } from "./sync-prompt-sender"
 3 | import { pollSyncSession } from "./sync-session-poller"
 4 | import { fetchSyncResult } from "./sync-result-fetcher"
 5 | 
 6 | export const syncTaskDeps = {
 7 |   createSyncSession,
 8 |   sendSyncPrompt,
 9 |   pollSyncSession,
10 |   fetchSyncResult,
11 | }
12 | 
13 | export type SyncTaskDeps = typeof syncTaskDeps
14 | 


--------------------------------------------------------------------------------
/src/tools/task/index.ts:
--------------------------------------------------------------------------------
1 | export { createTaskCreateTool } from "./task-create"
2 | export { createTaskGetTool } from "./task-get"
3 | export { createTaskList } from "./task-list"
4 | export { createTaskUpdateTool } from "./task-update"
5 | export { syncTaskToTodo, syncAllTasksToTodos } from "./todo-sync"
6 | export type { TaskObject, TaskStatus, TaskCreateInput, TaskListInput, TaskGetInput, TaskUpdateInput, TaskDeleteInput } from "./types"
7 | export type { TodoInfo } from "./todo-sync"
8 | 


--------------------------------------------------------------------------------
/src/features/background-agent/result-handler.ts:
--------------------------------------------------------------------------------
1 | export type { ResultHandlerContext } from "./result-handler-context"
2 | export { formatDuration } from "./duration-formatter"
3 | export { getMessageDir } from "../../shared"
4 | export { checkSessionTodos } from "./session-todo-checker"
5 | export { validateSessionHasOutput } from "./session-output-validator"
6 | export { tryCompleteTask } from "./background-task-completer"
7 | export { notifyParentSession } from "./parent-session-notifier"
8 | 


--------------------------------------------------------------------------------
/src/features/hook-message-injector/index.ts:
--------------------------------------------------------------------------------
 1 | export {
 2 |   injectHookMessage,
 3 |   findNearestMessageWithFields,
 4 |   findFirstMessageWithAgent,
 5 |   findNearestMessageWithFieldsFromSDK,
 6 |   findFirstMessageWithAgentFromSDK,
 7 |   resolveMessageContext,
 8 | } from "./injector"
 9 | export type { StoredMessage } from "./injector"
10 | export type { MessageMeta, OriginalMessageContext, TextPart, ToolPermission } from "./types"
11 | export { MESSAGE_STORAGE } from "./constants"
12 | 


--------------------------------------------------------------------------------
/src/tools/glob/types.ts:
--------------------------------------------------------------------------------
 1 | export interface FileMatch {
 2 |   path: string
 3 |   mtime: number
 4 | }
 5 | 
 6 | export interface GlobResult {
 7 |   files: FileMatch[]
 8 |   totalFiles: number
 9 |   truncated: boolean
10 |   error?: string
11 | }
12 | 
13 | export interface GlobOptions {
14 |   pattern: string
15 |   paths?: string[]
16 |   hidden?: boolean
17 |   follow?: boolean
18 |   noIgnore?: boolean
19 |   maxDepth?: number
20 |   timeout?: number
21 |   limit?: number
22 | }
23 | 


--------------------------------------------------------------------------------
/src/config/schema/claude-code.ts:
--------------------------------------------------------------------------------
 1 | import { z } from "zod"
 2 | 
 3 | export const ClaudeCodeConfigSchema = z.object({
 4 |   mcp: z.boolean().optional(),
 5 |   commands: z.boolean().optional(),
 6 |   skills: z.boolean().optional(),
 7 |   agents: z.boolean().optional(),
 8 |   hooks: z.boolean().optional(),
 9 |   plugins: z.boolean().optional(),
10 |   plugins_override: z.record(z.string(), z.boolean()).optional(),
11 | })
12 | 
13 | export type ClaudeCodeConfig = z.infer<typeof ClaudeCodeConfigSchema>
14 | 


--------------------------------------------------------------------------------
/src/features/mcp-oauth/resource-indicator.ts:
--------------------------------------------------------------------------------
 1 | export function getResourceIndicator(url: string): string {
 2 |   const parsed = new URL(url)
 3 |   parsed.search = ""
 4 |   parsed.hash = ""
 5 | 
 6 |   let normalized = parsed.toString()
 7 |   if (normalized.endsWith("/")) {
 8 |     normalized = normalized.slice(0, -1)
 9 |   }
10 | 
11 |   return normalized
12 | }
13 | 
14 | export function addResourceToParams(params: URLSearchParams, resource: string): void {
15 |   params.set("resource", resource)
16 | }
17 | 


--------------------------------------------------------------------------------
/src/features/opencode-skill-loader/loaded-skill-template-extractor.ts:
--------------------------------------------------------------------------------
 1 | import { readFileSync } from "node:fs"
 2 | import { parseFrontmatter } from "../../shared/frontmatter"
 3 | import type { LoadedSkill } from "./types"
 4 | 
 5 | export function extractSkillTemplate(skill: LoadedSkill): string {
 6 | 	if (skill.path) {
 7 | 		const content = readFileSync(skill.path, "utf-8")
 8 | 		const { body } = parseFrontmatter(content)
 9 | 		return body.trim()
10 | 	}
11 | 	return skill.definition.template || ""
12 | }
13 | 


--------------------------------------------------------------------------------
/src/shared/git-worktree/index.ts:
--------------------------------------------------------------------------------
1 | export type { GitFileStatus, GitFileStat } from "./types"
2 | export type { ParsedGitStatusPorcelainLine } from "./parse-status-porcelain-line"
3 | export { parseGitStatusPorcelainLine } from "./parse-status-porcelain-line"
4 | export { parseGitStatusPorcelain } from "./parse-status-porcelain"
5 | export { parseGitDiffNumstat } from "./parse-diff-numstat"
6 | export { collectGitDiffStats } from "./collect-git-diff-stats"
7 | export { formatFileChanges } from "./format-file-changes"
8 | 


--------------------------------------------------------------------------------
/src/hooks/non-interactive-env/detector.ts:
--------------------------------------------------------------------------------
 1 | export function isNonInteractive(): boolean {
 2 |   if (process.env.CI === "true" || process.env.CI === "1") {
 3 |     return true
 4 |   }
 5 | 
 6 |   if (process.env.OPENCODE_RUN === "true" || process.env.OPENCODE_NON_INTERACTIVE === "true") {
 7 |     return true
 8 |   }
 9 | 
10 |   if (process.env.GITHUB_ACTIONS === "true") {
11 |     return true
12 |   }
13 | 
14 |   if (process.stdout.isTTY !== true) {
15 |     return true
16 |   }
17 | 
18 |   return false
19 | }
20 | 


--------------------------------------------------------------------------------
/src/shared/session-tools-store.ts:
--------------------------------------------------------------------------------
 1 | const store = new Map<string, Record<string, boolean>>()
 2 | 
 3 | export function setSessionTools(sessionID: string, tools: Record<string, boolean>): void {
 4 |   store.set(sessionID, { ...tools })
 5 | }
 6 | 
 7 | export function getSessionTools(sessionID: string): Record<string, boolean> | undefined {
 8 |   const tools = store.get(sessionID)
 9 |   return tools ? { ...tools } : undefined
10 | }
11 | 
12 | export function clearSessionTools(): void {
13 |   store.clear()
14 | }
15 | 


--------------------------------------------------------------------------------
/script/build-schema.ts:
--------------------------------------------------------------------------------
 1 | #!/usr/bin/env bun
 2 | import { createOhMyOpenCodeJsonSchema } from "./build-schema-document"
 3 | 
 4 | const SCHEMA_OUTPUT_PATH = "assets/oh-my-opencode.schema.json"
 5 | 
 6 | async function main() {
 7 |   console.log("Generating JSON Schema...")
 8 | 
 9 |   const finalSchema = createOhMyOpenCodeJsonSchema()
10 | 
11 |   await Bun.write(SCHEMA_OUTPUT_PATH, JSON.stringify(finalSchema, null, 2))
12 | 
13 |   console.log(`✓ JSON Schema generated: ${SCHEMA_OUTPUT_PATH}`)
14 | }
15 | 
16 | main()
17 | 


--------------------------------------------------------------------------------
/src/features/run-continuation-state/types.ts:
--------------------------------------------------------------------------------
 1 | export type ContinuationMarkerSource = "todo" | "stop"
 2 | 
 3 | export type ContinuationMarkerState = "idle" | "active" | "stopped"
 4 | 
 5 | export interface ContinuationMarkerSourceEntry {
 6 |   state: ContinuationMarkerState
 7 |   reason?: string
 8 |   updatedAt: string
 9 | }
10 | 
11 | export interface ContinuationMarker {
12 |   sessionID: string
13 |   updatedAt: string
14 |   sources: Partial<Record<ContinuationMarkerSource, ContinuationMarkerSourceEntry>>
15 | }
16 | 


--------------------------------------------------------------------------------
/src/hooks/think-mode/types.ts:
--------------------------------------------------------------------------------
 1 | export interface ThinkModeState {
 2 |   requested: boolean
 3 |   modelSwitched: boolean
 4 |   thinkingConfigInjected: boolean
 5 |   providerID?: string
 6 |   modelID?: string
 7 | }
 8 | 
 9 | export interface ModelRef {
10 |   providerID: string
11 |   modelID: string
12 | }
13 | 
14 | export interface MessageWithModel {
15 |   model?: ModelRef
16 | }
17 | 
18 | export interface ThinkModeInput {
19 |   parts: Array<{ type: string; text?: string }>
20 |   message: MessageWithModel
21 | }
22 | 


--------------------------------------------------------------------------------
/src/features/opencode-skill-loader/skill-content.ts:
--------------------------------------------------------------------------------
 1 | export type { SkillResolutionOptions } from "./skill-resolution-options"
 2 | 
 3 | export { clearSkillCache, getAllSkills } from "./skill-discovery"
 4 | export { extractSkillTemplate } from "./loaded-skill-template-extractor"
 5 | export { injectGitMasterConfig } from "./git-master-template-injection"
 6 | export {
 7 | 	resolveSkillContent,
 8 | 	resolveMultipleSkills,
 9 | 	resolveSkillContentAsync,
10 | 	resolveMultipleSkillsAsync,
11 | } from "./skill-template-resolver"
12 | 


--------------------------------------------------------------------------------
/src/hooks/claude-code-hooks/session-hook-state.ts:
--------------------------------------------------------------------------------
 1 | export const sessionFirstMessageProcessed = new Set<string>()
 2 | 
 3 | export const sessionErrorState = new Map<string, { hasError: boolean; errorMessage?: string }>()
 4 | 
 5 | export const sessionInterruptState = new Map<string, { interrupted: boolean }>()
 6 | 
 7 | export function clearSessionHookState(sessionID: string): void {
 8 | 	sessionErrorState.delete(sessionID)
 9 | 	sessionInterruptState.delete(sessionID)
10 | 	sessionFirstMessageProcessed.delete(sessionID)
11 | }
12 | 


--------------------------------------------------------------------------------
/src/plugin-handlers/index.ts:
--------------------------------------------------------------------------------
 1 | export { createConfigHandler, type ConfigHandlerDeps } from "./config-handler";
 2 | export * from "./provider-config-handler";
 3 | export * from "./agent-config-handler";
 4 | export * from "./tool-config-handler";
 5 | export * from "./mcp-config-handler";
 6 | export * from "./command-config-handler";
 7 | export * from "./plugin-components-loader";
 8 | export * from "./category-config-resolver";
 9 | export * from "./prometheus-agent-config-builder";
10 | export * from "./agent-priority-order";
11 | 


--------------------------------------------------------------------------------
/src/config/schema/git-master.ts:
--------------------------------------------------------------------------------
 1 | import { z } from "zod"
 2 | 
 3 | export const GitMasterConfigSchema = z.object({
 4 |   /** Add "Ultraworked with Sisyphus" footer to commit messages (default: true). Can be boolean or custom string. */
 5 |   commit_footer: z.union([z.boolean(), z.string()]).default(true),
 6 |   /** Add "Co-authored-by: Sisyphus" trailer to commit messages (default: true) */
 7 |   include_co_authored_by: z.boolean().default(true),
 8 | })
 9 | 
10 | export type GitMasterConfig = z.infer<typeof GitMasterConfigSchema>
11 | 


--------------------------------------------------------------------------------
/src/hooks/interactive-bash-session/constants.ts:
--------------------------------------------------------------------------------
 1 | import { join } from "node:path";
 2 | import { OPENCODE_STORAGE } from "../../shared";
 3 | export const INTERACTIVE_BASH_SESSION_STORAGE = join(
 4 |   OPENCODE_STORAGE,
 5 |   "interactive-bash-session",
 6 | );
 7 | 
 8 | export const OMO_SESSION_PREFIX = "omo-";
 9 | 
10 | export function buildSessionReminderMessage(sessions: string[]): string {
11 |   if (sessions.length === 0) return "";
12 |   return `\n\n[System Reminder] Active omo-* tmux sessions: ${sessions.join(", ")}`;
13 | }
14 | 


--------------------------------------------------------------------------------
/packages/darwin-x64/package.json:
--------------------------------------------------------------------------------
 1 | {
 2 |   "name": "oh-my-opencode-darwin-x64",
 3 |   "version": "3.7.4",
 4 |   "description": "Platform-specific binary for oh-my-opencode (darwin-x64)",
 5 |   "license": "MIT",
 6 |   "repository": {
 7 |     "type": "git",
 8 |     "url": "https://github.com/code-yeongyu/oh-my-opencode"
 9 |   },
10 |   "os": [
11 |     "darwin"
12 |   ],
13 |   "cpu": [
14 |     "x64"
15 |   ],
16 |   "files": [
17 |     "bin"
18 |   ],
19 |   "bin": {
20 |     "oh-my-opencode": "./bin/oh-my-opencode"
21 |   }
22 | }
23 | 


--------------------------------------------------------------------------------
/src/hooks/anthropic-context-window-limit-recovery/index.ts:
--------------------------------------------------------------------------------
1 | export { createAnthropicContextWindowLimitRecoveryHook } from "./recovery-hook"
2 | export type { AnthropicContextWindowLimitRecoveryOptions } from "./recovery-hook"
3 | export type { AutoCompactState, ParsedTokenLimitError, TruncateState } from "./types"
4 | export { parseAnthropicTokenLimitError } from "./parser"
5 | export { executeCompact, getLastAssistant } from "./executor"
6 | export * from "./state"
7 | export * from "./message-builder"
8 | export * from "./recovery-strategy"
9 | 


--------------------------------------------------------------------------------
/packages/darwin-arm64/package.json:
--------------------------------------------------------------------------------
 1 | {
 2 |   "name": "oh-my-opencode-darwin-arm64",
 3 |   "version": "3.7.4",
 4 |   "description": "Platform-specific binary for oh-my-opencode (darwin-arm64)",
 5 |   "license": "MIT",
 6 |   "repository": {
 7 |     "type": "git",
 8 |     "url": "https://github.com/code-yeongyu/oh-my-opencode"
 9 |   },
10 |   "os": [
11 |     "darwin"
12 |   ],
13 |   "cpu": [
14 |     "arm64"
15 |   ],
16 |   "files": [
17 |     "bin"
18 |   ],
19 |   "bin": {
20 |     "oh-my-opencode": "./bin/oh-my-opencode"
21 |   }
22 | }
23 | 


--------------------------------------------------------------------------------
/packages/windows-x64/package.json:
--------------------------------------------------------------------------------
 1 | {
 2 |   "name": "oh-my-opencode-windows-x64",
 3 |   "version": "3.7.4",
 4 |   "description": "Platform-specific binary for oh-my-opencode (windows-x64)",
 5 |   "license": "MIT",
 6 |   "repository": {
 7 |     "type": "git",
 8 |     "url": "https://github.com/code-yeongyu/oh-my-opencode"
 9 |   },
10 |   "os": [
11 |     "win32"
12 |   ],
13 |   "cpu": [
14 |     "x64"
15 |   ],
16 |   "files": [
17 |     "bin"
18 |   ],
19 |   "bin": {
20 |     "oh-my-opencode": "./bin/oh-my-opencode.exe"
21 |   }
22 | }
23 | 


--------------------------------------------------------------------------------
/src/features/background-agent/duration-formatter.ts:
--------------------------------------------------------------------------------
 1 | export function formatDuration(start: Date, end?: Date): string {
 2 |   const duration = (end ?? new Date()).getTime() - start.getTime()
 3 |   const seconds = Math.floor(duration / 1000)
 4 |   const minutes = Math.floor(seconds / 60)
 5 |   const hours = Math.floor(minutes / 60)
 6 | 
 7 |   if (hours > 0) {
 8 |     return `${hours}h ${minutes % 60}m ${seconds % 60}s`
 9 |   }
10 |   if (minutes > 0) {
11 |     return `${minutes}m ${seconds % 60}s`
12 |   }
13 |   return `${seconds}s`
14 | }
15 | 


--------------------------------------------------------------------------------
/src/features/background-agent/format-duration.ts:
--------------------------------------------------------------------------------
 1 | export function formatDuration(start: Date, end?: Date): string {
 2 |   const duration = (end ?? new Date()).getTime() - start.getTime()
 3 |   const seconds = Math.floor(duration / 1000)
 4 |   const minutes = Math.floor(seconds / 60)
 5 |   const hours = Math.floor(minutes / 60)
 6 | 
 7 |   if (hours > 0) {
 8 |     return `${hours}h ${minutes % 60}m ${seconds % 60}s`
 9 |   }
10 |   if (minutes > 0) {
11 |     return `${minutes}m ${seconds % 60}s`
12 |   }
13 |   return `${seconds}s`
14 | }
15 | 


--------------------------------------------------------------------------------
/src/features/background-agent/spawner/spawner-context.ts:
--------------------------------------------------------------------------------
 1 | import type { BackgroundTask } from "../types"
 2 | import type { ConcurrencyManager } from "../concurrency"
 3 | import type { OpencodeClient, OnSubagentSessionCreated } from "../constants"
 4 | 
 5 | export interface SpawnerContext {
 6 |   client: OpencodeClient
 7 |   directory: string
 8 |   concurrencyManager: ConcurrencyManager
 9 |   tmuxEnabled: boolean
10 |   onSubagentSessionCreated?: OnSubagentSessionCreated
11 |   onTaskError: (task: BackgroundTask, error: Error) => void
12 | }
13 | 


--------------------------------------------------------------------------------
/src/tools/call-omo-agent/constants.ts:
--------------------------------------------------------------------------------
 1 | export const ALLOWED_AGENTS = [
 2 |   "explore",
 3 |   "librarian",
 4 |   "oracle",
 5 |   "hephaestus",
 6 |   "metis",
 7 |   "momus",
 8 |   "multimodal-looker",
 9 | ] as const
10 | 
11 | export const CALL_OMO_AGENT_DESCRIPTION = `Spawn explore/librarian agent. run_in_background REQUIRED (true=async with task_id, false=sync).
12 | 
13 | Available: {agents}
14 | 
15 | Pass \`session_id=<id>\` to continue previous agent with full context. Prompts MUST be in English. Use \`background_output\` for async results.`
16 | 


--------------------------------------------------------------------------------
/src/cli/provider-model-id-transform.ts:
--------------------------------------------------------------------------------
 1 | export function transformModelForProvider(provider: string, model: string): string {
 2 | 	if (provider === "github-copilot") {
 3 | 		return model
 4 | 			.replace("claude-opus-4-6", "claude-opus-4.6")
 5 | 			.replace("claude-sonnet-4-6", "claude-sonnet-4.6")
 6 | 			.replace("claude-haiku-4-5", "claude-haiku-4.5")
 7 | 			.replace("claude-sonnet-4", "claude-sonnet-4")
 8 | 			.replace("gemini-3-pro", "gemini-3-pro-preview")
 9 | 			.replace("gemini-3-flash", "gemini-3-flash-preview")
10 | 	}
11 | 	return model
12 | }
13 | 


--------------------------------------------------------------------------------
/src/cli/run/index.ts:
--------------------------------------------------------------------------------
 1 | export { run } from "./runner"
 2 | export { resolveRunAgent } from "./agent-resolver"
 3 | export { createServerConnection } from "./server-connection"
 4 | export { resolveSession } from "./session-resolver"
 5 | export { createJsonOutputManager } from "./json-output"
 6 | export { executeOnCompleteHook } from "./on-complete-hook"
 7 | export { createEventState, processEvents, serializeError } from "./events"
 8 | export type { EventState } from "./events"
 9 | export type { RunOptions, RunContext, RunResult, ServerConnection } from "./types"
10 | 


--------------------------------------------------------------------------------
/src/shared/hook-disabled.ts:
--------------------------------------------------------------------------------
 1 | import type { ClaudeHookEvent, PluginConfig } from "../hooks/claude-code-hooks/types"
 2 | 
 3 | export function isHookDisabled(
 4 |   config: PluginConfig,
 5 |   hookType: ClaudeHookEvent
 6 | ): boolean {
 7 |   const { disabledHooks } = config
 8 | 
 9 |   if (disabledHooks === undefined) {
10 |     return false
11 |   }
12 | 
13 |   if (disabledHooks === true) {
14 |     return true
15 |   }
16 | 
17 |   if (Array.isArray(disabledHooks)) {
18 |     return disabledHooks.includes(hookType)
19 |   }
20 | 
21 |   return false
22 | }
23 | 


--------------------------------------------------------------------------------
/src/shared/tmux/constants.ts:
--------------------------------------------------------------------------------
 1 | // Polling interval for background session status checks
 2 | export const POLL_INTERVAL_BACKGROUND_MS = 2000
 3 | 
 4 | // Maximum idle time before session considered stale
 5 | export const SESSION_TIMEOUT_MS = 10 * 60 * 1000  // 10 minutes
 6 | 
 7 | // Grace period for missing session before cleanup
 8 | export const SESSION_MISSING_GRACE_MS = 6000  // 6 seconds
 9 | 
10 | // Session readiness polling config
11 | export const SESSION_READY_POLL_INTERVAL_MS = 500
12 | export const SESSION_READY_TIMEOUT_MS = 10_000  // 10 seconds max wait
13 | 


--------------------------------------------------------------------------------
/packages/darwin-x64-baseline/package.json:
--------------------------------------------------------------------------------
 1 | {
 2 |   "name": "oh-my-opencode-darwin-x64-baseline",
 3 |   "version": "3.1.1",
 4 |   "description": "Platform-specific binary for oh-my-opencode (darwin-x64-baseline, no AVX2)",
 5 |   "license": "MIT",
 6 |   "repository": {
 7 |     "type": "git",
 8 |     "url": "https://github.com/code-yeongyu/oh-my-opencode"
 9 |   },
10 |   "os": [
11 |     "darwin"
12 |   ],
13 |   "cpu": [
14 |     "x64"
15 |   ],
16 |   "files": [
17 |     "bin"
18 |   ],
19 |   "bin": {
20 |     "oh-my-opencode": "./bin/oh-my-opencode"
21 |   }
22 | }
23 | 


--------------------------------------------------------------------------------
/src/cli/index.test.ts:
--------------------------------------------------------------------------------
 1 | import { describe, it, expect } from "bun:test"
 2 | import packageJson from "../../package.json" with { type: "json" }
 3 | 
 4 | describe("CLI version", () => {
 5 |   it("reads version from package.json as valid semver", () => {
 6 |     // given
 7 |     const semverRegex = /^\d+\.\d+\.\d+(-[\w.]+)?$/
 8 | 
 9 |     // when
10 |     const version = packageJson.version
11 | 
12 |     // then
13 |     expect(version).toMatch(semverRegex)
14 |     expect(typeof version).toBe("string")
15 |     expect(version.length).toBeGreaterThan(0)
16 |   })
17 | })
18 | 


--------------------------------------------------------------------------------
/packages/linux-x64/package.json:
--------------------------------------------------------------------------------
 1 | {
 2 |   "name": "oh-my-opencode-linux-x64",
 3 |   "version": "3.7.4",
 4 |   "description": "Platform-specific binary for oh-my-opencode (linux-x64)",
 5 |   "license": "MIT",
 6 |   "repository": {
 7 |     "type": "git",
 8 |     "url": "https://github.com/code-yeongyu/oh-my-opencode"
 9 |   },
10 |   "os": [
11 |     "linux"
12 |   ],
13 |   "cpu": [
14 |     "x64"
15 |   ],
16 |   "libc": [
17 |     "glibc"
18 |   ],
19 |   "files": [
20 |     "bin"
21 |   ],
22 |   "bin": {
23 |     "oh-my-opencode": "./bin/oh-my-opencode"
24 |   }
25 | }
26 | 


--------------------------------------------------------------------------------
/packages/windows-x64-baseline/package.json:
--------------------------------------------------------------------------------
 1 | {
 2 |   "name": "oh-my-opencode-windows-x64-baseline",
 3 |   "version": "3.1.1",
 4 |   "description": "Platform-specific binary for oh-my-opencode (windows-x64-baseline, no AVX2)",
 5 |   "license": "MIT",
 6 |   "repository": {
 7 |     "type": "git",
 8 |     "url": "https://github.com/code-yeongyu/oh-my-opencode"
 9 |   },
10 |   "os": [
11 |     "win32"
12 |   ],
13 |   "cpu": [
14 |     "x64"
15 |   ],
16 |   "files": [
17 |     "bin"
18 |   ],
19 |   "bin": {
20 |     "oh-my-opencode": "./bin/oh-my-opencode.exe"
21 |   }
22 | }
23 | 


--------------------------------------------------------------------------------
/src/hooks/ralph-loop/types.ts:
--------------------------------------------------------------------------------
 1 | import type { RalphLoopConfig } from "../../config"
 2 | 
 3 | export interface RalphLoopState {
 4 |   active: boolean
 5 |   iteration: number
 6 |   max_iterations: number
 7 |   completion_promise: string
 8 |   started_at: string
 9 |   prompt: string
10 |   session_id?: string
11 |   ultrawork?: boolean
12 | }
13 | 
14 | export interface RalphLoopOptions {
15 |   config?: RalphLoopConfig
16 |   getTranscriptPath?: (sessionId: string) => string
17 |   apiTimeout?: number
18 |   checkSessionExists?: (sessionId: string) => Promise<boolean>
19 | }
20 | 


--------------------------------------------------------------------------------
/src/shared/git-worktree/parse-status-porcelain.ts:
--------------------------------------------------------------------------------
 1 | import type { GitFileStatus } from "./types"
 2 | import { parseGitStatusPorcelainLine } from "./parse-status-porcelain-line"
 3 | 
 4 | export function parseGitStatusPorcelain(output: string): Map<string, GitFileStatus> {
 5 |   const map = new Map<string, GitFileStatus>()
 6 |   if (!output) return map
 7 | 
 8 |   for (const line of output.split("\n")) {
 9 |     const parsed = parseGitStatusPorcelainLine(line)
10 |     if (!parsed) continue
11 |     map.set(parsed.filePath, parsed.status)
12 |   }
13 | 
14 |   return map
15 | }
16 | 


--------------------------------------------------------------------------------
/packages/linux-arm64/package.json:
--------------------------------------------------------------------------------
 1 | {
 2 |   "name": "oh-my-opencode-linux-arm64",
 3 |   "version": "3.7.4",
 4 |   "description": "Platform-specific binary for oh-my-opencode (linux-arm64)",
 5 |   "license": "MIT",
 6 |   "repository": {
 7 |     "type": "git",
 8 |     "url": "https://github.com/code-yeongyu/oh-my-opencode"
 9 |   },
10 |   "os": [
11 |     "linux"
12 |   ],
13 |   "cpu": [
14 |     "arm64"
15 |   ],
16 |   "libc": [
17 |     "glibc"
18 |   ],
19 |   "files": [
20 |     "bin"
21 |   ],
22 |   "bin": {
23 |     "oh-my-opencode": "./bin/oh-my-opencode"
24 |   }
25 | }
26 | 


--------------------------------------------------------------------------------
/src/hooks/ralph-loop/with-timeout.ts:
--------------------------------------------------------------------------------
 1 | export async function withTimeout<TData>(
 2 | 	promise: Promise<TData>,
 3 | 	timeoutMs: number,
 4 | ): Promise<TData> {
 5 | 	let timeoutId: ReturnType<typeof setTimeout> | undefined
 6 | 
 7 | 	const timeoutPromise = new Promise<never>((_, reject) => {
 8 | 		timeoutId = setTimeout(() => {
 9 | 			reject(new Error("API timeout"))
10 | 		}, timeoutMs)
11 | 	})
12 | 
13 | 	try {
14 | 		return await Promise.race([promise, timeoutPromise])
15 | 	} finally {
16 | 		if (timeoutId !== undefined) {
17 | 			clearTimeout(timeoutId)
18 | 		}
19 | 	}
20 | }
21 | 


--------------------------------------------------------------------------------
/src/tools/delegate-task/time-formatter.ts:
--------------------------------------------------------------------------------
 1 | /**
 2 |  * Format a duration between two dates as a human-readable string.
 3 |  */
 4 | export function formatDuration(start: Date, end?: Date): string {
 5 |   const duration = (end ?? new Date()).getTime() - start.getTime()
 6 |   const seconds = Math.floor(duration / 1000)
 7 |   const minutes = Math.floor(seconds / 60)
 8 |   const hours = Math.floor(minutes / 60)
 9 | 
10 |   if (hours > 0) return `${hours}h ${minutes % 60}m ${seconds % 60}s`
11 |   if (minutes > 0) return `${minutes}m ${seconds % 60}s`
12 |   return `${seconds}s`
13 | }
14 | 


--------------------------------------------------------------------------------
/packages/linux-x64-musl/package.json:
--------------------------------------------------------------------------------
 1 | {
 2 |   "name": "oh-my-opencode-linux-x64-musl",
 3 |   "version": "3.7.4",
 4 |   "description": "Platform-specific binary for oh-my-opencode (linux-x64-musl)",
 5 |   "license": "MIT",
 6 |   "repository": {
 7 |     "type": "git",
 8 |     "url": "https://github.com/code-yeongyu/oh-my-opencode"
 9 |   },
10 |   "os": [
11 |     "linux"
12 |   ],
13 |   "cpu": [
14 |     "x64"
15 |   ],
16 |   "libc": [
17 |     "musl"
18 |   ],
19 |   "files": [
20 |     "bin"
21 |   ],
22 |   "bin": {
23 |     "oh-my-opencode": "./bin/oh-my-opencode"
24 |   }
25 | }
26 | 


--------------------------------------------------------------------------------
/src/hooks/auto-update-checker/checker.ts:
--------------------------------------------------------------------------------
1 | export { isLocalDevMode, getLocalDevPath } from "./checker/local-dev-path"
2 | export { getLocalDevVersion } from "./checker/local-dev-version"
3 | export { findPluginEntry } from "./checker/plugin-entry"
4 | export type { PluginEntryInfo } from "./checker/plugin-entry"
5 | export { getCachedVersion } from "./checker/cached-version"
6 | export { updatePinnedVersion, revertPinnedVersion } from "./checker/pinned-version-updater"
7 | export { getLatestVersion } from "./checker/latest-version"
8 | export { checkForUpdate } from "./checker/check-for-update"
9 | 


--------------------------------------------------------------------------------
/src/tools/background-task/constants.ts:
--------------------------------------------------------------------------------
1 | export const BACKGROUND_TASK_DESCRIPTION = `Run agent task in background. Returns task_id immediately; notifies on completion.
2 | 
3 | Use \`background_output\` to get results. Prompts MUST be in English.`
4 | 
5 | export const BACKGROUND_OUTPUT_DESCRIPTION = `Get output from background task. Use full_session=true to fetch session messages with filters. System notifies on completion, so block=true rarely needed.`
6 | 
7 | export const BACKGROUND_CANCEL_DESCRIPTION = `Cancel running background task(s). Use all=true to cancel ALL before final answer.`
8 | 


--------------------------------------------------------------------------------
/src/tools/hashline-edit/types.ts:
--------------------------------------------------------------------------------
 1 | export interface SetLine {
 2 |   type: "set_line"
 3 |   line: string
 4 |   text: string
 5 | }
 6 | 
 7 | export interface ReplaceLines {
 8 |   type: "replace_lines"
 9 |   start_line: string
10 |   end_line: string
11 |   text: string
12 | }
13 | 
14 | export interface InsertAfter {
15 |   type: "insert_after"
16 |   line: string
17 |   text: string
18 | }
19 | 
20 | export interface Replace {
21 |   type: "replace"
22 |   old_text: string
23 |   new_text: string
24 | }
25 | 
26 | export type HashlineEdit = SetLine | ReplaceLines | InsertAfter | Replace
27 | 


--------------------------------------------------------------------------------
/src/agents/prometheus/index.ts:
--------------------------------------------------------------------------------
 1 | export { PROMETHEUS_SYSTEM_PROMPT, PROMETHEUS_PERMISSION } from "./system-prompt"
 2 | 
 3 | // Re-export individual sections for granular access
 4 | export { PROMETHEUS_IDENTITY_CONSTRAINTS } from "./identity-constraints"
 5 | export { PROMETHEUS_INTERVIEW_MODE } from "./interview-mode"
 6 | export { PROMETHEUS_PLAN_GENERATION } from "./plan-generation"
 7 | export { PROMETHEUS_HIGH_ACCURACY_MODE } from "./high-accuracy-mode"
 8 | export { PROMETHEUS_PLAN_TEMPLATE } from "./plan-template"
 9 | export { PROMETHEUS_BEHAVIORAL_SUMMARY } from "./behavioral-summary"
10 | 


--------------------------------------------------------------------------------
/src/shared/safe-create-hook.ts:
--------------------------------------------------------------------------------
 1 | import { log } from "./logger"
 2 | 
 3 | interface SafeCreateHookOptions {
 4 |   enabled?: boolean
 5 | }
 6 | 
 7 | export function safeCreateHook<T>(
 8 |   name: string,
 9 |   factory: () => T,
10 |   options?: SafeCreateHookOptions,
11 | ): T | null {
12 |   const enabled = options?.enabled ?? true
13 | 
14 |   if (!enabled) {
15 |     return factory() ?? null
16 |   }
17 | 
18 |   try {
19 |     return factory() ?? null
20 |   } catch (error) {
21 |     log(`[safe-create-hook] Hook creation failed: ${name}`, { error })
22 |     return null
23 |   }
24 | }
25 | 


--------------------------------------------------------------------------------
/packages/linux-arm64-musl/package.json:
--------------------------------------------------------------------------------
 1 | {
 2 |   "name": "oh-my-opencode-linux-arm64-musl",
 3 |   "version": "3.7.4",
 4 |   "description": "Platform-specific binary for oh-my-opencode (linux-arm64-musl)",
 5 |   "license": "MIT",
 6 |   "repository": {
 7 |     "type": "git",
 8 |     "url": "https://github.com/code-yeongyu/oh-my-opencode"
 9 |   },
10 |   "os": [
11 |     "linux"
12 |   ],
13 |   "cpu": [
14 |     "arm64"
15 |   ],
16 |   "libc": [
17 |     "musl"
18 |   ],
19 |   "files": [
20 |     "bin"
21 |   ],
22 |   "bin": {
23 |     "oh-my-opencode": "./bin/oh-my-opencode"
24 |   }
25 | }
26 | 


--------------------------------------------------------------------------------
/src/config/schema/websearch.ts:
--------------------------------------------------------------------------------
 1 | import { z } from "zod"
 2 | 
 3 | export const WebsearchProviderSchema = z.enum(["exa", "tavily"])
 4 | 
 5 | export const WebsearchConfigSchema = z.object({
 6 |   /**
 7 |    * Websearch provider to use.
 8 |    * - "exa": Uses Exa websearch (default, works without API key)
 9 |    * - "tavily": Uses Tavily websearch (requires TAVILY_API_KEY)
10 |    */
11 |   provider: WebsearchProviderSchema.optional(),
12 | })
13 | 
14 | export type WebsearchProvider = z.infer<typeof WebsearchProviderSchema>
15 | export type WebsearchConfig = z.infer<typeof WebsearchConfigSchema>
16 | 


--------------------------------------------------------------------------------
/src/plugin-handlers/agent-key-remapper.ts:
--------------------------------------------------------------------------------
 1 | import { AGENT_DISPLAY_NAMES } from "../shared/agent-display-names"
 2 | 
 3 | export function remapAgentKeysToDisplayNames(
 4 |   agents: Record<string, unknown>,
 5 | ): Record<string, unknown> {
 6 |   const result: Record<string, unknown> = {}
 7 | 
 8 |   for (const [key, value] of Object.entries(agents)) {
 9 |     const displayName = AGENT_DISPLAY_NAMES[key]
10 |     if (displayName && displayName !== key) {
11 |       result[displayName] = value
12 |     } else {
13 |       result[key] = value
14 |     }
15 |   }
16 | 
17 |   return result
18 | }
19 | 


--------------------------------------------------------------------------------
/src/agents/atlas/index.ts:
--------------------------------------------------------------------------------
 1 | export { ATLAS_SYSTEM_PROMPT, getDefaultAtlasPrompt } from "./default"
 2 | export { ATLAS_GPT_SYSTEM_PROMPT, getGptAtlasPrompt } from "./gpt"
 3 | export {
 4 |   getCategoryDescription,
 5 |   buildAgentSelectionSection,
 6 |   buildCategorySection,
 7 |   buildSkillsSection,
 8 |   buildDecisionMatrix,
 9 | } from "./prompt-section-builder"
10 | 
11 | export { createAtlasAgent, getAtlasPromptSource, getAtlasPrompt, atlasPromptMetadata } from "./agent"
12 | export type { AtlasPromptSource, OrchestratorContext } from "./agent"
13 | 
14 | export { isGptModel } from "../types"
15 | 


--------------------------------------------------------------------------------
/src/config/schema/ralph-loop.ts:
--------------------------------------------------------------------------------
 1 | import { z } from "zod"
 2 | 
 3 | export const RalphLoopConfigSchema = z.object({
 4 |   /** Enable ralph loop functionality (default: false - opt-in feature) */
 5 |   enabled: z.boolean().default(false),
 6 |   /** Default max iterations if not specified in command (default: 100) */
 7 |   default_max_iterations: z.number().min(1).max(1000).default(100),
 8 |   /** Custom state file directory relative to project root (default: .opencode/) */
 9 |   state_dir: z.string().optional(),
10 | })
11 | 
12 | export type RalphLoopConfig = z.infer<typeof RalphLoopConfigSchema>
13 | 


--------------------------------------------------------------------------------
/src/features/opencode-skill-loader/skill-definition-record.ts:
--------------------------------------------------------------------------------
 1 | import type { CommandDefinition } from "../claude-code-command-loader/types"
 2 | import type { LoadedSkill } from "./types"
 3 | 
 4 | export function skillsToCommandDefinitionRecord(skills: LoadedSkill[]): Record<string, CommandDefinition> {
 5 |   const result: Record<string, CommandDefinition> = {}
 6 |   for (const skill of skills) {
 7 |     const { name: _name, argumentHint: _argumentHint, ...openCodeCompatible } = skill.definition
 8 |     result[skill.name] = openCodeCompatible as CommandDefinition
 9 |   }
10 |   return result
11 | }
12 | 


--------------------------------------------------------------------------------
/src/tools/hashline-edit/index.ts:
--------------------------------------------------------------------------------
 1 | export { computeLineHash, formatHashLine, formatHashLines } from "./hash-computation"
 2 | export { parseLineRef, validateLineRef } from "./validation"
 3 | export type { LineRef } from "./validation"
 4 | export type { SetLine, ReplaceLines, InsertAfter, Replace, HashlineEdit } from "./types"
 5 | export { HASH_DICT, HASHLINE_PATTERN } from "./constants"
 6 | export {
 7 |   applyHashlineEdits,
 8 |   applyInsertAfter,
 9 |   applyReplace,
10 |   applyReplaceLines,
11 |   applySetLine,
12 | } from "./edit-operations"
13 | export { createHashlineEditTool } from "./tools"
14 | 


--------------------------------------------------------------------------------
/.github/workflows/lint-workflows.yml:
--------------------------------------------------------------------------------
 1 | name: Lint Workflows
 2 | 
 3 | on:
 4 |   push:
 5 |     paths:
 6 |       - '.github/workflows/**'
 7 |   pull_request:
 8 |     paths:
 9 |       - '.github/workflows/**'
10 | 
11 | jobs:
12 |   actionlint:
13 |     runs-on: ubuntu-latest
14 |     steps:
15 |       - uses: actions/checkout@v5
16 | 
17 |       - name: Install actionlint
18 |         run: |
19 |           bash <(curl -sSL https://raw.githubusercontent.com/rhysd/actionlint/v1.7.10/scripts/download-actionlint.bash)
20 | 
21 |       - name: Run actionlint
22 |         run: ./actionlint -color -shellcheck=""
23 | 


--------------------------------------------------------------------------------
/tsconfig.json:
--------------------------------------------------------------------------------
 1 | {
 2 |   "compilerOptions": {
 3 |     "target": "ESNext",
 4 |     "module": "ESNext",
 5 |     "moduleResolution": "bundler",
 6 |     "declaration": true,
 7 |     "declarationDir": "dist",
 8 |     "outDir": "dist",
 9 |     "rootDir": "src",
10 |     "strict": true,
11 |     "esModuleInterop": true,
12 |     "skipLibCheck": true,
13 |     "forceConsistentCasingInFileNames": true,
14 |     "resolveJsonModule": true,
15 |     "lib": ["ESNext"],
16 |     "types": ["bun-types"]
17 |   },
18 |   "include": ["src/**/*"],
19 |   "exclude": ["node_modules", "dist", "**/*.test.ts", "script"]
20 | }
21 | 


--------------------------------------------------------------------------------
/packages/linux-x64-baseline/package.json:
--------------------------------------------------------------------------------
 1 | {
 2 |   "name": "oh-my-opencode-linux-x64-baseline",
 3 |   "version": "3.1.1",
 4 |   "description": "Platform-specific binary for oh-my-opencode (linux-x64-baseline, no AVX2)",
 5 |   "license": "MIT",
 6 |   "repository": {
 7 |     "type": "git",
 8 |     "url": "https://github.com/code-yeongyu/oh-my-opencode"
 9 |   },
10 |   "os": [
11 |     "linux"
12 |   ],
13 |   "cpu": [
14 |     "x64"
15 |   ],
16 |   "libc": [
17 |     "glibc"
18 |   ],
19 |   "files": [
20 |     "bin"
21 |   ],
22 |   "bin": {
23 |     "oh-my-opencode": "./bin/oh-my-opencode"
24 |   }
25 | }
26 | 


--------------------------------------------------------------------------------
/src/hooks/anthropic-context-window-limit-recovery/storage.ts:
--------------------------------------------------------------------------------
 1 | export type { AggressiveTruncateResult, ToolResultInfo } from "./tool-part-types"
 2 | 
 3 | export {
 4 | 	countTruncatedResults,
 5 | 	findLargestToolResult,
 6 | 	findToolResultsBySize,
 7 | 	getTotalToolOutputSize,
 8 | 	truncateToolResult,
 9 | } from "./tool-result-storage"
10 | 
11 | export {
12 | 	countTruncatedResultsFromSDK,
13 | 	findToolResultsBySizeFromSDK,
14 | 	getTotalToolOutputSizeFromSDK,
15 | 	truncateToolResultAsync,
16 | } from "./tool-result-storage-sdk"
17 | 
18 | export { truncateUntilTargetTokens } from "./target-token-truncation"
19 | 


--------------------------------------------------------------------------------
/.gitignore:
--------------------------------------------------------------------------------
 1 | # Dependencies
 2 | .sisyphus/*
 3 | !.sisyphus/rules/
 4 | node_modules/
 5 | 
 6 | # Build output
 7 | dist/
 8 | 
 9 | # Platform binaries (built, not committed)
10 | packages/*/bin/oh-my-opencode
11 | packages/*/bin/oh-my-opencode.exe
12 | 
13 | # IDE
14 | .idea/
15 | .vscode/
16 | *.swp
17 | *.swo
18 | 
19 | # OS
20 | .DS_Store
21 | Thumbs.db
22 | 
23 | # Logs
24 | *.log
25 | npm-debug.log*
26 | 
27 | # Lock files (use bun.lockb instead)
28 | package-lock.json
29 | yarn.lock
30 | 
31 | # Environment
32 | .env
33 | .env.local
34 | test-injection/
35 | notepad.md
36 | oauth-success.html
37 | *.bun-build
38 | 


--------------------------------------------------------------------------------
/src/features/tmux-subagent/index.ts:
--------------------------------------------------------------------------------
 1 | export * from "./manager"
 2 | export * from "./event-handlers"
 3 | export * from "./polling"
 4 | export * from "./cleanup"
 5 | export * from "./session-created-event"
 6 | export * from "./session-created-handler"
 7 | export * from "./session-deleted-handler"
 8 | export * from "./polling-constants"
 9 | export * from "./session-status-parser"
10 | export * from "./session-message-count"
11 | export * from "./session-ready-waiter"
12 | export * from "./types"
13 | export * from "./pane-state-querier"
14 | export * from "./decision-engine"
15 | export * from "./action-executor"
16 | 


--------------------------------------------------------------------------------
/src/shared/logger.ts:
--------------------------------------------------------------------------------
 1 | // Shared logging utility for the plugin
 2 | 
 3 | import * as fs from "fs"
 4 | import * as os from "os"
 5 | import * as path from "path"
 6 | 
 7 | const logFile = path.join(os.tmpdir(), "oh-my-opencode.log")
 8 | 
 9 | export function log(message: string, data?: unknown): void {
10 |   try {
11 |     const timestamp = new Date().toISOString()
12 |     const logEntry = `[${timestamp}] ${message} ${data ? JSON.stringify(data) : ""}\n`
13 |     fs.appendFileSync(logFile, logEntry)
14 |   } catch {
15 |   }
16 | }
17 | 
18 | export function getLogFilePath(): string {
19 |   return logFile
20 | }
21 | 


--------------------------------------------------------------------------------
/src/tools/interactive-bash/constants.ts:
--------------------------------------------------------------------------------
 1 | export const DEFAULT_TIMEOUT_MS = 60_000
 2 | 
 3 | export const BLOCKED_TMUX_SUBCOMMANDS = [
 4 |   "capture-pane",
 5 |   "capturep",
 6 |   "save-buffer",
 7 |   "saveb",
 8 |   "show-buffer",
 9 |   "showb",
10 |   "pipe-pane",
11 |   "pipep",
12 | ]
13 | 
14 | export const INTERACTIVE_BASH_DESCRIPTION = `WARNING: This is TMUX ONLY. Pass tmux subcommands directly (without 'tmux' prefix).
15 | 
16 | Examples: new-session -d -s omo-dev, send-keys -t omo-dev "vim" Enter
17 | 
18 | For TUI apps needing ongoing interaction (vim, htop, pudb). One-shot commands → use Bash with &.`
19 | 


--------------------------------------------------------------------------------
/packages/linux-x64-musl-baseline/package.json:
--------------------------------------------------------------------------------
 1 | {
 2 |   "name": "oh-my-opencode-linux-x64-musl-baseline",
 3 |   "version": "3.1.1",
 4 |   "description": "Platform-specific binary for oh-my-opencode (linux-x64-musl-baseline, no AVX2)",
 5 |   "license": "MIT",
 6 |   "repository": {
 7 |     "type": "git",
 8 |     "url": "https://github.com/code-yeongyu/oh-my-opencode"
 9 |   },
10 |   "os": [
11 |     "linux"
12 |   ],
13 |   "cpu": [
14 |     "x64"
15 |   ],
16 |   "libc": [
17 |     "musl"
18 |   ],
19 |   "files": [
20 |     "bin"
21 |   ],
22 |   "bin": {
23 |     "oh-my-opencode": "./bin/oh-my-opencode"
24 |   }
25 | }
26 | 


--------------------------------------------------------------------------------
/src/plugin/types.ts:
--------------------------------------------------------------------------------
 1 | import type { Plugin, ToolDefinition } from "@opencode-ai/plugin"
 2 | 
 3 | export type PluginContext = Parameters<Plugin>[0]
 4 | export type PluginInstance = Awaited<ReturnType<Plugin>>
 5 | export type PluginInterface = Omit<PluginInstance, "experimental.session.compacting"> 
 6 | 
 7 | export type ToolsRecord = Record<string, ToolDefinition>
 8 | 
 9 | export type TmuxConfig = {
10 |   enabled: boolean
11 |   layout: "main-horizontal" | "main-vertical" | "tiled" | "even-horizontal" | "even-vertical"
12 |   main_pane_size: number
13 |   main_pane_min_width: number
14 |   agent_pane_min_width: number
15 | }
16 | 


--------------------------------------------------------------------------------
/src/hooks/anthropic-context-window-limit-recovery/client.ts:
--------------------------------------------------------------------------------
 1 | import type { PluginInput } from "@opencode-ai/plugin"
 2 | 
 3 | export type Client = PluginInput["client"] & {
 4 |   session: {
 5 |     promptAsync: (opts: {
 6 |       path: { id: string }
 7 |       body: { parts: Array<{ type: string; text: string }> }
 8 |       query: { directory: string }
 9 |     }) => Promise<unknown>
10 |   }
11 |   tui: {
12 |     showToast: (opts: {
13 |       body: {
14 |         title: string
15 |         message: string
16 |         variant: string
17 |         duration: number
18 |       }
19 |     }) => Promise<unknown>
20 |   }
21 | }
22 | 


--------------------------------------------------------------------------------
/src/cli/config-manager/opencode-config-format.ts:
--------------------------------------------------------------------------------
 1 | import { existsSync } from "node:fs"
 2 | import { getConfigJson, getConfigJsonc } from "./config-context"
 3 | 
 4 | export type ConfigFormat = "json" | "jsonc" | "none"
 5 | 
 6 | export function detectConfigFormat(): { format: ConfigFormat; path: string } {
 7 |   const configJsonc = getConfigJsonc()
 8 |   const configJson = getConfigJson()
 9 | 
10 |   if (existsSync(configJsonc)) {
11 |     return { format: "jsonc", path: configJsonc }
12 |   }
13 |   if (existsSync(configJson)) {
14 |     return { format: "json", path: configJson }
15 |   }
16 |   return { format: "none", path: configJson }
17 | }
18 | 


--------------------------------------------------------------------------------
/src/features/builtin-commands/templates/stop-continuation.ts:
--------------------------------------------------------------------------------
 1 | export const STOP_CONTINUATION_TEMPLATE = `Stop all continuation mechanisms for the current session.
 2 | 
 3 | This command will:
 4 | 1. Stop the todo-continuation-enforcer from automatically continuing incomplete tasks
 5 | 2. Cancel any active Ralph Loop
 6 | 3. Clear the boulder state for the current project
 7 | 
 8 | After running this command:
 9 | - The session will not auto-continue when idle
10 | - You can manually continue work when ready
11 | - The stop state is per-session and clears when the session ends
12 | 
13 | Use this when you need to pause automated continuation and take manual control.`
14 | 


--------------------------------------------------------------------------------
/src/features/opencode-skill-loader/index.ts:
--------------------------------------------------------------------------------
 1 | export * from "./types"
 2 | export * from "./loader"
 3 | export * from "./merger"
 4 | export * from "./skill-content"
 5 | 
 6 | export * from "./skill-directory-loader"
 7 | export * from "./loaded-skill-from-path"
 8 | export * from "./skill-mcp-config"
 9 | export * from "./skill-deduplication"
10 | export * from "./skill-definition-record"
11 | 
12 | export * from "./git-master-template-injection"
13 | export * from "./skill-discovery"
14 | export * from "./skill-resolution-options"
15 | export * from "./loaded-skill-template-extractor"
16 | export * from "./skill-template-resolver"
17 | export * from "./config-source-discovery"
18 | 


--------------------------------------------------------------------------------
/src/shared/tmux/tmux-utils.ts:
--------------------------------------------------------------------------------
 1 | export { isInsideTmux, getCurrentPaneId } from "./tmux-utils/environment"
 2 | export type { SplitDirection } from "./tmux-utils/environment"
 3 | 
 4 | export { isServerRunning, resetServerCheck } from "./tmux-utils/server-health"
 5 | 
 6 | export { getPaneDimensions } from "./tmux-utils/pane-dimensions"
 7 | export type { PaneDimensions } from "./tmux-utils/pane-dimensions"
 8 | 
 9 | export { spawnTmuxPane } from "./tmux-utils/pane-spawn"
10 | export { closeTmuxPane } from "./tmux-utils/pane-close"
11 | export { replaceTmuxPane } from "./tmux-utils/pane-replace"
12 | 
13 | export { applyLayout, enforceMainPaneWidth } from "./tmux-utils/layout"
14 | 


--------------------------------------------------------------------------------
/src/shared/command-executor/embedded-commands.ts:
--------------------------------------------------------------------------------
 1 | export interface CommandMatch {
 2 | 	fullMatch: string
 3 | 	command: string
 4 | 	start: number
 5 | 	end: number
 6 | }
 7 | 
 8 | const COMMAND_PATTERN = /!`([^`]+)`/g
 9 | 
10 | export function findEmbeddedCommands(text: string): CommandMatch[] {
11 | 	const matches: CommandMatch[] = []
12 | 	let match: RegExpExecArray | null
13 | 
14 | 	COMMAND_PATTERN.lastIndex = 0
15 | 
16 | 	while ((match = COMMAND_PATTERN.exec(text)) !== null) {
17 | 		matches.push({
18 | 			fullMatch: match[0],
19 | 			command: match[1],
20 | 			start: match.index,
21 | 			end: match.index + match[0].length,
22 | 		})
23 | 	}
24 | 
25 | 	return matches
26 | }
27 | 


--------------------------------------------------------------------------------
/script/build-schema.test.ts:
--------------------------------------------------------------------------------
 1 | import { describe, expect, test } from "bun:test"
 2 | import { createOhMyOpenCodeJsonSchema } from "./build-schema-document"
 3 | 
 4 | describe("build-schema-document", () => {
 5 |   test("generates schema with skills property", () => {
 6 |     // given
 7 |     const expectedDraft = "http://json-schema.org/draft-07/schema#"
 8 | 
 9 |     // when
10 |     const schema = createOhMyOpenCodeJsonSchema()
11 | 
12 |     // then
13 |     expect(schema.$schema).toBe(expectedDraft)
14 |     expect(schema.title).toBe("Oh My OpenCode Configuration")
15 |     expect(schema.properties).toBeDefined()
16 |     expect(schema.properties.skills).toBeDefined()
17 |   })
18 | })
19 | 


--------------------------------------------------------------------------------
/src/cli/config-manager/npm-dist-tags.ts:
--------------------------------------------------------------------------------
 1 | export interface NpmDistTags {
 2 |   latest?: string
 3 |   beta?: string
 4 |   next?: string
 5 |   [tag: string]: string | undefined
 6 | }
 7 | 
 8 | const NPM_FETCH_TIMEOUT_MS = 5000
 9 | 
10 | export async function fetchNpmDistTags(packageName: string): Promise<NpmDistTags | null> {
11 |   try {
12 |     const res = await fetch(`https://registry.npmjs.org/-/package/${encodeURIComponent(packageName)}/dist-tags`, {
13 |       signal: AbortSignal.timeout(NPM_FETCH_TIMEOUT_MS),
14 |     })
15 |     if (!res.ok) return null
16 |     const data = (await res.json()) as NpmDistTags
17 |     return data
18 |   } catch {
19 |     return null
20 |   }
21 | }
22 | 


--------------------------------------------------------------------------------
/src/cli/doctor/formatter.ts:
--------------------------------------------------------------------------------
 1 | import type { DoctorResult, DoctorMode } from "./types"
 2 | import { formatDefault } from "./format-default"
 3 | import { formatStatus } from "./format-status"
 4 | import { formatVerbose } from "./format-verbose"
 5 | 
 6 | export function formatDoctorOutput(result: DoctorResult, mode: DoctorMode): string {
 7 |   switch (mode) {
 8 |     case "default":
 9 |       return formatDefault(result)
10 |     case "status":
11 |       return formatStatus(result)
12 |     case "verbose":
13 |       return formatVerbose(result)
14 |   }
15 | }
16 | 
17 | export function formatJsonOutput(result: DoctorResult): string {
18 |   return JSON.stringify(result, null, 2)
19 | }
20 | 


--------------------------------------------------------------------------------
/src/shared/disabled-tools.ts:
--------------------------------------------------------------------------------
 1 | import type { ToolDefinition } from "@opencode-ai/plugin"
 2 | 
 3 | export function filterDisabledTools(
 4 |   tools: Record<string, ToolDefinition>,
 5 |   disabledTools: readonly string[] | undefined
 6 | ): Record<string, ToolDefinition> {
 7 |   if (!disabledTools || disabledTools.length === 0) {
 8 |     return tools
 9 |   }
10 | 
11 |   const disabledToolSet = new Set(disabledTools)
12 |   const filtered: Record<string, ToolDefinition> = {}
13 |   for (const [toolName, toolDefinition] of Object.entries(tools)) {
14 |     if (!disabledToolSet.has(toolName)) {
15 |       filtered[toolName] = toolDefinition
16 |     }
17 |   }
18 |   return filtered
19 | }
20 | 


--------------------------------------------------------------------------------
/src/plugin/recent-synthetic-idles.ts:
--------------------------------------------------------------------------------
 1 | export function pruneRecentSyntheticIdles(args: {
 2 |   recentSyntheticIdles: Map<string, number>
 3 |   recentRealIdles: Map<string, number>
 4 |   now: number
 5 |   dedupWindowMs: number
 6 | }): void {
 7 |   const { recentSyntheticIdles, recentRealIdles, now, dedupWindowMs } = args
 8 | 
 9 |   for (const [sessionID, emittedAt] of recentSyntheticIdles) {
10 |     if (now - emittedAt >= dedupWindowMs) {
11 |       recentSyntheticIdles.delete(sessionID)
12 |     }
13 |   }
14 | 
15 |   for (const [sessionID, emittedAt] of recentRealIdles) {
16 |     if (now - emittedAt >= dedupWindowMs) {
17 |       recentRealIdles.delete(sessionID)
18 |     }
19 |   }
20 | }
21 | 


--------------------------------------------------------------------------------
/script/build-schema-document.ts:
--------------------------------------------------------------------------------
 1 | import * as z from "zod"
 2 | import { OhMyOpenCodeConfigSchema } from "../src/config/schema"
 3 | 
 4 | export function createOhMyOpenCodeJsonSchema(): Record<string, unknown> {
 5 |   const jsonSchema = z.toJSONSchema(OhMyOpenCodeConfigSchema, {
 6 |     target: "draft-07",
 7 |     unrepresentable: "any",
 8 |   })
 9 | 
10 |   return {
11 |     $schema: "http://json-schema.org/draft-07/schema#",
12 |     $id: "https://raw.githubusercontent.com/code-yeongyu/oh-my-opencode/master/assets/oh-my-opencode.schema.json",
13 |     title: "Oh My OpenCode Configuration",
14 |     description: "Configuration schema for oh-my-opencode plugin",
15 |     ...jsonSchema,
16 |   }
17 | }
18 | 


--------------------------------------------------------------------------------
/src/features/claude-tasks/types.ts:
--------------------------------------------------------------------------------
 1 | import { z } from "zod"
 2 | 
 3 | export const TaskStatusSchema = z.enum(["pending", "in_progress", "completed", "deleted"])
 4 | export type TaskStatus = z.infer<typeof TaskStatusSchema>
 5 | 
 6 | export const TaskSchema = z
 7 |   .object({
 8 |     id: z.string(),
 9 |     subject: z.string(),
10 |     description: z.string(),
11 |     status: TaskStatusSchema,
12 |     activeForm: z.string().optional(),
13 |     blocks: z.array(z.string()),
14 |     blockedBy: z.array(z.string()),
15 |     owner: z.string().optional(),
16 |     metadata: z.record(z.string(), z.unknown()).optional(),
17 |   })
18 |   .strict()
19 | 
20 | export type Task = z.infer<typeof TaskSchema>
21 | 


--------------------------------------------------------------------------------
/src/hooks/todo-continuation-enforcer/abort-detection.ts:
--------------------------------------------------------------------------------
 1 | import type { MessageInfo } from "./types"
 2 | 
 3 | export function isLastAssistantMessageAborted(
 4 |   messages: Array<{ info?: MessageInfo }>
 5 | ): boolean {
 6 |   if (!messages || messages.length === 0) return false
 7 | 
 8 |   const assistantMessages = messages.filter((message) => message.info?.role === "assistant")
 9 |   if (assistantMessages.length === 0) return false
10 | 
11 |   const lastAssistant = assistantMessages[assistantMessages.length - 1]
12 |   const errorName = lastAssistant.info?.error?.name
13 | 
14 |   if (!errorName) return false
15 | 
16 |   return errorName === "MessageAbortedError" || errorName === "AbortError"
17 | }
18 | 


--------------------------------------------------------------------------------
/src/cli/config-manager/plugin-name-with-version.ts:
--------------------------------------------------------------------------------
 1 | import { fetchNpmDistTags } from "./npm-dist-tags"
 2 | 
 3 | const PACKAGE_NAME = "oh-my-opencode"
 4 | const PRIORITIZED_TAGS = ["latest", "beta", "next"] as const
 5 | 
 6 | export async function getPluginNameWithVersion(currentVersion: string): Promise<string> {
 7 |   const distTags = await fetchNpmDistTags(PACKAGE_NAME)
 8 | 
 9 |   if (distTags) {
10 |     const allTags = new Set([...PRIORITIZED_TAGS, ...Object.keys(distTags)])
11 |     for (const tag of allTags) {
12 |       if (distTags[tag] === currentVersion) {
13 |         return `${PACKAGE_NAME}@${tag}`
14 |       }
15 |     }
16 |   }
17 | 
18 |   return `${PACKAGE_NAME}@${currentVersion}`
19 | }
20 | 


--------------------------------------------------------------------------------
/src/hooks/auto-update-checker/types.ts:
--------------------------------------------------------------------------------
 1 | export interface NpmDistTags {
 2 |   latest: string
 3 |   [key: string]: string
 4 | }
 5 | 
 6 | export interface OpencodeConfig {
 7 |   plugin?: string[]
 8 |   [key: string]: unknown
 9 | }
10 | 
11 | export interface PackageJson {
12 |   version: string
13 |   name?: string
14 |   [key: string]: unknown
15 | }
16 | 
17 | export interface UpdateCheckResult {
18 |   needsUpdate: boolean
19 |   currentVersion: string | null
20 |   latestVersion: string | null
21 |   isLocalDev: boolean
22 |   isPinned: boolean
23 | }
24 | 
25 | export interface AutoUpdateCheckerOptions {
26 |   showStartupToast?: boolean
27 |   isSisyphusEnabled?: boolean
28 |   autoUpdate?: boolean
29 | }
30 | 


--------------------------------------------------------------------------------
/src/hooks/rules-injector/output-path.ts:
--------------------------------------------------------------------------------
 1 | export interface ToolExecuteOutputShape {
 2 |   title: string;
 3 |   metadata: unknown;
 4 | }
 5 | 
 6 | export function getRuleInjectionFilePath(
 7 |   output: ToolExecuteOutputShape
 8 | ): string | null {
 9 |   const metadata = output.metadata as Record<string, unknown> | null;
10 |   const metadataFilePath =
11 |     metadata && typeof metadata === "object" ? metadata.filePath : undefined;
12 | 
13 |   if (typeof metadataFilePath === "string" && metadataFilePath.length > 0) {
14 |     return metadataFilePath;
15 |   }
16 | 
17 |   if (typeof output.title === "string" && output.title.length > 0) {
18 |     return output.title;
19 |   }
20 | 
21 |   return null;
22 | }
23 | 


--------------------------------------------------------------------------------
/src/shared/merge-categories.ts:
--------------------------------------------------------------------------------
 1 | import type { CategoriesConfig, CategoryConfig } from "../config/schema"
 2 | import { DEFAULT_CATEGORIES } from "../tools/delegate-task/constants"
 3 | 
 4 | /**
 5 |  * Merge default and user categories, filtering out disabled ones.
 6 |  * Single source of truth for category merging across the codebase.
 7 |  */
 8 | export function mergeCategories(
 9 |   userCategories?: CategoriesConfig,
10 | ): Record<string, CategoryConfig> {
11 |   const merged = userCategories
12 |     ? { ...DEFAULT_CATEGORIES, ...userCategories }
13 |     : { ...DEFAULT_CATEGORIES }
14 | 
15 |   return Object.fromEntries(
16 |     Object.entries(merged).filter(([, config]) => !config.disable),
17 |   )
18 | }
19 | 


--------------------------------------------------------------------------------
/src/features/tmux-subagent/session-status-parser.ts:
--------------------------------------------------------------------------------
 1 | type SessionStatus = { type: string }
 2 | 
 3 | export function parseSessionStatusMap(data: unknown): Record<string, SessionStatus> {
 4 |   if (typeof data !== "object" || data === null) return {}
 5 |   const record = data as Record<string, unknown>
 6 | 
 7 |   const result: Record<string, SessionStatus> = {}
 8 |   for (const [sessionId, value] of Object.entries(record)) {
 9 |     if (typeof value !== "object" || value === null) continue
10 |     const valueRecord = value as Record<string, unknown>
11 |     const type = valueRecord["type"]
12 |     if (typeof type !== "string") continue
13 |     result[sessionId] = { type }
14 |   }
15 | 
16 |   return result
17 | }
18 | 


--------------------------------------------------------------------------------
/src/tools/glob/result-formatter.ts:
--------------------------------------------------------------------------------
 1 | import type { GlobResult } from "./types"
 2 | 
 3 | export function formatGlobResult(result: GlobResult): string {
 4 |   if (result.error) {
 5 |     return `Error: ${result.error}`
 6 |   }
 7 | 
 8 |   if (result.files.length === 0) {
 9 |     return "No files found"
10 |   }
11 | 
12 |   const lines: string[] = []
13 |   lines.push(`Found ${result.totalFiles} file(s)`)
14 |   lines.push("")
15 | 
16 |   for (const file of result.files) {
17 |     lines.push(file.path)
18 |   }
19 | 
20 |   if (result.truncated) {
21 |     lines.push("")
22 |     lines.push("(Results are truncated. Consider using a more specific path or pattern.)")
23 |   }
24 | 
25 |   return lines.join("\n")
26 | }
27 | 


--------------------------------------------------------------------------------
/src/hooks/auto-update-checker/checker/local-dev-version.ts:
--------------------------------------------------------------------------------
 1 | import * as fs from "node:fs"
 2 | import type { PackageJson } from "../types"
 3 | import { getLocalDevPath } from "./local-dev-path"
 4 | import { findPackageJsonUp } from "./package-json-locator"
 5 | 
 6 | export function getLocalDevVersion(directory: string): string | null {
 7 |   const localPath = getLocalDevPath(directory)
 8 |   if (!localPath) return null
 9 | 
10 |   try {
11 |     const pkgPath = findPackageJsonUp(localPath)
12 |     if (!pkgPath) return null
13 |     const content = fs.readFileSync(pkgPath, "utf-8")
14 |     const pkg = JSON.parse(content) as PackageJson
15 |     return pkg.version ?? null
16 |   } catch {
17 |     return null
18 |   }
19 | }
20 | 


--------------------------------------------------------------------------------
/src/features/tmux-subagent/decision-engine.ts:
--------------------------------------------------------------------------------
 1 | export type { SessionMapping } from "./oldest-agent-pane"
 2 | export type { GridCapacity, GridPlan, GridSlot } from "./grid-planning"
 3 | export type { SpawnTarget } from "./spawn-target-finder"
 4 | 
 5 | export {
 6 | 	calculateCapacity,
 7 | 	computeGridPlan,
 8 | 	mapPaneToSlot,
 9 | } from "./grid-planning"
10 | 
11 | export {
12 | 	canSplitPane,
13 | 	canSplitPaneAnyDirection,
14 | 	findMinimalEvictions,
15 | 	getBestSplitDirection,
16 | 	getColumnCount,
17 | 	getColumnWidth,
18 | 	isSplittableAtCount,
19 | } from "./pane-split-availability"
20 | 
21 | export { findSpawnTarget } from "./spawn-target-finder"
22 | export { decideCloseAction, decideSpawnActions } from "./spawn-action-decider"
23 | 


--------------------------------------------------------------------------------
/src/plugin/session-status-normalizer.ts:
--------------------------------------------------------------------------------
 1 | type EventInput = { event: { type: string; properties?: Record<string, unknown> } }
 2 | type SessionStatus = { type: string }
 3 | 
 4 | export function normalizeSessionStatusToIdle(input: EventInput): EventInput | null {
 5 | 	if (input.event.type !== "session.status") return null
 6 | 
 7 | 	const props = input.event.properties
 8 | 	if (!props) return null
 9 | 
10 | 	const status = props.status as SessionStatus | undefined
11 | 	if (!status || status.type !== "idle") return null
12 | 
13 | 	const sessionID = props.sessionID as string | undefined
14 | 	if (!sessionID) return null
15 | 
16 | 	return {
17 | 		event: {
18 | 			type: "session.idle",
19 | 			properties: { sessionID },
20 | 		},
21 | 	}
22 | }
23 | 


--------------------------------------------------------------------------------
/.github/pull_request_template.md:
--------------------------------------------------------------------------------
 1 | ## Summary
 2 | 
 3 | <!-- Brief description of what this PR does. 1-3 bullet points. -->
 4 | 
 5 | - 
 6 | 
 7 | ## Changes
 8 | 
 9 | <!-- What was changed and how. List specific modifications. -->
10 | 
11 | - 
12 | 
13 | ## Screenshots
14 | 
15 | <!-- If applicable, add screenshots or GIFs showing before/after. Delete this section if not needed. -->
16 | 
17 | | Before | After |
18 | |:---:|:---:|
19 | |  |  |
20 | 
21 | ## Testing
22 | 
23 | <!-- How to verify this PR works correctly. Delete if not applicable. -->
24 | 
25 | ```bash
26 | bun run typecheck
27 | bun test
28 | ```
29 | 
30 | ## Related Issues
31 | 
32 | <!-- Link related issues. Use "Closes #123" to auto-close on merge. -->
33 | 
34 | <!-- Closes # -->
35 | 


--------------------------------------------------------------------------------
/src/tools/slashcommand/skill-command-converter.ts:
--------------------------------------------------------------------------------
 1 | import type { LoadedSkill } from "../../features/opencode-skill-loader"
 2 | import type { CommandInfo } from "./types"
 3 | 
 4 | export function skillToCommandInfo(skill: LoadedSkill): CommandInfo {
 5 |   return {
 6 |     name: skill.name,
 7 |     path: skill.path,
 8 |     metadata: {
 9 |       name: skill.name,
10 |       description: skill.definition.description || "",
11 |       argumentHint: skill.definition.argumentHint,
12 |       model: skill.definition.model,
13 |       agent: skill.definition.agent,
14 |       subtask: skill.definition.subtask,
15 |     },
16 |     content: skill.definition.template,
17 |     scope: skill.scope,
18 |     lazyContentLoader: skill.lazyContent,
19 |   }
20 | }
21 | 


--------------------------------------------------------------------------------
/src/config/schema/sisyphus.ts:
--------------------------------------------------------------------------------
 1 | import { z } from "zod"
 2 | 
 3 | export const SisyphusTasksConfigSchema = z.object({
 4 |   /** Absolute or relative storage path override. When set, bypasses global config dir. */
 5 |   storage_path: z.string().optional(),
 6 |   /** Force task list ID (alternative to env ULTRAWORK_TASK_LIST_ID) */
 7 |   task_list_id: z.string().optional(),
 8 |   /** Enable Claude Code path compatibility mode */
 9 |   claude_code_compat: z.boolean().default(false),
10 | })
11 | 
12 | export const SisyphusConfigSchema = z.object({
13 |   tasks: SisyphusTasksConfigSchema.optional(),
14 | })
15 | 
16 | export type SisyphusTasksConfig = z.infer<typeof SisyphusTasksConfigSchema>
17 | export type SisyphusConfig = z.infer<typeof SisyphusConfigSchema>
18 | 


--------------------------------------------------------------------------------
/src/features/background-agent/error-classifier.ts:
--------------------------------------------------------------------------------
 1 | export function isAbortedSessionError(error: unknown): boolean {
 2 |   const message = getErrorText(error)
 3 |   return message.toLowerCase().includes("aborted")
 4 | }
 5 | 
 6 | export function getErrorText(error: unknown): string {
 7 |   if (!error) return ""
 8 |   if (typeof error === "string") return error
 9 |   if (error instanceof Error) {
10 |     return `${error.name}: ${error.message}`
11 |   }
12 |   if (typeof error === "object" && error !== null) {
13 |     if ("message" in error && typeof error.message === "string") {
14 |       return error.message
15 |     }
16 |     if ("name" in error && typeof error.name === "string") {
17 |       return error.name
18 |     }
19 |   }
20 |   return ""
21 | }
22 | 


--------------------------------------------------------------------------------
/src/tools/hashline-edit/hash-computation.ts:
--------------------------------------------------------------------------------
 1 | import { HASH_DICT } from "./constants"
 2 | 
 3 | export function computeLineHash(_lineNumber: number, content: string): string {
 4 |   const stripped = content.replace(/\s+/g, "")
 5 |   const hash = Bun.hash.xxHash32(stripped)
 6 |   const index = hash % 256
 7 |   return HASH_DICT[index]
 8 | }
 9 | 
10 | export function formatHashLine(lineNumber: number, content: string): string {
11 |   const hash = computeLineHash(lineNumber, content)
12 |   return `${lineNumber}:${hash}|${content}`
13 | }
14 | 
15 | export function formatHashLines(content: string): string {
16 |   if (!content) return ""
17 |   const lines = content.split("\n")
18 |   return lines.map((line, index) => formatHashLine(index + 1, line)).join("\n")
19 | }
20 | 


--------------------------------------------------------------------------------
/src/hooks/session-todo-status.ts:
--------------------------------------------------------------------------------
 1 | import type { PluginInput } from "@opencode-ai/plugin"
 2 | import { normalizeSDKResponse } from "../shared"
 3 | 
 4 | interface Todo {
 5 |   content: string
 6 |   status: string
 7 |   priority: string
 8 |   id: string
 9 | }
10 | 
11 | export async function hasIncompleteTodos(ctx: PluginInput, sessionID: string): Promise<boolean> {
12 |   try {
13 |     const response = await ctx.client.session.todo({ path: { id: sessionID } })
14 |     const todos = normalizeSDKResponse(response, [] as Todo[], { preferResponseOnMissingData: true })
15 |     if (!todos || todos.length === 0) return false
16 |     return todos.some((todo) => todo.status !== "completed" && todo.status !== "cancelled")
17 |   } catch {
18 |     return false
19 |   }
20 | }
21 | 


--------------------------------------------------------------------------------
/src/shared/first-message-variant.ts:
--------------------------------------------------------------------------------
 1 | type SessionInfo = {
 2 |   id?: string
 3 |   parentID?: string
 4 | }
 5 | 
 6 | export function createFirstMessageVariantGate() {
 7 |   const pending = new Set<string>()
 8 | 
 9 |   return {
10 |     markSessionCreated(info?: SessionInfo) {
11 |       if (info?.id && !info.parentID) {
12 |         pending.add(info.id)
13 |       }
14 |     },
15 |     shouldOverride(sessionID?: string) {
16 |       if (!sessionID) return false
17 |       return pending.has(sessionID)
18 |     },
19 |     markApplied(sessionID?: string) {
20 |       if (!sessionID) return
21 |       pending.delete(sessionID)
22 |     },
23 |     clear(sessionID?: string) {
24 |       if (!sessionID) return
25 |       pending.delete(sessionID)
26 |     },
27 |   }
28 | }
29 | 


--------------------------------------------------------------------------------
/src/features/opencode-skill-loader/merger/skills-config-normalizer.ts:
--------------------------------------------------------------------------------
 1 | import type { SkillsConfig, SkillDefinition } from "../../../config/schema"
 2 | 
 3 | export function normalizeSkillsConfig(config: SkillsConfig | undefined): {
 4 |   sources: Array<string | { path: string; recursive?: boolean; glob?: string }>
 5 |   enable: string[]
 6 |   disable: string[]
 7 |   entries: Record<string, boolean | SkillDefinition>
 8 | } {
 9 |   if (!config) {
10 |     return { sources: [], enable: [], disable: [], entries: {} }
11 |   }
12 | 
13 |   if (Array.isArray(config)) {
14 |     return { sources: [], enable: config, disable: [], entries: {} }
15 |   }
16 | 
17 |   const { sources = [], enable = [], disable = [], ...entries } = config
18 |   return { sources, enable, disable, entries }
19 | }
20 | 


--------------------------------------------------------------------------------
/src/config/index.ts:
--------------------------------------------------------------------------------
 1 | export {
 2 |   OhMyOpenCodeConfigSchema,
 3 |   AgentOverrideConfigSchema,
 4 |   AgentOverridesSchema,
 5 |   McpNameSchema,
 6 |   AgentNameSchema,
 7 |   HookNameSchema,
 8 |   BuiltinCommandNameSchema,
 9 |   SisyphusAgentConfigSchema,
10 |   ExperimentalConfigSchema,
11 |   RalphLoopConfigSchema,
12 |   TmuxConfigSchema,
13 |   TmuxLayoutSchema,
14 | } from "./schema"
15 | 
16 | export type {
17 |   OhMyOpenCodeConfig,
18 |   AgentOverrideConfig,
19 |   AgentOverrides,
20 |   McpName,
21 |   AgentName,
22 |   HookName,
23 |   BuiltinCommandName,
24 |   SisyphusAgentConfig,
25 |   ExperimentalConfig,
26 |   DynamicContextPruningConfig,
27 |   RalphLoopConfig,
28 |   TmuxConfig,
29 |   TmuxLayout,
30 |   SisyphusConfig,
31 |   SisyphusTasksConfig,
32 | } from "./schema"
33 | 


--------------------------------------------------------------------------------
/src/hooks/background-notification/hook.ts:
--------------------------------------------------------------------------------
 1 | import type { BackgroundManager } from "../../features/background-agent"
 2 | 
 3 | interface Event {
 4 |   type: string
 5 |   properties?: Record<string, unknown>
 6 | }
 7 | 
 8 | interface EventInput {
 9 |   event: Event
10 | }
11 | 
12 | /**
13 |  * Background notification hook - handles event routing to BackgroundManager.
14 |  *
15 |  * Notifications are now delivered directly via session.prompt({ noReply })
16 |  * from the manager, so this hook only needs to handle event routing.
17 |  */
18 | export function createBackgroundNotificationHook(manager: BackgroundManager) {
19 |   const eventHandler = async ({ event }: EventInput) => {
20 |     manager.handleEvent(event)
21 |   }
22 | 
23 |   return {
24 |     event: eventHandler,
25 |   }
26 | }
27 | 


--------------------------------------------------------------------------------
/src/shared/model-resolution-types.ts:
--------------------------------------------------------------------------------
 1 | import type { FallbackEntry } from "./model-requirements"
 2 | 
 3 | export type ModelResolutionRequest = {
 4 |   intent?: {
 5 |     uiSelectedModel?: string
 6 |     userModel?: string
 7 |     categoryDefaultModel?: string
 8 |   }
 9 |   constraints: {
10 |     availableModels: Set<string>
11 |   }
12 |   policy?: {
13 |     fallbackChain?: FallbackEntry[]
14 |     systemDefaultModel?: string
15 |   }
16 | }
17 | 
18 | export type ModelResolutionProvenance =
19 |   | "override"
20 |   | "category-default"
21 |   | "provider-fallback"
22 |   | "system-default"
23 | 
24 | export type ModelResolutionResult = {
25 |   model: string
26 |   provenance: ModelResolutionProvenance
27 |   variant?: string
28 |   attempted?: string[]
29 |   reason?: string
30 | }
31 | 


--------------------------------------------------------------------------------
/src/shared/skill-path-resolver.ts:
--------------------------------------------------------------------------------
 1 | import { join } from "path"
 2 | 
 3 | /**
 4 |  * Resolves @path references in skill content to absolute paths.
 5 |  *
 6 |  * Matches @references that contain at least one slash (e.g., @scripts/search.py, @data/)
 7 |  * to avoid false positives with decorators (@param), JSDoc tags (@ts-ignore), etc.
 8 |  *
 9 |  * Email addresses are excluded since they have alphanumeric characters before @.
10 |  */
11 | export function resolveSkillPathReferences(content: string, basePath: string): string {
12 | 	const normalizedBase = basePath.endsWith("/") ? basePath.slice(0, -1) : basePath
13 | 	return content.replace(
14 | 		/(?<![a-zA-Z0-9])@([a-zA-Z0-9_-]+\/[a-zA-Z0-9_.\-\/]*)/g,
15 | 		(_, relativePath: string) => join(normalizedBase, relativePath)
16 | 	)
17 | }
18 | 


--------------------------------------------------------------------------------
/src/tools/delegate-task/executor.ts:
--------------------------------------------------------------------------------
 1 | export type { ExecutorContext, ParentContext } from "./executor-types"
 2 | 
 3 | export { resolveSkillContent } from "./skill-resolver"
 4 | export { resolveParentContext } from "./parent-context-resolver"
 5 | 
 6 | export { executeBackgroundContinuation } from "./background-continuation"
 7 | export { executeSyncContinuation } from "./sync-continuation"
 8 | 
 9 | export { executeUnstableAgentTask } from "./unstable-agent-task"
10 | export { executeBackgroundTask } from "./background-task"
11 | export { executeSyncTask } from "./sync-task"
12 | 
13 | export { resolveCategoryExecution } from "./category-resolver"
14 | export type { CategoryResolutionResult } from "./category-resolver"
15 | 
16 | export { resolveSubagentExecution } from "./subagent-resolver"
17 | 


--------------------------------------------------------------------------------
/src/cli/model-fallback-types.ts:
--------------------------------------------------------------------------------
 1 | export interface ProviderAvailability {
 2 | 	native: {
 3 | 		claude: boolean
 4 | 		openai: boolean
 5 | 		gemini: boolean
 6 | 	}
 7 | 	opencodeZen: boolean
 8 | 	copilot: boolean
 9 | 	zai: boolean
10 | 	kimiForCoding: boolean
11 | 	isMaxPlan: boolean
12 | }
13 | 
14 | export interface UltraworkConfig {
15 | 	model: string
16 | 	variant?: string
17 | }
18 | 
19 | export interface AgentConfig {
20 | 	model: string
21 | 	variant?: string
22 | 	ultrawork?: UltraworkConfig
23 | }
24 | 
25 | export interface CategoryConfig {
26 | 	model: string
27 | 	variant?: string
28 | }
29 | 
30 | export interface GeneratedOmoConfig {
31 | 	$schema: string
32 | 	agents?: Record<string, AgentConfig>
33 | 	categories?: Record<string, CategoryConfig>
34 | 	[key: string]: unknown
35 | }
36 | 


--------------------------------------------------------------------------------
/src/config/schema/internal/permission.ts:
--------------------------------------------------------------------------------
 1 | import { z } from "zod"
 2 | 
 3 | export const PermissionValueSchema = z.enum(["ask", "allow", "deny"])
 4 | export type PermissionValue = z.infer<typeof PermissionValueSchema>
 5 | 
 6 | const BashPermissionSchema = z.union([
 7 |   PermissionValueSchema,
 8 |   z.record(z.string(), PermissionValueSchema),
 9 | ])
10 | 
11 | export const AgentPermissionSchema = z.object({
12 |   edit: PermissionValueSchema.optional(),
13 |   bash: BashPermissionSchema.optional(),
14 |   webfetch: PermissionValueSchema.optional(),
15 |   task: PermissionValueSchema.optional(),
16 |   doom_loop: PermissionValueSchema.optional(),
17 |   external_directory: PermissionValueSchema.optional(),
18 | })
19 | 
20 | export type AgentPermission = z.infer<typeof AgentPermissionSchema>
21 | 


--------------------------------------------------------------------------------
/src/shared/git-worktree/parse-status-porcelain-line.ts:
--------------------------------------------------------------------------------
 1 | import type { GitFileStatus } from "./types"
 2 | 
 3 | export interface ParsedGitStatusPorcelainLine {
 4 | 	filePath: string
 5 | 	status: GitFileStatus
 6 | }
 7 | 
 8 | function toGitFileStatus(statusToken: string): GitFileStatus {
 9 | 	if (statusToken === "A" || statusToken === "??") return "added"
10 | 	if (statusToken === "D") return "deleted"
11 | 	return "modified"
12 | }
13 | 
14 | export function parseGitStatusPorcelainLine(
15 | 	line: string,
16 | ): ParsedGitStatusPorcelainLine | null {
17 | 	if (!line) return null
18 | 
19 | 	const statusToken = line.substring(0, 2).trim()
20 | 	const filePath = line.substring(3)
21 | 	if (!filePath) return null
22 | 
23 | 	return {
24 | 		filePath,
25 | 		status: toGitFileStatus(statusToken),
26 | 	}
27 | }
28 | 


--------------------------------------------------------------------------------
/src/features/skill-mcp-manager/connection-type.ts:
--------------------------------------------------------------------------------
 1 | import type { ClaudeCodeMcpServer } from "../claude-code-mcp-loader/types"
 2 | import type { ConnectionType } from "./types"
 3 | 
 4 | /**
 5 |  * Determines connection type from MCP server configuration.
 6 |  * Priority: explicit type field > url presence > command presence
 7 |  */
 8 | export function getConnectionType(config: ClaudeCodeMcpServer): ConnectionType | null {
 9 |   // Explicit type takes priority
10 |   if (config.type === "http" || config.type === "sse") {
11 |     return "http"
12 |   }
13 |   if (config.type === "stdio") {
14 |     return "stdio"
15 |   }
16 | 
17 |   // Infer from available fields
18 |   if (config.url) {
19 |     return "http"
20 |   }
21 |   if (config.command) {
22 |     return "stdio"
23 |   }
24 | 
25 |   return null
26 | }
27 | 


--------------------------------------------------------------------------------
/src/features/task-toast-manager/types.ts:
--------------------------------------------------------------------------------
 1 | import type { ModelSource } from "../../shared/model-resolver"
 2 | 
 3 | export type TaskStatus = "running" | "queued" | "completed" | "error"
 4 | 
 5 | export interface ModelFallbackInfo {
 6 |   model: string
 7 |   type: "user-defined" | "inherited" | "category-default" | "system-default"
 8 |   source?: ModelSource
 9 | }
10 | 
11 | export interface TrackedTask {
12 |   id: string
13 |   description: string
14 |   agent: string
15 |   status: TaskStatus
16 |   startedAt: Date
17 |   isBackground: boolean
18 |   category?: string
19 |   skills?: string[]
20 |   modelInfo?: ModelFallbackInfo
21 | }
22 | 
23 | export interface TaskToastOptions {
24 |   title: string
25 |   message: string
26 |   variant: "info" | "success" | "warning" | "error"
27 |   duration?: number
28 | }
29 | 


--------------------------------------------------------------------------------
/src/plugin-handlers/plan-model-inheritance.ts:
--------------------------------------------------------------------------------
 1 | const MODEL_SETTINGS_KEYS = [
 2 |   "model",
 3 |   "variant",
 4 |   "temperature",
 5 |   "top_p",
 6 |   "maxTokens",
 7 |   "thinking",
 8 |   "reasoningEffort",
 9 |   "textVerbosity",
10 |   "providerOptions",
11 | ] as const
12 | 
13 | export function buildPlanDemoteConfig(
14 |   prometheusConfig: Record<string, unknown> | undefined,
15 |   planOverride: Record<string, unknown> | undefined,
16 | ): Record<string, unknown> {
17 |   const modelSettings: Record<string, unknown> = {}
18 | 
19 |   for (const key of MODEL_SETTINGS_KEYS) {
20 |     const value = planOverride?.[key] ?? prometheusConfig?.[key]
21 |     if (value !== undefined) {
22 |       modelSettings[key] = value
23 |     }
24 |   }
25 | 
26 |   return { mode: "subagent" as const, ...modelSettings }
27 | }
28 | 


--------------------------------------------------------------------------------
/src/shared/git-worktree/parse-diff-numstat.ts:
--------------------------------------------------------------------------------
 1 | import type { GitFileStat, GitFileStatus } from "./types"
 2 | 
 3 | export function parseGitDiffNumstat(
 4 |   output: string,
 5 |   statusMap: Map<string, GitFileStatus>
 6 | ): GitFileStat[] {
 7 |   if (!output) return []
 8 | 
 9 |   const stats: GitFileStat[] = []
10 |   for (const line of output.split("\n")) {
11 |     const parts = line.split("\t")
12 |     if (parts.length < 3) continue
13 | 
14 |     const [addedStr, removedStr, path] = parts
15 |     const added = addedStr === "-" ? 0 : parseInt(addedStr, 10)
16 |     const removed = removedStr === "-" ? 0 : parseInt(removedStr, 10)
17 | 
18 |     stats.push({
19 |       path,
20 |       added,
21 |       removed,
22 |       status: statusMap.get(path) ?? "modified",
23 |     })
24 |   }
25 | 
26 |   return stats
27 | }
28 | 


--------------------------------------------------------------------------------
/src/plugin/messages-transform.ts:
--------------------------------------------------------------------------------
 1 | import type { Message, Part } from "@opencode-ai/sdk"
 2 | 
 3 | import type { CreatedHooks } from "../create-hooks"
 4 | 
 5 | type MessageWithParts = {
 6 |   info: Message
 7 |   parts: Part[]
 8 | }
 9 | 
10 | type MessagesTransformOutput = { messages: MessageWithParts[] }
11 | 
12 | export function createMessagesTransformHandler(args: {
13 |   hooks: CreatedHooks
14 | }): (input: Record<string, never>, output: MessagesTransformOutput) => Promise<void> {
15 |   return async (input, output): Promise<void> => {
16 |     await args.hooks.contextInjectorMessagesTransform?.[
17 |       "experimental.chat.messages.transform"
18 |     ]?.(input, output)
19 | 
20 |     await args.hooks.thinkingBlockValidator?.[
21 |       "experimental.chat.messages.transform"
22 |     ]?.(input, output)
23 |   }
24 | }
25 | 


--------------------------------------------------------------------------------
/src/shared/command-executor/shell-path.ts:
--------------------------------------------------------------------------------
 1 | import { existsSync } from "node:fs"
 2 | 
 3 | const DEFAULT_ZSH_PATHS = ["/bin/zsh", "/usr/bin/zsh", "/usr/local/bin/zsh"]
 4 | const DEFAULT_BASH_PATHS = ["/bin/bash", "/usr/bin/bash", "/usr/local/bin/bash"]
 5 | 
 6 | function findShellPath(
 7 | 	defaultPaths: string[],
 8 | 	customPath?: string,
 9 | ): string | null {
10 | 	if (customPath && existsSync(customPath)) {
11 | 		return customPath
12 | 	}
13 | 	for (const path of defaultPaths) {
14 | 		if (existsSync(path)) {
15 | 			return path
16 | 		}
17 | 	}
18 | 	return null
19 | }
20 | 
21 | export function findZshPath(customZshPath?: string): string | null {
22 | 	return findShellPath(DEFAULT_ZSH_PATHS, customZshPath)
23 | }
24 | 
25 | export function findBashPath(): string | null {
26 | 	return findShellPath(DEFAULT_BASH_PATHS)
27 | }
28 | 


--------------------------------------------------------------------------------
/src/cli/run/agent-profile-colors.ts:
--------------------------------------------------------------------------------
 1 | import type { OpencodeClient } from "@opencode-ai/sdk"
 2 | import { normalizeSDKResponse } from "../../shared"
 3 | 
 4 | interface AgentProfile {
 5 |   name?: string
 6 |   color?: string
 7 | }
 8 | 
 9 | export async function loadAgentProfileColors(
10 |   client: OpencodeClient,
11 | ): Promise<Record<string, string>> {
12 |   try {
13 |     const agentsRes = await client.app.agents()
14 |     const agents = normalizeSDKResponse(agentsRes, [] as AgentProfile[], {
15 |       preferResponseOnMissingData: true,
16 |     })
17 | 
18 |     const colors: Record<string, string> = {}
19 |     for (const agent of agents) {
20 |       if (!agent.name || !agent.color) continue
21 |       colors[agent.name] = agent.color
22 |     }
23 | 
24 |     return colors
25 |   } catch {
26 |     return {}
27 |   }
28 | }
29 | 


--------------------------------------------------------------------------------
/src/hooks/auto-update-checker/checker/latest-version.ts:
--------------------------------------------------------------------------------
 1 | import { NPM_FETCH_TIMEOUT, NPM_REGISTRY_URL } from "../constants"
 2 | import type { NpmDistTags } from "../types"
 3 | 
 4 | export async function getLatestVersion(channel: string = "latest"): Promise<string | null> {
 5 |   const controller = new AbortController()
 6 |   const timeoutId = setTimeout(() => controller.abort(), NPM_FETCH_TIMEOUT)
 7 | 
 8 |   try {
 9 |     const response = await fetch(NPM_REGISTRY_URL, {
10 |       signal: controller.signal,
11 |       headers: { Accept: "application/json" },
12 |     })
13 | 
14 |     if (!response.ok) return null
15 | 
16 |     const data = (await response.json()) as NpmDistTags
17 |     return data[channel] ?? data.latest ?? null
18 |   } catch {
19 |     return null
20 |   } finally {
21 |     clearTimeout(timeoutId)
22 |   }
23 | }
24 | 


--------------------------------------------------------------------------------
/src/hooks/auto-update-checker/hook/model-cache-warning.ts:
--------------------------------------------------------------------------------
 1 | import type { PluginInput } from "@opencode-ai/plugin"
 2 | import { isModelCacheAvailable } from "../../../shared/model-availability"
 3 | import { log } from "../../../shared/logger"
 4 | 
 5 | export async function showModelCacheWarningIfNeeded(ctx: PluginInput): Promise<void> {
 6 |   if (isModelCacheAvailable()) return
 7 | 
 8 |   await ctx.client.tui
 9 |     .showToast({
10 |       body: {
11 |         title: "Model Cache Not Found",
12 |         message:
13 |           "Run 'opencode models --refresh' or restart OpenCode to populate the models cache for optimal agent model selection.",
14 |         variant: "warning" as const,
15 |         duration: 10000,
16 |       },
17 |     })
18 |     .catch(() => {})
19 | 
20 |   log("[auto-update-checker] Model cache warning shown")
21 | }
22 | 


--------------------------------------------------------------------------------
/src/hooks/delegate-task-retry/hook.ts:
--------------------------------------------------------------------------------
 1 | import type { PluginInput } from "@opencode-ai/plugin"
 2 | 
 3 | import { buildRetryGuidance } from "./guidance"
 4 | import { detectDelegateTaskError } from "./patterns"
 5 | 
 6 | export function createDelegateTaskRetryHook(_ctx: PluginInput) {
 7 |   return {
 8 |     "tool.execute.after": async (
 9 |       input: { tool: string; sessionID: string; callID: string },
10 |       output: { title: string; output: string; metadata: unknown }
11 |     ) => {
12 |       if (input.tool.toLowerCase() !== "task") return
13 |       if (typeof output.output !== "string") return
14 | 
15 |       const errorInfo = detectDelegateTaskError(output.output)
16 |       if (errorInfo) {
17 |         const guidance = buildRetryGuidance(errorInfo)
18 |         output.output += `\n${guidance}`
19 |       }
20 |     },
21 |   }
22 | }
23 | 


--------------------------------------------------------------------------------
/src/shared/tool-name.ts:
--------------------------------------------------------------------------------
 1 | const SPECIAL_TOOL_MAPPINGS: Record<string, string> = {
 2 |   webfetch: "WebFetch",
 3 |   websearch: "WebSearch",
 4 |   todoread: "TodoRead",
 5 |   todowrite: "TodoWrite",
 6 | }
 7 | 
 8 | function toPascalCase(str: string): string {
 9 |   return str
10 |     .split(/[-_\s]+/)
11 |     .map((word) => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
12 |     .join("")
13 | }
14 | 
15 | export function transformToolName(toolName: string): string {
16 |   const trimmed = toolName.trim()
17 |   const lower = trimmed.toLowerCase()
18 |   if (lower in SPECIAL_TOOL_MAPPINGS) {
19 |     return SPECIAL_TOOL_MAPPINGS[lower]
20 |   }
21 | 
22 |   if (trimmed.includes("-") || trimmed.includes("_")) {
23 |     return toPascalCase(trimmed)
24 |   }
25 | 
26 |   return trimmed.charAt(0).toUpperCase() + trimmed.slice(1)
27 | }
28 | 


--------------------------------------------------------------------------------
/src/config/schema/background-task.ts:
--------------------------------------------------------------------------------
 1 | import { z } from "zod"
 2 | 
 3 | export const BackgroundTaskConfigSchema = z.object({
 4 |   defaultConcurrency: z.number().min(1).optional(),
 5 |   providerConcurrency: z.record(z.string(), z.number().min(0)).optional(),
 6 |   modelConcurrency: z.record(z.string(), z.number().min(0)).optional(),
 7 |   /** Stale timeout in milliseconds - interrupt tasks with no activity for this duration (default: 180000 = 3 minutes, minimum: 60000 = 1 minute) */
 8 |   staleTimeoutMs: z.number().min(60000).optional(),
 9 |   /** Timeout for tasks that never received any progress update, falling back to startedAt (default: 600000 = 10 minutes, minimum: 60000 = 1 minute) */
10 |   messageStalenessTimeoutMs: z.number().min(60000).optional(),
11 | })
12 | 
13 | export type BackgroundTaskConfig = z.infer<typeof BackgroundTaskConfigSchema>
14 | 


--------------------------------------------------------------------------------
/src/features/skill-mcp-manager/env-cleaner.ts:
--------------------------------------------------------------------------------
 1 | // Filters npm/pnpm/yarn config env vars that break MCP servers in pnpm projects (#456)
 2 | export const EXCLUDED_ENV_PATTERNS: RegExp[] = [
 3 |   /^NPM_CONFIG_/i,
 4 |   /^npm_config_/,
 5 |   /^YARN_/,
 6 |   /^PNPM_/,
 7 |   /^NO_UPDATE_NOTIFIER$/,
 8 | ]
 9 | 
10 | export function createCleanMcpEnvironment(
11 |   customEnv: Record<string, string> = {}
12 | ): Record<string, string> {
13 |   const cleanEnv: Record<string, string> = {}
14 | 
15 |   for (const [key, value] of Object.entries(process.env)) {
16 |     if (value === undefined) continue
17 | 
18 |     const shouldExclude = EXCLUDED_ENV_PATTERNS.some((pattern) => pattern.test(key))
19 |     if (!shouldExclude) {
20 |       cleanEnv[key] = value
21 |     }
22 |   }
23 | 
24 |   Object.assign(cleanEnv, customEnv)
25 | 
26 |   return cleanEnv
27 | }
28 | 


--------------------------------------------------------------------------------
/src/hooks/rules-injector/constants.ts:
--------------------------------------------------------------------------------
 1 | import { join } from "node:path";
 2 | import { OPENCODE_STORAGE } from "../../shared";
 3 | export const RULES_INJECTOR_STORAGE = join(OPENCODE_STORAGE, "rules-injector");
 4 | 
 5 | export const PROJECT_MARKERS = [
 6 |   ".git",
 7 |   "pyproject.toml",
 8 |   "package.json",
 9 |   "Cargo.toml",
10 |   "go.mod",
11 |   ".venv",
12 | ];
13 | 
14 | export const PROJECT_RULE_SUBDIRS: [string, string][] = [
15 |   [".github", "instructions"],
16 |   [".cursor", "rules"],
17 |   [".claude", "rules"],
18 |   [".sisyphus", "rules"],
19 | ];
20 | 
21 | export const PROJECT_RULE_FILES: string[] = [
22 |   ".github/copilot-instructions.md",
23 | ];
24 | 
25 | export const GITHUB_INSTRUCTIONS_PATTERN = /\.instructions\.md$/;
26 | 
27 | export const USER_RULE_DIR = ".claude/rules";
28 | 
29 | export const RULE_EXTENSIONS = [".md", ".mdc"];
30 | 


--------------------------------------------------------------------------------
/src/shared/open-code-client-accessors.ts:
--------------------------------------------------------------------------------
 1 | import type { ModelListFunction, ProviderListFunction } from "./open-code-client-shapes"
 2 | import { isRecord } from "./record-type-guard"
 3 | 
 4 | export function getProviderListFunction(client: unknown): ProviderListFunction | null {
 5 | 	if (!isRecord(client)) return null
 6 | 	const provider = client["provider"]
 7 | 	if (!isRecord(provider)) return null
 8 | 	const list = provider["list"]
 9 | 	if (typeof list !== "function") return null
10 | 	return list as ProviderListFunction
11 | }
12 | 
13 | export function getModelListFunction(client: unknown): ModelListFunction | null {
14 | 	if (!isRecord(client)) return null
15 | 	const model = client["model"]
16 | 	if (!isRecord(model)) return null
17 | 	const list = model["list"]
18 | 	if (typeof list !== "function") return null
19 | 	return list as ModelListFunction
20 | }
21 | 


--------------------------------------------------------------------------------
/src/config/schema/tmux.ts:
--------------------------------------------------------------------------------
 1 | import { z } from "zod"
 2 | 
 3 | export const TmuxLayoutSchema = z.enum([
 4 |   "main-horizontal", // main pane top, agent panes bottom stack
 5 |   "main-vertical", // main pane left, agent panes right stack (default)
 6 |   "tiled", // all panes same size grid
 7 |   "even-horizontal", // all panes horizontal row
 8 |   "even-vertical", // all panes vertical stack
 9 | ])
10 | 
11 | export const TmuxConfigSchema = z.object({
12 |   enabled: z.boolean().default(false),
13 |   layout: TmuxLayoutSchema.default("main-vertical"),
14 |   main_pane_size: z.number().min(20).max(80).default(60),
15 |   main_pane_min_width: z.number().min(40).default(120),
16 |   agent_pane_min_width: z.number().min(20).default(40),
17 | })
18 | 
19 | export type TmuxConfig = z.infer<typeof TmuxConfigSchema>
20 | export type TmuxLayout = z.infer<typeof TmuxLayoutSchema>
21 | 


--------------------------------------------------------------------------------
/src/hooks/atlas/types.ts:
--------------------------------------------------------------------------------
 1 | import type { AgentOverrides } from "../../config"
 2 | import type { BackgroundManager } from "../../features/background-agent"
 3 | 
 4 | export type ModelInfo = { providerID: string; modelID: string }
 5 | 
 6 | export interface AtlasHookOptions {
 7 |   directory: string
 8 |   backgroundManager?: BackgroundManager
 9 |   isContinuationStopped?: (sessionID: string) => boolean
10 |   agentOverrides?: AgentOverrides
11 | }
12 | 
13 | export interface ToolExecuteAfterInput {
14 |   tool: string
15 |   sessionID?: string
16 |   callID?: string
17 | }
18 | 
19 | export interface ToolExecuteAfterOutput {
20 |   title: string
21 |   output: string
22 |   metadata: Record<string, unknown>
23 | }
24 | 
25 | export interface SessionState {
26 |   lastEventWasAbortError?: boolean
27 |   lastContinuationInjectedAt?: number
28 |   promptFailureCount: number
29 | }
30 | 


--------------------------------------------------------------------------------
/src/hooks/atlas/is-abort-error.ts:
--------------------------------------------------------------------------------
 1 | export function isAbortError(error: unknown): boolean {
 2 |   if (!error) return false
 3 | 
 4 |   if (typeof error === "object") {
 5 |     const errObj = error as Record<string, unknown>
 6 |     const name = errObj.name as string | undefined
 7 |     const message = (errObj.message as string | undefined)?.toLowerCase() ?? ""
 8 | 
 9 |     if (name === "MessageAbortedError" || name === "AbortError") return true
10 |     if (name === "DOMException" && message.includes("abort")) return true
11 |     if (message.includes("aborted") || message.includes("cancelled") || message.includes("interrupted")) return true
12 |   }
13 | 
14 |   if (typeof error === "string") {
15 |     const lower = error.toLowerCase()
16 |     return lower.includes("abort") || lower.includes("cancel") || lower.includes("interrupt")
17 |   }
18 | 
19 |   return false
20 | }
21 | 


--------------------------------------------------------------------------------
/src/hooks/comment-checker/types.ts:
--------------------------------------------------------------------------------
 1 | export type CommentType = "line" | "block" | "docstring"
 2 | 
 3 | export interface CommentInfo {
 4 |   text: string
 5 |   lineNumber: number
 6 |   filePath: string
 7 |   commentType: CommentType
 8 |   isDocstring: boolean
 9 |   metadata?: Record<string, string>
10 | }
11 | 
12 | export interface PendingCall {
13 |   filePath: string
14 |   content?: string
15 |   oldString?: string
16 |   newString?: string
17 |   edits?: Array<{ old_string: string; new_string: string }>
18 |   tool: "write" | "edit" | "multiedit"
19 |   sessionID: string
20 |   timestamp: number
21 | }
22 | 
23 | export interface FileComments {
24 |   filePath: string
25 |   comments: CommentInfo[]
26 | }
27 | 
28 | export interface FilterResult {
29 |   shouldSkip: boolean
30 |   reason?: string
31 | }
32 | 
33 | export type CommentFilter = (comment: CommentInfo) => FilterResult
34 | 


--------------------------------------------------------------------------------
/src/tools/slashcommand/types.ts:
--------------------------------------------------------------------------------
 1 | import type { LoadedSkill, LazyContentLoader } from "../../features/opencode-skill-loader"
 2 | 
 3 | export type CommandScope = "builtin" | "config" | "user" | "project" | "opencode" | "opencode-project"
 4 | 
 5 | export interface CommandMetadata {
 6 |   name: string
 7 |   description: string
 8 |   argumentHint?: string
 9 |   model?: string
10 |   agent?: string
11 |   subtask?: boolean
12 | }
13 | 
14 | export interface CommandInfo {
15 |   name: string
16 |   path?: string
17 |   metadata: CommandMetadata
18 |   content?: string
19 |   scope: CommandScope
20 |   lazyContentLoader?: LazyContentLoader
21 | }
22 | 
23 | export interface SlashcommandToolOptions {
24 |   /** Pre-loaded commands (skip discovery if provided) */
25 |   commands?: CommandInfo[]
26 |   /** Pre-loaded skills (skip discovery if provided) */
27 |   skills?: LoadedSkill[]
28 | }
29 | 


--------------------------------------------------------------------------------
/src/hooks/session-recovery/storage/part-content.ts:
--------------------------------------------------------------------------------
 1 | import { THINKING_TYPES, META_TYPES } from "../constants"
 2 | import type { StoredPart, StoredTextPart } from "../types"
 3 | import { readParts } from "./parts-reader"
 4 | 
 5 | export function hasContent(part: StoredPart): boolean {
 6 |   if (THINKING_TYPES.has(part.type)) return false
 7 |   if (META_TYPES.has(part.type)) return false
 8 | 
 9 |   if (part.type === "text") {
10 |     const textPart = part as StoredTextPart
11 |     return !!textPart.text?.trim()
12 |   }
13 | 
14 |   if (part.type === "tool" || part.type === "tool_use") {
15 |     return true
16 |   }
17 | 
18 |   if (part.type === "tool_result") {
19 |     return true
20 |   }
21 | 
22 |   return false
23 | }
24 | 
25 | export function messageHasContent(messageID: string): boolean {
26 |   const parts = readParts(messageID)
27 |   return parts.some(hasContent)
28 | }
29 | 


--------------------------------------------------------------------------------
/src/tools/grep/types.ts:
--------------------------------------------------------------------------------
 1 | export interface GrepMatch {
 2 |   file: string
 3 |   line: number
 4 |   column?: number
 5 |   text: string
 6 | }
 7 | 
 8 | export interface GrepResult {
 9 |   matches: GrepMatch[]
10 |   totalMatches: number
11 |   filesSearched: number
12 |   truncated: boolean
13 |   error?: string
14 | }
15 | 
16 | export interface GrepOptions {
17 |   pattern: string
18 |   paths?: string[]
19 |   globs?: string[]
20 |   excludeGlobs?: string[]
21 |   context?: number
22 |   maxDepth?: number
23 |   maxFilesize?: string
24 |   maxCount?: number
25 |   maxColumns?: number
26 |   caseSensitive?: boolean
27 |   wholeWord?: boolean
28 |   fixedStrings?: boolean
29 |   multiline?: boolean
30 |   hidden?: boolean
31 |   noIgnore?: boolean
32 |   fileType?: string[]
33 |   timeout?: number
34 | }
35 | 
36 | export interface CountResult {
37 |   file: string
38 |   count: number
39 | }
40 | 


--------------------------------------------------------------------------------
/src/tools/lsp/lsp-manager-temp-directory-cleanup.ts:
--------------------------------------------------------------------------------
 1 | type ManagedClientForTempDirectoryCleanup = {
 2 |   refCount: number
 3 |   client: {
 4 |     stop: () => Promise<void>
 5 |   }
 6 | }
 7 | 
 8 | export async function cleanupTempDirectoryLspClients(
 9 |   clients: Map<string, ManagedClientForTempDirectoryCleanup>
10 | ): Promise<void> {
11 |   const keysToRemove: string[] = []
12 |   for (const [key, managed] of clients.entries()) {
13 |     const isTempDir = key.startsWith("/tmp/") || key.startsWith("/var/folders/")
14 |     const isIdle = managed.refCount === 0
15 |     if (isTempDir && isIdle) {
16 |       keysToRemove.push(key)
17 |     }
18 |   }
19 | 
20 |   for (const key of keysToRemove) {
21 |     const managed = clients.get(key)
22 |     if (managed) {
23 |       clients.delete(key)
24 |       try {
25 |         await managed.client.stop()
26 |       } catch {}
27 |     }
28 |   }
29 | }
30 | 


--------------------------------------------------------------------------------
/src/features/claude-code-plugin-loader/plugin-path-resolver.ts:
--------------------------------------------------------------------------------
 1 | const CLAUDE_PLUGIN_ROOT_VAR = "${CLAUDE_PLUGIN_ROOT}"
 2 | 
 3 | export function resolvePluginPath(path: string, pluginRoot: string): string {
 4 |   return path.replace(CLAUDE_PLUGIN_ROOT_VAR, pluginRoot)
 5 | }
 6 | 
 7 | export function resolvePluginPaths<T>(obj: T, pluginRoot: string): T {
 8 |   if (obj === null || obj === undefined) return obj
 9 |   if (typeof obj === "string") {
10 |     return resolvePluginPath(obj, pluginRoot) as T
11 |   }
12 |   if (Array.isArray(obj)) {
13 |     return obj.map((item) => resolvePluginPaths(item, pluginRoot)) as T
14 |   }
15 |   if (typeof obj === "object") {
16 |     const result: Record<string, unknown> = {}
17 |     for (const [key, value] of Object.entries(obj)) {
18 |       result[key] = resolvePluginPaths(value, pluginRoot)
19 |     }
20 |     return result as T
21 |   }
22 |   return obj
23 | }
24 | 


--------------------------------------------------------------------------------
/src/tools/call-omo-agent/types.ts:
--------------------------------------------------------------------------------
 1 | import type { ALLOWED_AGENTS } from "./constants"
 2 | 
 3 | export type AllowedAgentType = (typeof ALLOWED_AGENTS)[number]
 4 | 
 5 | export interface CallOmoAgentArgs {
 6 |   description: string
 7 |   prompt: string
 8 |   subagent_type: string
 9 |   run_in_background: boolean
10 |   session_id?: string
11 | }
12 | 
13 | export interface CallOmoAgentSyncResult {
14 |   title: string
15 |   metadata: {
16 |     summary?: Array<{
17 |       id: string
18 |       tool: string
19 |       state: {
20 |         status: string
21 |         title?: string
22 |       }
23 |     }>
24 |     sessionId: string
25 |   }
26 |   output: string
27 | }
28 | export type ToolContextWithMetadata = {
29 |   sessionID: string
30 |   messageID: string
31 |   agent: string
32 |   abort: AbortSignal
33 |   metadata?: (input: { title?: string; metadata?: Record<string, unknown> }) => void
34 | }
35 | 


--------------------------------------------------------------------------------
/src/features/boulder-state/types.ts:
--------------------------------------------------------------------------------
 1 | /**
 2 |  * Boulder State Types
 3 |  *
 4 |  * Manages the active work plan state for Sisyphus orchestrator.
 5 |  * Named after Sisyphus's boulder - the eternal task that must be rolled.
 6 |  */
 7 | 
 8 | export interface BoulderState {
 9 |   /** Absolute path to the active plan file */
10 |   active_plan: string
11 |   /** ISO timestamp when work started */
12 |   started_at: string
13 |   /** Session IDs that have worked on this plan */
14 |   session_ids: string[]
15 |   /** Plan name derived from filename */
16 |   plan_name: string
17 |   /** Agent type to use when resuming (e.g., 'atlas') */
18 |   agent?: string
19 | }
20 | 
21 | export interface PlanProgress {
22 |   /** Total number of checkboxes */
23 |   total: number
24 |   /** Number of completed checkboxes */
25 |   completed: number
26 |   /** Whether all tasks are done */
27 |   isComplete: boolean
28 | }
29 | 


--------------------------------------------------------------------------------
/src/hooks/auto-update-checker/checker.test.ts:
--------------------------------------------------------------------------------
 1 | import { describe, test, expect } from "bun:test"
 2 | import { getLatestVersion } from "./checker"
 3 | 
 4 | describe("auto-update-checker/checker", () => {
 5 |   describe("getLatestVersion", () => {
 6 |     test("accepts channel parameter", async () => {
 7 |       const result = await getLatestVersion("beta")
 8 |       
 9 |       expect(typeof result === "string" || result === null).toBe(true)
10 |     })
11 | 
12 |     test("accepts latest channel", async () => {
13 |       const result = await getLatestVersion("latest")
14 |       
15 |       expect(typeof result === "string" || result === null).toBe(true)
16 |     })
17 | 
18 |     test("works without channel (defaults to latest)", async () => {
19 |       const result = await getLatestVersion()
20 |       
21 |       expect(typeof result === "string" || result === null).toBe(true)
22 |     })
23 |   })
24 | })
25 | 


--------------------------------------------------------------------------------
/src/plugin-handlers/agent-priority-order.ts:
--------------------------------------------------------------------------------
 1 | import { getAgentDisplayName } from "../shared/agent-display-names";
 2 | 
 3 | const CORE_AGENT_ORDER = [
 4 |   getAgentDisplayName("sisyphus"),
 5 |   getAgentDisplayName("hephaestus"),
 6 |   getAgentDisplayName("prometheus"),
 7 |   getAgentDisplayName("atlas"),
 8 | ] as const;
 9 | 
10 | export function reorderAgentsByPriority(
11 |   agents: Record<string, unknown>,
12 | ): Record<string, unknown> {
13 |   const ordered: Record<string, unknown> = {};
14 |   const seen = new Set<string>();
15 | 
16 |   for (const key of CORE_AGENT_ORDER) {
17 |     if (Object.prototype.hasOwnProperty.call(agents, key)) {
18 |       ordered[key] = agents[key];
19 |       seen.add(key);
20 |     }
21 |   }
22 | 
23 |   for (const [key, value] of Object.entries(agents)) {
24 |     if (!seen.has(key)) {
25 |       ordered[key] = value;
26 |     }
27 |   }
28 | 
29 |   return ordered;
30 | }
31 | 


--------------------------------------------------------------------------------
/.github/FUNDING.yml:
--------------------------------------------------------------------------------
 1 | # These are supported funding model platforms
 2 | 
 3 | github: code-yeongyu
 4 | patreon: # Replace with a single Patreon username
 5 | open_collective: # Replace with a single Open Collective username
 6 | ko_fi: # Replace with a single Ko-fi username
 7 | tidelift: # Replace with a single Tidelift platform-name/package-name e.g., npm/babel
 8 | community_bridge: # Replace with a single Community Bridge project-name e.g., cloud-foundry
 9 | liberapay: # Replace with a single Liberapay username
10 | issuehunt: # Replace with a single IssueHunt username
11 | lfx_crowdfunding: # Replace with a single LFX Crowdfunding project-name e.g., cloud-foundry
12 | polar: # Replace with a single Polar username
13 | buy_me_a_coffee: # Replace with a single Buy Me a Coffee username
14 | thanks_dev: # Replace with a single thanks.dev username
15 | custom: # Replace with up to 4 custom sponsorship URLs e.g., ['link1', 'link2']
16 | 


--------------------------------------------------------------------------------
/src/plugin/available-categories.ts:
--------------------------------------------------------------------------------
 1 | import type { AvailableCategory } from "../agents/dynamic-agent-prompt-builder"
 2 | import type { OhMyOpenCodeConfig } from "../config"
 3 | import { CATEGORY_DESCRIPTIONS } from "../tools/delegate-task/constants"
 4 | import { mergeCategories } from "../shared/merge-categories"
 5 | 
 6 | export function createAvailableCategories(
 7 |   pluginConfig: OhMyOpenCodeConfig,
 8 | ): AvailableCategory[] {
 9 |   const categories = mergeCategories(pluginConfig.categories)
10 | 
11 |   return Object.entries(categories).map(([name, categoryConfig]) => {
12 |     const model =
13 |       typeof categoryConfig.model === "string" ? categoryConfig.model : undefined
14 | 
15 |     return {
16 |       name,
17 |       description:
18 |         pluginConfig.categories?.[name]?.description ??
19 |         CATEGORY_DESCRIPTIONS[name] ??
20 |         "General tasks",
21 |       model,
22 |     }
23 |   })
24 | }
25 | 


--------------------------------------------------------------------------------
/src/hooks/atlas/session-last-agent.ts:
--------------------------------------------------------------------------------
 1 | import type { PluginInput } from "@opencode-ai/plugin"
 2 | 
 3 | import { findNearestMessageWithFields } from "../../features/hook-message-injector"
 4 | import { findNearestMessageWithFieldsFromSDK } from "../../features/hook-message-injector"
 5 | import { getMessageDir, isSqliteBackend } from "../../shared"
 6 | 
 7 | type OpencodeClient = PluginInput["client"]
 8 | 
 9 | export async function getLastAgentFromSession(
10 |   sessionID: string,
11 |   client?: OpencodeClient
12 | ): Promise<string | null> {
13 |   let nearest = null
14 | 
15 |   if (isSqliteBackend() && client) {
16 |     nearest = await findNearestMessageWithFieldsFromSDK(client, sessionID)
17 |   } else {
18 |     const messageDir = getMessageDir(sessionID)
19 |     if (!messageDir) return null
20 |     nearest = findNearestMessageWithFields(messageDir)
21 |   }
22 | 
23 |   return nearest?.agent?.toLowerCase() ?? null
24 | }
25 | 


--------------------------------------------------------------------------------
/src/hooks/auto-slash-command/types.ts:
--------------------------------------------------------------------------------
 1 | export interface AutoSlashCommandHookInput {
 2 |   sessionID: string
 3 |   agent?: string
 4 |   model?: { providerID: string; modelID: string }
 5 |   messageID?: string
 6 | }
 7 | 
 8 | export interface AutoSlashCommandHookOutput {
 9 |   message: Record<string, unknown>
10 |   parts: Array<{ type: string; text?: string; [key: string]: unknown }>
11 | }
12 | 
13 | export interface ParsedSlashCommand {
14 |   command: string
15 |   args: string
16 |   raw: string
17 | }
18 | 
19 | export interface AutoSlashCommandResult {
20 |   detected: boolean
21 |   parsedCommand?: ParsedSlashCommand
22 |   injectedMessage?: string
23 | }
24 | 
25 | export interface CommandExecuteBeforeInput {
26 |   command: string
27 |   sessionID: string
28 |   arguments: string
29 | }
30 | 
31 | export interface CommandExecuteBeforeOutput {
32 |   parts: Array<{ type: string; text?: string; [key: string]: unknown }>
33 | }
34 | 


--------------------------------------------------------------------------------
/src/hooks/auto-update-checker/hook/spinner-toast.ts:
--------------------------------------------------------------------------------
 1 | import type { PluginInput } from "@opencode-ai/plugin"
 2 | 
 3 | const SISYPHUS_SPINNER = ["·", "•", "●", "○", "◌", "◦", " "]
 4 | 
 5 | export async function showSpinnerToast(ctx: PluginInput, version: string, message: string): Promise<void> {
 6 |   const totalDuration = 5000
 7 |   const frameInterval = 100
 8 |   const totalFrames = Math.floor(totalDuration / frameInterval)
 9 | 
10 |   for (let i = 0; i < totalFrames; i++) {
11 |     const spinner = SISYPHUS_SPINNER[i % SISYPHUS_SPINNER.length]
12 |     await ctx.client.tui
13 |       .showToast({
14 |         body: {
15 |           title: `${spinner} OhMyOpenCode ${version}`,
16 |           message,
17 |           variant: "info" as const,
18 |           duration: frameInterval + 50,
19 |         },
20 |       })
21 |       .catch(() => {})
22 | 
23 |     await new Promise((resolve) => setTimeout(resolve, frameInterval))
24 |   }
25 | }
26 | 


--------------------------------------------------------------------------------
/src/shared/tmux/tmux-utils/pane-dimensions.ts:
--------------------------------------------------------------------------------
 1 | import { spawn } from "bun"
 2 | import { getTmuxPath } from "../../../tools/interactive-bash/tmux-path-resolver"
 3 | 
 4 | export interface PaneDimensions {
 5 | 	paneWidth: number
 6 | 	windowWidth: number
 7 | }
 8 | 
 9 | export async function getPaneDimensions(
10 | 	paneId: string,
11 | ): Promise<PaneDimensions | null> {
12 | 	const tmux = await getTmuxPath()
13 | 	if (!tmux) return null
14 | 
15 | 	const proc = spawn(
16 | 		[tmux, "display", "-p", "-t", paneId, "#{pane_width},#{window_width}"],
17 | 		{ stdout: "pipe", stderr: "pipe" },
18 | 	)
19 | 	const exitCode = await proc.exited
20 | 	const stdout = await new Response(proc.stdout).text()
21 | 
22 | 	if (exitCode !== 0) return null
23 | 
24 | 	const [paneWidth, windowWidth] = stdout.trim().split(",").map(Number)
25 | 	if (Number.isNaN(paneWidth) || Number.isNaN(windowWidth)) return null
26 | 
27 | 	return { paneWidth, windowWidth }
28 | }
29 | 


--------------------------------------------------------------------------------
/src/tools/background-task/session-messages.ts:
--------------------------------------------------------------------------------
 1 | import type { BackgroundOutputMessage, BackgroundOutputMessagesResult } from "./clients"
 2 | 
 3 | export function getErrorMessage(value: BackgroundOutputMessagesResult): string | null {
 4 |   if (Array.isArray(value)) return null
 5 |   if (value.error === undefined || value.error === null) return null
 6 |   if (typeof value.error === "string" && value.error.length > 0) return value.error
 7 |   return String(value.error)
 8 | }
 9 | 
10 | function isSessionMessage(value: unknown): value is BackgroundOutputMessage {
11 |   return typeof value === "object" && value !== null
12 | }
13 | 
14 | export function extractMessages(value: BackgroundOutputMessagesResult): BackgroundOutputMessage[] {
15 |   if (Array.isArray(value)) {
16 |     return value.filter(isSessionMessage)
17 |   }
18 |   if (Array.isArray(value.data)) {
19 |     return value.data.filter(isSessionMessage)
20 |   }
21 |   return []
22 | }
23 | 


--------------------------------------------------------------------------------
/.opencode/background-tasks.json:
--------------------------------------------------------------------------------
 1 | [
 2 |   {
 3 |     "id": "bg_wzsdt60b",
 4 |     "sessionID": "ses_4f3e89f0dffeooeXNVx5QCifse",
 5 |     "parentSessionID": "ses_4f3e8d141ffeyfJ1taVVOdQTzx",
 6 |     "parentMessageID": "msg_b0c172ee1001w2B52VSZrP08PJ",
 7 |     "description": "Explore opencode in codebase",
 8 |     "agent": "explore",
 9 |     "status": "completed",
10 |     "startedAt": "2025-12-11T06:26:57.395Z",
11 |     "completedAt": "2025-12-11T06:27:36.778Z"
12 |   },
13 |   {
14 |     "id": "bg_392b9c9b",
15 |     "sessionID": "ses_4f38ebf4fffeJZBocIn3UVv7vE",
16 |     "parentSessionID": "ses_4f38eefa0ffeKV0pVNnwT37P5L",
17 |     "parentMessageID": "msg_b0c7110d2001TMBlPeEYIrByvs",
18 |     "description": "Test explore agent",
19 |     "agent": "explore",
20 |     "status": "running",
21 |     "startedAt": "2025-12-11T08:05:07.378Z",
22 |     "progress": {
23 |       "toolCalls": 0,
24 |       "lastUpdate": "2025-12-11T08:05:07.378Z"
25 |     }
26 |   }
27 | ]


--------------------------------------------------------------------------------
/src/hooks/todo-continuation-enforcer/constants.ts:
--------------------------------------------------------------------------------
 1 | import { createSystemDirective, SystemDirectiveTypes } from "../../shared/system-directive"
 2 | 
 3 | export const HOOK_NAME = "todo-continuation-enforcer"
 4 | 
 5 | export const DEFAULT_SKIP_AGENTS = ["prometheus", "compaction"]
 6 | 
 7 | export const CONTINUATION_PROMPT = `${createSystemDirective(SystemDirectiveTypes.TODO_CONTINUATION)}
 8 | 
 9 | Incomplete tasks remain in your todo list. Continue working on the next pending task.
10 | 
11 | - Proceed without asking for permission
12 | - Mark each task complete when finished
13 | - Do not stop until all tasks are done`
14 | 
15 | export const COUNTDOWN_SECONDS = 2
16 | export const TOAST_DURATION_MS = 900
17 | export const COUNTDOWN_GRACE_PERIOD_MS = 500
18 | 
19 | export const ABORT_WINDOW_MS = 3000
20 | export const CONTINUATION_COOLDOWN_MS = 30_000
21 | export const MAX_CONSECUTIVE_FAILURES = 5
22 | export const FAILURE_RESET_WINDOW_MS = 5 * 60 * 1000
23 | 


--------------------------------------------------------------------------------
/src/mcp/index.ts:
--------------------------------------------------------------------------------
 1 | import { createWebsearchConfig } from "./websearch"
 2 | import { context7 } from "./context7"
 3 | import { grep_app } from "./grep-app"
 4 | import type { OhMyOpenCodeConfig } from "../config/schema"
 5 | 
 6 | export { McpNameSchema, type McpName } from "./types"
 7 | 
 8 | type RemoteMcpConfig = {
 9 |   type: "remote"
10 |   url: string
11 |   enabled: boolean
12 |   headers?: Record<string, string>
13 |   oauth?: false
14 | }
15 | 
16 | export function createBuiltinMcps(disabledMcps: string[] = [], config?: OhMyOpenCodeConfig) {
17 |   const mcps: Record<string, RemoteMcpConfig> = {}
18 | 
19 |   if (!disabledMcps.includes("websearch")) {
20 |     mcps.websearch = createWebsearchConfig(config?.websearch)
21 |   }
22 | 
23 |   if (!disabledMcps.includes("context7")) {
24 |     mcps.context7 = context7
25 |   }
26 | 
27 |   if (!disabledMcps.includes("grep_app")) {
28 |     mcps.grep_app = grep_app
29 |   }
30 | 
31 |   return mcps
32 | }
33 | 


--------------------------------------------------------------------------------
/src/index.compaction-model-agnostic.static.test.ts:
--------------------------------------------------------------------------------
 1 | import { describe, expect, test } from "bun:test"
 2 | import { readFileSync } from "node:fs"
 3 | 
 4 | describe("experimental.session.compacting", () => {
 5 |   test("does not hardcode a model and uses output.context", () => {
 6 |     //#given
 7 |     const indexUrl = new URL("./index.ts", import.meta.url)
 8 |     const content = readFileSync(indexUrl, "utf-8")
 9 |     const hookIndex = content.indexOf('"experimental.session.compacting"')
10 | 
11 |     //#when
12 |     const hookSlice = hookIndex >= 0 ? content.slice(hookIndex, hookIndex + 1200) : ""
13 | 
14 |     //#then
15 |     expect(hookIndex).toBeGreaterThanOrEqual(0)
16 |     expect(content.includes('modelID: "claude-opus-4-6"')).toBe(false)
17 |     expect(hookSlice.includes("output.context.push")).toBe(true)
18 |     expect(hookSlice.includes("providerID:")).toBe(false)
19 |     expect(hookSlice.includes("modelID:")).toBe(false)
20 |   })
21 | })
22 | 


--------------------------------------------------------------------------------
/src/hooks/rules-injector/cache.ts:
--------------------------------------------------------------------------------
 1 | import { clearInjectedRules, loadInjectedRules } from "./storage";
 2 | 
 3 | export type SessionInjectedRulesCache = {
 4 |   contentHashes: Set<string>;
 5 |   realPaths: Set<string>;
 6 | };
 7 | 
 8 | export function createSessionCacheStore(): {
 9 |   getSessionCache: (sessionID: string) => SessionInjectedRulesCache;
10 |   clearSessionCache: (sessionID: string) => void;
11 | } {
12 |   const sessionCaches = new Map<string, SessionInjectedRulesCache>();
13 | 
14 |   function getSessionCache(sessionID: string): SessionInjectedRulesCache {
15 |     if (!sessionCaches.has(sessionID)) {
16 |       sessionCaches.set(sessionID, loadInjectedRules(sessionID));
17 |     }
18 |     return sessionCaches.get(sessionID)!;
19 |   }
20 | 
21 |   function clearSessionCache(sessionID: string): void {
22 |     sessionCaches.delete(sessionID);
23 |     clearInjectedRules(sessionID);
24 |   }
25 | 
26 |   return { getSessionCache, clearSessionCache };
27 | }
28 | 


--------------------------------------------------------------------------------
/src/hooks/anthropic-context-window-limit-recovery/tool-part-types.ts:
--------------------------------------------------------------------------------
 1 | export interface StoredToolPart {
 2 | 	id: string
 3 | 	sessionID: string
 4 | 	messageID: string
 5 | 	type: "tool"
 6 | 	callID: string
 7 | 	tool: string
 8 | 	state: {
 9 | 		status: "pending" | "running" | "completed" | "error"
10 | 		input: Record<string, unknown>
11 | 		output?: string
12 | 		error?: string
13 | 		time?: {
14 | 			start: number
15 | 			end?: number
16 | 			compacted?: number
17 | 		}
18 | 	}
19 | 	truncated?: boolean
20 | 	originalSize?: number
21 | }
22 | 
23 | export interface ToolResultInfo {
24 | 	partPath: string
25 | 	partId: string
26 | 	messageID: string
27 | 	toolName: string
28 | 	outputSize: number
29 | }
30 | 
31 | export interface AggressiveTruncateResult {
32 | 	success: boolean
33 | 	sufficient: boolean
34 | 	truncatedCount: number
35 | 	totalBytesRemoved: number
36 | 	targetBytesToRemove: number
37 | 	truncatedTools: Array<{ toolName: string; originalSize: number }>
38 | }
39 | 


--------------------------------------------------------------------------------
/src/hooks/auto-update-checker/hook/config-errors-toast.ts:
--------------------------------------------------------------------------------
 1 | import type { PluginInput } from "@opencode-ai/plugin"
 2 | import { getConfigLoadErrors, clearConfigLoadErrors } from "../../../shared/config-errors"
 3 | import { log } from "../../../shared/logger"
 4 | 
 5 | export async function showConfigErrorsIfAny(ctx: PluginInput): Promise<void> {
 6 |   const errors = getConfigLoadErrors()
 7 |   if (errors.length === 0) return
 8 | 
 9 |   const errorMessages = errors.map((error: { path: string; error: string }) => `${error.path}: ${error.error}`).join("\n")
10 |   await ctx.client.tui
11 |     .showToast({
12 |       body: {
13 |         title: "Config Load Error",
14 |         message: `Failed to load config:\n${errorMessages}`,
15 |         variant: "error" as const,
16 |         duration: 10000,
17 |       },
18 |     })
19 |     .catch(() => {})
20 | 
21 |   log(`[auto-update-checker] Config load errors shown: ${errors.length} error(s)`) 
22 |   clearConfigLoadErrors()
23 | }
24 | 


--------------------------------------------------------------------------------
/src/shared/command-executor/execute-command.ts:
--------------------------------------------------------------------------------
 1 | import { exec } from "node:child_process"
 2 | import { promisify } from "node:util"
 3 | 
 4 | const execAsync = promisify(exec)
 5 | 
 6 | type ExecError = { stdout?: Buffer; stderr?: Buffer; message?: string }
 7 | 
 8 | export async function executeCommand(command: string): Promise<string> {
 9 | 	try {
10 | 		const { stdout, stderr } = await execAsync(command)
11 | 
12 | 		const out = stdout?.toString().trim() ?? ""
13 | 		const err = stderr?.toString().trim() ?? ""
14 | 
15 | 		if (err) {
16 | 			return out ? `${out}\n[stderr: ${err}]` : `[stderr: ${err}]`
17 | 		}
18 | 
19 | 		return out
20 | 	} catch (error: unknown) {
21 | 		const e = error as ExecError
22 | 		const stdout = e?.stdout?.toString().trim() ?? ""
23 | 		const stderr = e?.stderr?.toString().trim() ?? ""
24 | 		const errorMessage = stderr || e?.message || String(error)
25 | 
26 | 		return stdout ? `${stdout}\n[stderr: ${errorMessage}]` : `[stderr: ${errorMessage}]`
27 | 	}
28 | }
29 | 


--------------------------------------------------------------------------------
/src/shared/normalize-sdk-response.ts:
--------------------------------------------------------------------------------
 1 | export interface NormalizeSDKResponseOptions {
 2 |   preferResponseOnMissingData?: boolean
 3 | }
 4 | 
 5 | export function normalizeSDKResponse<TData>(
 6 |   response: unknown,
 7 |   fallback: TData,
 8 |   options?: NormalizeSDKResponseOptions,
 9 | ): TData {
10 |   if (response === null || response === undefined) {
11 |     return fallback
12 |   }
13 | 
14 |   if (Array.isArray(response)) {
15 |     return response as TData
16 |   }
17 | 
18 |   if (typeof response === "object" && "data" in response) {
19 |     const data = (response as { data?: unknown }).data
20 |     if (data !== null && data !== undefined) {
21 |       return data as TData
22 |     }
23 | 
24 |     if (options?.preferResponseOnMissingData === true) {
25 |       return response as TData
26 |     }
27 | 
28 |     return fallback
29 |   }
30 | 
31 |   if (options?.preferResponseOnMissingData === true) {
32 |     return response as TData
33 |   }
34 | 
35 |   return fallback
36 | }
37 | 


--------------------------------------------------------------------------------
/src/tools/call-omo-agent/subagent-session-prompter.ts:
--------------------------------------------------------------------------------
 1 | import type { PluginInput } from "@opencode-ai/plugin"
 2 | import { log, getAgentToolRestrictions } from "../../shared"
 3 | 
 4 | export async function promptSubagentSession(
 5 | 	ctx: PluginInput,
 6 | 	options: { sessionID: string; agent: string; prompt: string },
 7 | ): Promise<{ ok: true } | { ok: false; error: string }> {
 8 | 	try {
 9 | 		await ctx.client.session.promptAsync({
10 | 			path: { id: options.sessionID },
11 | 			body: {
12 | 				agent: options.agent,
13 | 				tools: {
14 | 					...getAgentToolRestrictions(options.agent),
15 | 					task: false,
16 | 					question: false,
17 | 				},
18 | 				parts: [{ type: "text", text: options.prompt }],
19 | 			},
20 | 		})
21 | 		return { ok: true }
22 | 	} catch (error) {
23 | 		const errorMessage = error instanceof Error ? error.message : String(error)
24 | 		log("[call_omo_agent] Prompt error", { error: errorMessage })
25 | 		return { ok: false, error: errorMessage }
26 | 	}
27 | }
28 | 


--------------------------------------------------------------------------------
/src/features/background-agent/spawner/parent-directory-resolver.ts:
--------------------------------------------------------------------------------
 1 | import type { OpencodeClient } from "../constants"
 2 | import { log, resolveSessionDirectory } from "../../../shared"
 3 | 
 4 | export async function resolveParentDirectory(options: {
 5 |   client: OpencodeClient
 6 |   parentSessionID: string
 7 |   defaultDirectory: string
 8 | }): Promise<string> {
 9 |   const { client, parentSessionID, defaultDirectory } = options
10 | 
11 |   const parentSession = await client.session
12 |     .get({ path: { id: parentSessionID } })
13 |     .catch((error: unknown) => {
14 |       log(`[background-agent] Failed to get parent session: ${error}`)
15 |       return null
16 |     })
17 | 
18 |   const parentDirectory = resolveSessionDirectory({
19 |     parentDirectory: parentSession?.data?.directory,
20 |     fallbackDirectory: defaultDirectory,
21 |   })
22 |   log(`[background-agent] Parent dir: ${parentSession?.data?.directory}, using: ${parentDirectory}`)
23 |   return parentDirectory
24 | }
25 | 


--------------------------------------------------------------------------------
/src/hooks/tasks-todowrite-disabler/hook.ts:
--------------------------------------------------------------------------------
 1 | import { BLOCKED_TOOLS, REPLACEMENT_MESSAGE } from "./constants";
 2 | 
 3 | export interface TasksTodowriteDisablerConfig {
 4 |   experimental?: {
 5 |     task_system?: boolean;
 6 |   };
 7 | }
 8 | 
 9 | export function createTasksTodowriteDisablerHook(
10 |   config: TasksTodowriteDisablerConfig,
11 | ) {
12 |   const isTaskSystemEnabled = config.experimental?.task_system ?? false;
13 | 
14 |   return {
15 |     "tool.execute.before": async (
16 |       input: { tool: string; sessionID: string; callID: string },
17 |       _output: { args: Record<string, unknown> },
18 |     ) => {
19 |       if (!isTaskSystemEnabled) {
20 |         return;
21 |       }
22 | 
23 |       const toolName = input.tool as string;
24 |       if (
25 |         BLOCKED_TOOLS.some(
26 |           (blocked) => blocked.toLowerCase() === toolName.toLowerCase(),
27 |         )
28 |       ) {
29 |         throw new Error(REPLACEMENT_MESSAGE);
30 |       }
31 |     },
32 |   };
33 | }
34 | 


--------------------------------------------------------------------------------
/src/shared/first-message-variant.test.ts:
--------------------------------------------------------------------------------
 1 | import { describe, expect, test } from "bun:test"
 2 | import { createFirstMessageVariantGate } from "./first-message-variant"
 3 | 
 4 | describe("createFirstMessageVariantGate", () => {
 5 |   test("marks new sessions and clears after apply", () => {
 6 |     // given
 7 |     const gate = createFirstMessageVariantGate()
 8 | 
 9 |     // when
10 |     gate.markSessionCreated({ id: "session-1" })
11 | 
12 |     // then
13 |     expect(gate.shouldOverride("session-1")).toBe(true)
14 | 
15 |     // when
16 |     gate.markApplied("session-1")
17 | 
18 |     // then
19 |     expect(gate.shouldOverride("session-1")).toBe(false)
20 |   })
21 | 
22 |   test("ignores forked sessions", () => {
23 |     // given
24 |     const gate = createFirstMessageVariantGate()
25 | 
26 |     // when
27 |     gate.markSessionCreated({ id: "session-2", parentID: "session-parent" })
28 | 
29 |     // then
30 |     expect(gate.shouldOverride("session-2")).toBe(false)
31 |   })
32 | })
33 | 


--------------------------------------------------------------------------------
/src/config/schema.ts:
--------------------------------------------------------------------------------
 1 | export * from "./schema/agent-names"
 2 | export * from "./schema/agent-overrides"
 3 | export * from "./schema/babysitting"
 4 | export * from "./schema/background-task"
 5 | export * from "./schema/browser-automation"
 6 | export * from "./schema/categories"
 7 | export * from "./schema/claude-code"
 8 | export * from "./schema/comment-checker"
 9 | export * from "./schema/commands"
10 | export * from "./schema/dynamic-context-pruning"
11 | export * from "./schema/experimental"
12 | export * from "./schema/git-master"
13 | export * from "./schema/hooks"
14 | export * from "./schema/notification"
15 | export * from "./schema/oh-my-opencode-config"
16 | export * from "./schema/ralph-loop"
17 | export * from "./schema/skills"
18 | export * from "./schema/sisyphus"
19 | export * from "./schema/sisyphus-agent"
20 | export * from "./schema/tmux"
21 | export * from "./schema/websearch"
22 | 
23 | export { AnyMcpNameSchema, type AnyMcpName, McpNameSchema, type McpName } from "../mcp/types"
24 | 


--------------------------------------------------------------------------------
/src/features/claude-code-mcp-loader/env-expander.ts:
--------------------------------------------------------------------------------
 1 | export function expandEnvVars(value: string): string {
 2 |   return value.replace(
 3 |     /\$\{([^}:]+)(?::-([^}]*))?\}/g,
 4 |     (_, varName: string, defaultValue?: string) => {
 5 |       const envValue = process.env[varName]
 6 |       if (envValue !== undefined) return envValue
 7 |       if (defaultValue !== undefined) return defaultValue
 8 |       return ""
 9 |     }
10 |   )
11 | }
12 | 
13 | export function expandEnvVarsInObject<T>(obj: T): T {
14 |   if (obj === null || obj === undefined) return obj
15 |   if (typeof obj === "string") return expandEnvVars(obj) as T
16 |   if (Array.isArray(obj)) {
17 |     return obj.map((item) => expandEnvVarsInObject(item)) as T
18 |   }
19 |   if (typeof obj === "object") {
20 |     const result: Record<string, unknown> = {}
21 |     for (const [key, value] of Object.entries(obj)) {
22 |       result[key] = expandEnvVarsInObject(value)
23 |     }
24 |     return result as T
25 |   }
26 |   return obj
27 | }
28 | 


--------------------------------------------------------------------------------
/src/hooks/ralph-loop/loop-session-recovery.ts:
--------------------------------------------------------------------------------
 1 | type SessionState = {
 2 | 	isRecovering?: boolean
 3 | }
 4 | 
 5 | export function createLoopSessionRecovery(options?: { recoveryWindowMs?: number }) {
 6 | 	const recoveryWindowMs = options?.recoveryWindowMs ?? 5000
 7 | 	const sessions = new Map<string, SessionState>()
 8 | 
 9 | 	function getSessionState(sessionID: string): SessionState {
10 | 		let state = sessions.get(sessionID)
11 | 		if (!state) {
12 | 			state = {}
13 | 			sessions.set(sessionID, state)
14 | 		}
15 | 		return state
16 | 	}
17 | 
18 | 	return {
19 | 		isRecovering(sessionID: string): boolean {
20 | 			return getSessionState(sessionID).isRecovering === true
21 | 		},
22 | 		markRecovering(sessionID: string): void {
23 | 			const state = getSessionState(sessionID)
24 | 			state.isRecovering = true
25 | 			setTimeout(() => {
26 | 				state.isRecovering = false
27 | 			}, recoveryWindowMs)
28 | 		},
29 | 		clear(sessionID: string): void {
30 | 			sessions.delete(sessionID)
31 | 		},
32 | 	}
33 | }
34 | 


--------------------------------------------------------------------------------
/src/config/schema/browser-automation.ts:
--------------------------------------------------------------------------------
 1 | import { z } from "zod"
 2 | 
 3 | export const BrowserAutomationProviderSchema = z.enum([
 4 |   "playwright",
 5 |   "agent-browser",
 6 |   "dev-browser",
 7 |   "playwright-cli",
 8 | ])
 9 | 
10 | export const BrowserAutomationConfigSchema = z.object({
11 |   /**
12 |    * Browser automation provider to use for the "playwright" skill.
13 |    * - "playwright": Uses Playwright MCP server (@playwright/mcp) - default
14 |    * - "agent-browser": Uses Vercel's agent-browser CLI (requires: bun add -g agent-browser)
15 |    * - "dev-browser": Uses dev-browser skill with persistent browser state
16 |    * - "playwright-cli": Uses Playwright CLI (@playwright/cli) - token-efficient CLI alternative
17 |    */
18 |   provider: BrowserAutomationProviderSchema.default("playwright"),
19 | })
20 | 
21 | export type BrowserAutomationProvider = z.infer<
22 |   typeof BrowserAutomationProviderSchema
23 | >
24 | export type BrowserAutomationConfig = z.infer<typeof BrowserAutomationConfigSchema>
25 | 


--------------------------------------------------------------------------------
/src/features/claude-code-plugin-loader/hook-loader.ts:
--------------------------------------------------------------------------------
 1 | import { existsSync, readFileSync } from "fs"
 2 | import { log } from "../../shared/logger"
 3 | import type { HooksConfig, LoadedPlugin } from "./types"
 4 | import { resolvePluginPaths } from "./plugin-path-resolver"
 5 | 
 6 | export function loadPluginHooksConfigs(plugins: LoadedPlugin[]): HooksConfig[] {
 7 |   const configs: HooksConfig[] = []
 8 | 
 9 |   for (const plugin of plugins) {
10 |     if (!plugin.hooksPath || !existsSync(plugin.hooksPath)) continue
11 | 
12 |     try {
13 |       const content = readFileSync(plugin.hooksPath, "utf-8")
14 |       let config = JSON.parse(content) as HooksConfig
15 | 
16 |       config = resolvePluginPaths(config, plugin.installPath)
17 | 
18 |       configs.push(config)
19 |       log(`Loaded plugin hooks config from ${plugin.name}`, { path: plugin.hooksPath })
20 |     } catch (error) {
21 |       log(`Failed to load plugin hooks config: ${plugin.hooksPath}`, error)
22 |     }
23 |   }
24 | 
25 |   return configs
26 | }
27 | 


--------------------------------------------------------------------------------
/src/features/opencode-skill-loader/merger/builtin-skill-converter.ts:
--------------------------------------------------------------------------------
 1 | import type { BuiltinSkill } from "../../builtin-skills/types"
 2 | import type { CommandDefinition } from "../../claude-code-command-loader/types"
 3 | import type { LoadedSkill } from "../types"
 4 | 
 5 | export function builtinToLoadedSkill(builtin: BuiltinSkill): LoadedSkill {
 6 |   const definition: CommandDefinition = {
 7 |     name: builtin.name,
 8 |     description: `(opencode - Skill) ${builtin.description}`,
 9 |     template: builtin.template,
10 |     model: builtin.model,
11 |     agent: builtin.agent,
12 |     subtask: builtin.subtask,
13 |     argumentHint: builtin.argumentHint,
14 |   }
15 | 
16 |   return {
17 |     name: builtin.name,
18 |     definition,
19 |     scope: "builtin",
20 |     license: builtin.license,
21 |     compatibility: builtin.compatibility,
22 |     metadata: builtin.metadata as Record<string, string> | undefined,
23 |     allowedTools: builtin.allowedTools,
24 |     mcpConfig: builtin.mcpConfig,
25 |   }
26 | }
27 | 


--------------------------------------------------------------------------------
/src/config/schema/agent-names.ts:
--------------------------------------------------------------------------------
 1 | import { z } from "zod"
 2 | 
 3 | export const BuiltinAgentNameSchema = z.enum([
 4 |   "sisyphus",
 5 |   "hephaestus",
 6 |   "prometheus",
 7 |   "oracle",
 8 |   "librarian",
 9 |   "explore",
10 |   "multimodal-looker",
11 |   "metis",
12 |   "momus",
13 |   "atlas",
14 | ])
15 | 
16 | export const BuiltinSkillNameSchema = z.enum([
17 |   "playwright",
18 |   "agent-browser",
19 |   "dev-browser",
20 |   "frontend-ui-ux",
21 |   "git-master",
22 | ])
23 | 
24 | export const OverridableAgentNameSchema = z.enum([
25 |   "build",
26 |   "plan",
27 |   "sisyphus",
28 |   "hephaestus",
29 |   "sisyphus-junior",
30 |   "OpenCode-Builder",
31 |   "prometheus",
32 |   "metis",
33 |   "momus",
34 |   "oracle",
35 |   "librarian",
36 |   "explore",
37 |   "multimodal-looker",
38 |   "atlas",
39 | ])
40 | 
41 | export const AgentNameSchema = BuiltinAgentNameSchema
42 | export type AgentName = z.infer<typeof AgentNameSchema>
43 | 
44 | export type BuiltinSkillName = z.infer<typeof BuiltinSkillNameSchema>
45 | 


--------------------------------------------------------------------------------
/src/hooks/empty-task-response-detector.ts:
--------------------------------------------------------------------------------
 1 | import type { PluginInput } from "@opencode-ai/plugin"
 2 | 
 3 | const EMPTY_RESPONSE_WARNING = `[Task Empty Response Warning]
 4 | 
 5 | Task invocation completed but returned no response. This indicates the agent either:
 6 | - Failed to execute properly
 7 | - Did not terminate correctly
 8 | - Returned an empty result
 9 | 
10 | Note: The call has already completed - you are NOT waiting for a response. Proceed accordingly.`
11 | 
12 | export function createEmptyTaskResponseDetectorHook(_ctx: PluginInput) {
13 |   return {
14 |     "tool.execute.after": async (
15 |       input: { tool: string; sessionID: string; callID: string },
16 |       output: { title: string; output: string; metadata: unknown }
17 |     ) => {
18 |       if (input.tool !== "Task" && input.tool !== "task") return
19 | 
20 |       const responseText = output.output?.trim() ?? ""
21 | 
22 |       if (responseText === "") {
23 |         output.output = EMPTY_RESPONSE_WARNING
24 |       }
25 |     },
26 |   }
27 | }
28 | 


--------------------------------------------------------------------------------
/src/cli/doctor/checks/model-resolution-effective-model.ts:
--------------------------------------------------------------------------------
 1 | import type { ModelRequirement } from "../../../shared/model-requirements"
 2 | 
 3 | function formatProviderChain(providers: string[]): string {
 4 |   return providers.join(" → ")
 5 | }
 6 | 
 7 | export function getEffectiveModel(requirement: ModelRequirement, userOverride?: string): string {
 8 |   if (userOverride) {
 9 |     return userOverride
10 |   }
11 |   const firstEntry = requirement.fallbackChain[0]
12 |   if (!firstEntry) {
13 |     return "unknown"
14 |   }
15 |   return `${firstEntry.providers[0]}/${firstEntry.model}`
16 | }
17 | 
18 | export function buildEffectiveResolution(requirement: ModelRequirement, userOverride?: string): string {
19 |   if (userOverride) {
20 |     return `User override: ${userOverride}`
21 |   }
22 |   const firstEntry = requirement.fallbackChain[0]
23 |   if (!firstEntry) {
24 |     return "No fallback chain defined"
25 |   }
26 |   return `Provider fallback: ${formatProviderChain(firstEntry.providers)} → ${firstEntry.model}`
27 | }
28 | 


--------------------------------------------------------------------------------
/src/hooks/auto-update-checker/checker/package-json-locator.ts:
--------------------------------------------------------------------------------
 1 | import * as fs from "node:fs"
 2 | import * as path from "node:path"
 3 | import type { PackageJson } from "../types"
 4 | import { PACKAGE_NAME } from "../constants"
 5 | 
 6 | export function findPackageJsonUp(startPath: string): string | null {
 7 |   try {
 8 |     const stat = fs.statSync(startPath)
 9 |     let dir = stat.isDirectory() ? startPath : path.dirname(startPath)
10 | 
11 |     for (let i = 0; i < 10; i++) {
12 |       const pkgPath = path.join(dir, "package.json")
13 |       if (fs.existsSync(pkgPath)) {
14 |         try {
15 |           const content = fs.readFileSync(pkgPath, "utf-8")
16 |           const pkg = JSON.parse(content) as PackageJson
17 |           if (pkg.name === PACKAGE_NAME) return pkgPath
18 |         } catch {
19 |           // ignore
20 |         }
21 |       }
22 |       const parent = path.dirname(dir)
23 |       if (parent === dir) break
24 |       dir = parent
25 |     }
26 |   } catch {
27 |     // ignore
28 |   }
29 |   return null
30 | }
31 | 


--------------------------------------------------------------------------------
/src/hooks/auto-update-checker/hook/startup-toasts.ts:
--------------------------------------------------------------------------------
 1 | import type { PluginInput } from "@opencode-ai/plugin"
 2 | import { log } from "../../../shared/logger"
 3 | import { showSpinnerToast } from "./spinner-toast"
 4 | 
 5 | export async function showVersionToast(ctx: PluginInput, version: string | null, message: string): Promise<void> {
 6 |   const displayVersion = version ?? "unknown"
 7 |   await showSpinnerToast(ctx, displayVersion, message)
 8 |   log(`[auto-update-checker] Startup toast shown: v${displayVersion}`)
 9 | }
10 | 
11 | export async function showLocalDevToast(
12 |   ctx: PluginInput,
13 |   version: string | null,
14 |   isSisyphusEnabled: boolean
15 | ): Promise<void> {
16 |   const displayVersion = version ?? "dev"
17 |   const message = isSisyphusEnabled
18 |     ? "Sisyphus running in local development mode."
19 |     : "Running in local development mode. oMoMoMo..."
20 |   await showSpinnerToast(ctx, `${displayVersion} (dev)`, message)
21 |   log(`[auto-update-checker] Local dev toast shown: v${displayVersion}`)
22 | }
23 | 


--------------------------------------------------------------------------------
/src/hooks/auto-update-checker/version-channel.ts:
--------------------------------------------------------------------------------
 1 | export function isPrereleaseVersion(version: string): boolean {
 2 |   return version.includes("-")
 3 | }
 4 | 
 5 | export function isDistTag(version: string): boolean {
 6 |   const startsWithDigit = /^\d/.test(version)
 7 |   return !startsWithDigit
 8 | }
 9 | 
10 | export function isPrereleaseOrDistTag(pinnedVersion: string | null): boolean {
11 |   if (!pinnedVersion) return false
12 |   return isPrereleaseVersion(pinnedVersion) || isDistTag(pinnedVersion)
13 | }
14 | 
15 | export function extractChannel(version: string | null): string {
16 |   if (!version) return "latest"
17 | 
18 |   if (isDistTag(version)) {
19 |     return version
20 |   }
21 | 
22 |   if (isPrereleaseVersion(version)) {
23 |     const prereleasePart = version.split("-")[1]
24 |     if (prereleasePart) {
25 |       const channelMatch = prereleasePart.match(/^(alpha|beta|rc|canary|next)/)
26 |       if (channelMatch) {
27 |         return channelMatch[1]
28 |       }
29 |     }
30 |   }
31 | 
32 |   return "latest"
33 | }
34 | 


--------------------------------------------------------------------------------
/src/hooks/directory-readme-injector/finder.ts:
--------------------------------------------------------------------------------
 1 | import { existsSync } from "node:fs";
 2 | import { dirname, isAbsolute, join, resolve } from "node:path";
 3 | 
 4 | import { README_FILENAME } from "./constants";
 5 | 
 6 | export function resolveFilePath(rootDirectory: string, path: string): string | null {
 7 |   if (!path) return null;
 8 |   if (isAbsolute(path)) return path;
 9 |   return resolve(rootDirectory, path);
10 | }
11 | 
12 | export function findReadmeMdUp(input: {
13 |   startDir: string;
14 |   rootDir: string;
15 | }): string[] {
16 |   const found: string[] = [];
17 |   let current = input.startDir;
18 | 
19 |   while (true) {
20 |     const readmePath = join(current, README_FILENAME);
21 |     if (existsSync(readmePath)) {
22 |       found.push(readmePath);
23 |     }
24 | 
25 |     if (current === input.rootDir) break;
26 |     const parent = dirname(current);
27 |     if (parent === current) break;
28 |     if (!parent.startsWith(input.rootDir)) break;
29 |     current = parent;
30 |   }
31 | 
32 |   return found.reverse();
33 | }
34 | 


--------------------------------------------------------------------------------
/src/tools/background-task/clients.ts:
--------------------------------------------------------------------------------
 1 | import type { BackgroundManager } from "../../features/background-agent"
 2 | 
 3 | export type BackgroundOutputMessage = {
 4 |   id?: string
 5 |   info?: { role?: string; time?: string | { created?: number }; agent?: string }
 6 |   parts?: Array<{
 7 |     type?: string
 8 |     text?: string
 9 |     thinking?: string
10 |     content?: string | Array<{ type: string; text?: string }>
11 |     output?: string
12 |     name?: string
13 |   }>
14 | }
15 | 
16 | export type BackgroundOutputMessagesResult =
17 |   | { data?: BackgroundOutputMessage[]; error?: unknown }
18 |   | BackgroundOutputMessage[]
19 | 
20 | export type BackgroundOutputClient = {
21 |   session: {
22 |     messages: (args: { path: { id: string } }) => Promise<BackgroundOutputMessagesResult>
23 |   }
24 | }
25 | 
26 | export type BackgroundCancelClient = {
27 |   session: {
28 |     abort: (args: { path: { id: string } }) => Promise<unknown>
29 |   }
30 | }
31 | 
32 | export type BackgroundOutputManager = Pick<BackgroundManager, "getTask">
33 | 


--------------------------------------------------------------------------------
/src/hooks/keyword-detector/constants.ts:
--------------------------------------------------------------------------------
 1 | export const CODE_BLOCK_PATTERN = /```[\s\S]*?```/g
 2 | export const INLINE_CODE_PATTERN = /`[^`]+`/g
 3 | 
 4 | // Re-export from submodules
 5 | export { isPlannerAgent, getUltraworkMessage } from "./ultrawork"
 6 | export { SEARCH_PATTERN, SEARCH_MESSAGE } from "./search"
 7 | export { ANALYZE_PATTERN, ANALYZE_MESSAGE } from "./analyze"
 8 | 
 9 | import { getUltraworkMessage } from "./ultrawork"
10 | import { SEARCH_PATTERN, SEARCH_MESSAGE } from "./search"
11 | import { ANALYZE_PATTERN, ANALYZE_MESSAGE } from "./analyze"
12 | 
13 | export type KeywordDetector = {
14 |   pattern: RegExp
15 |   message: string | ((agentName?: string, modelID?: string) => string)
16 | }
17 | 
18 | export const KEYWORD_DETECTORS: KeywordDetector[] = [
19 |   {
20 |     pattern: /\b(ultrawork|ulw)\b/i,
21 |     message: getUltraworkMessage,
22 |   },
23 |   {
24 |     pattern: SEARCH_PATTERN,
25 |     message: SEARCH_MESSAGE,
26 |   },
27 |   {
28 |     pattern: ANALYZE_PATTERN,
29 |     message: ANALYZE_MESSAGE,
30 |   },
31 | ]
32 | 


--------------------------------------------------------------------------------
/src/cli/doctor/checks/model-resolution-types.ts:
--------------------------------------------------------------------------------
 1 | import type { ModelRequirement } from "../../../shared/model-requirements"
 2 | 
 3 | export interface AgentResolutionInfo {
 4 |   name: string
 5 |   requirement: ModelRequirement
 6 |   userOverride?: string
 7 |   userVariant?: string
 8 |   effectiveModel: string
 9 |   effectiveResolution: string
10 | }
11 | 
12 | export interface CategoryResolutionInfo {
13 |   name: string
14 |   requirement: ModelRequirement
15 |   userOverride?: string
16 |   userVariant?: string
17 |   effectiveModel: string
18 |   effectiveResolution: string
19 | }
20 | 
21 | export interface ModelResolutionInfo {
22 |   agents: AgentResolutionInfo[]
23 |   categories: CategoryResolutionInfo[]
24 | }
25 | 
26 | export interface OmoConfig {
27 |   agents?: Record<string, { model?: string; variant?: string; category?: string }>
28 |   categories?: Record<string, { model?: string; variant?: string }>
29 | }
30 | 
31 | export interface AvailableModelsInfo {
32 |   providers: string[]
33 |   modelCount: number
34 |   cacheExists: boolean
35 | }
36 | 


--------------------------------------------------------------------------------
/src/features/builtin-commands/templates/stop-continuation.test.ts:
--------------------------------------------------------------------------------
 1 | import { describe, expect, test } from "bun:test"
 2 | import { STOP_CONTINUATION_TEMPLATE } from "./stop-continuation"
 3 | 
 4 | describe("stop-continuation template", () => {
 5 |   test("should export a non-empty template string", () => {
 6 |     // given - the stop-continuation template
 7 | 
 8 |     // when - we access the template
 9 | 
10 |     // then - it should be a non-empty string
11 |     expect(typeof STOP_CONTINUATION_TEMPLATE).toBe("string")
12 |     expect(STOP_CONTINUATION_TEMPLATE.length).toBeGreaterThan(0)
13 |   })
14 | 
15 |   test("should describe the stop-continuation behavior", () => {
16 |     // given - the stop-continuation template
17 | 
18 |     // when - we check the content
19 | 
20 |     // then - it should mention key behaviors
21 |     expect(STOP_CONTINUATION_TEMPLATE).toContain("todo-continuation-enforcer")
22 |     expect(STOP_CONTINUATION_TEMPLATE).toContain("Ralph Loop")
23 |     expect(STOP_CONTINUATION_TEMPLATE).toContain("boulder state")
24 |   })
25 | })
26 | 


--------------------------------------------------------------------------------
/src/plugin/session-agent-resolver.ts:
--------------------------------------------------------------------------------
 1 | import { log } from "../shared"
 2 | import { normalizeSDKResponse } from "../shared"
 3 | 
 4 | interface SessionMessage {
 5 |   info?: {
 6 |     agent?: string
 7 |     role?: string
 8 |   }
 9 | }
10 | 
11 | type SessionClient = {
12 |   session: {
13 |     messages: (opts: { path: { id: string } }) => Promise<{ data?: SessionMessage[] }>
14 |   }
15 | }
16 | 
17 | export async function resolveSessionAgent(
18 |   client: SessionClient,
19 |   sessionId: string,
20 | ): Promise<string | undefined> {
21 |   try {
22 |     const messagesResp = await client.session.messages({ path: { id: sessionId } })
23 |     const messages = normalizeSDKResponse(messagesResp, [] as SessionMessage[])
24 | 
25 |     for (const msg of messages) {
26 |       if (msg.info?.agent) {
27 |         return msg.info.agent
28 |       }
29 |     }
30 |   } catch (error) {
31 |     log("[session-agent-resolver] Failed to resolve agent from session", {
32 |       sessionId,
33 |       error: String(error),
34 |     })
35 |   }
36 |   return undefined
37 | }
38 | 


--------------------------------------------------------------------------------
/src/shared/frontmatter.ts:
--------------------------------------------------------------------------------
 1 | import yaml from "js-yaml"
 2 | 
 3 | export interface FrontmatterResult<T = Record<string, unknown>> {
 4 |   data: T
 5 |   body: string
 6 |   hadFrontmatter: boolean
 7 |   parseError: boolean
 8 | }
 9 | 
10 | export function parseFrontmatter<T = Record<string, unknown>>(
11 |   content: string
12 | ): FrontmatterResult<T> {
13 |   const frontmatterRegex = /^---\r?\n([\s\S]*?)\r?\n?---\r?\n([\s\S]*)$/
14 |   const match = content.match(frontmatterRegex)
15 | 
16 |   if (!match) {
17 |     return { data: {} as T, body: content, hadFrontmatter: false, parseError: false }
18 |   }
19 | 
20 |   const yamlContent = match[1]
21 |   const body = match[2]
22 | 
23 |   try {
24 |     // Use JSON_SCHEMA for security - prevents code execution via YAML tags
25 |     const parsed = yaml.load(yamlContent, { schema: yaml.JSON_SCHEMA })
26 |     const data = (parsed ?? {}) as T
27 |     return { data, body, hadFrontmatter: true, parseError: false }
28 |   } catch {
29 |     return { data: {} as T, body, hadFrontmatter: true, parseError: true }
30 |   }
31 | }
32 | 


--------------------------------------------------------------------------------
/src/hooks/ralph-loop/continuation-prompt-builder.ts:
--------------------------------------------------------------------------------
 1 | import { SYSTEM_DIRECTIVE_PREFIX } from "../../shared/system-directive"
 2 | import type { RalphLoopState } from "./types"
 3 | 
 4 | const CONTINUATION_PROMPT = `${SYSTEM_DIRECTIVE_PREFIX} - RALPH LOOP {{ITERATION}}/{{MAX}}]
 5 | 
 6 | Your previous attempt did not output the completion promise. Continue working on the task.
 7 | 
 8 | IMPORTANT:
 9 | - Review your progress so far
10 | - Continue from where you left off
11 | - When FULLY complete, output: <promise>{{PROMISE}}</promise>
12 | - Do not stop until the task is truly done
13 | 
14 | Original task:
15 | {{PROMPT}}`
16 | 
17 | export function buildContinuationPrompt(state: RalphLoopState): string {
18 | 	const continuationPrompt = CONTINUATION_PROMPT.replace(
19 | 		"{{ITERATION}}",
20 | 		String(state.iteration),
21 | 	)
22 | 		.replace("{{MAX}}", String(state.max_iterations))
23 | 		.replace("{{PROMISE}}", state.completion_promise)
24 | 		.replace("{{PROMPT}}", state.prompt)
25 | 
26 | 	return state.ultrawork ? `ultrawork ${continuationPrompt}` : continuationPrompt
27 | }
28 | 


--------------------------------------------------------------------------------
/src/tools/background-task/time-format.ts:
--------------------------------------------------------------------------------
 1 | export function formatDuration(start: Date, end?: Date): string {
 2 |   const duration = (end ?? new Date()).getTime() - start.getTime()
 3 |   const seconds = Math.floor(duration / 1000)
 4 |   const minutes = Math.floor(seconds / 60)
 5 |   const hours = Math.floor(minutes / 60)
 6 | 
 7 |   if (hours > 0) {
 8 |     return `${hours}h ${minutes % 60}m ${seconds % 60}s`
 9 |   }
10 |   if (minutes > 0) {
11 |     return `${minutes}m ${seconds % 60}s`
12 |   }
13 |   return `${seconds}s`
14 | }
15 | 
16 | export function formatMessageTime(value: unknown): string {
17 |   if (typeof value === "string") {
18 |     const date = new Date(value)
19 |     return Number.isNaN(date.getTime()) ? value : date.toISOString()
20 |   }
21 |   if (typeof value === "object" && value !== null) {
22 |     if ("created" in value) {
23 |       const created = (value as { created?: number }).created
24 |       if (typeof created === "number") {
25 |         return new Date(created).toISOString()
26 |       }
27 |     }
28 |   }
29 |   return "Unknown time"
30 | }
31 | 


--------------------------------------------------------------------------------
/src/features/hook-message-injector/types.ts:
--------------------------------------------------------------------------------
 1 | export type ToolPermission = boolean | "allow" | "deny" | "ask"
 2 | 
 3 | export interface MessageMeta {
 4 |   id: string
 5 |   sessionID: string
 6 |   role: "user" | "assistant"
 7 |   time: {
 8 |     created: number
 9 |     completed?: number
10 |   }
11 |   agent?: string
12 |   model?: {
13 |     providerID: string
14 |     modelID: string
15 |     variant?: string
16 |   }
17 |   path?: {
18 |     cwd: string
19 |     root: string
20 |   }
21 |   tools?: Record<string, ToolPermission>
22 | }
23 | 
24 | export interface OriginalMessageContext {
25 |   agent?: string
26 |   model?: {
27 |     providerID?: string
28 |     modelID?: string
29 |     variant?: string
30 |   }
31 |   path?: {
32 |     cwd?: string
33 |     root?: string
34 |   }
35 |   tools?: Record<string, ToolPermission>
36 | }
37 | 
38 | export interface TextPart {
39 |   id: string
40 |   type: "text"
41 |   text: string
42 |   synthetic: boolean
43 |   time: {
44 |     start: number
45 |     end: number
46 |   }
47 |   messageID: string
48 |   sessionID: string
49 | }
50 | 


--------------------------------------------------------------------------------
/src/tools/ast-grep/process-output-timeout.ts:
--------------------------------------------------------------------------------
 1 | type SpawnedProcess = {
 2 | 	stdout: ReadableStream | null
 3 | 	stderr: ReadableStream | null
 4 | 	exited: Promise<number>
 5 | 	kill: () => void
 6 | }
 7 | 
 8 | export async function collectProcessOutputWithTimeout(
 9 | 	process: SpawnedProcess,
10 | 	timeoutMs: number
11 | ): Promise<{ stdout: string; stderr: string; exitCode: number }> {
12 | 	const timeoutPromise = new Promise<never>((_, reject) => {
13 | 		const timeoutId = setTimeout(() => {
14 | 			process.kill()
15 | 			reject(new Error(`Search timeout after ${timeoutMs}ms`))
16 | 		}, timeoutMs)
17 | 		process.exited.then(() => clearTimeout(timeoutId))
18 | 	})
19 | 
20 | 	const stdoutPromise = process.stdout ? new Response(process.stdout).text() : Promise.resolve("")
21 | 	const stderrPromise = process.stderr ? new Response(process.stderr).text() : Promise.resolve("")
22 | 
23 | 	const stdout = await Promise.race([stdoutPromise, timeoutPromise])
24 | 	const stderr = await stderrPromise
25 | 	const exitCode = await process.exited
26 | 
27 | 	return { stdout, stderr, exitCode }
28 | }
29 | 


--------------------------------------------------------------------------------
/src/cli/config-manager/deep-merge-record.ts:
--------------------------------------------------------------------------------
 1 | export function deepMergeRecord<TTarget extends Record<string, unknown>>(
 2 |   target: TTarget,
 3 |   source: Partial<TTarget>
 4 | ): TTarget {
 5 |   const result: TTarget = { ...target }
 6 | 
 7 |   for (const key of Object.keys(source) as Array<keyof TTarget>) {
 8 |     if (key === "__proto__" || key === "constructor" || key === "prototype") continue
 9 |     const sourceValue = source[key]
10 |     const targetValue = result[key]
11 | 
12 |     if (
13 |       sourceValue !== null &&
14 |       typeof sourceValue === "object" &&
15 |       !Array.isArray(sourceValue) &&
16 |       targetValue !== null &&
17 |       typeof targetValue === "object" &&
18 |       !Array.isArray(targetValue)
19 |     ) {
20 |       result[key] = deepMergeRecord(
21 |         targetValue as Record<string, unknown>,
22 |         sourceValue as Record<string, unknown>
23 |       ) as TTarget[keyof TTarget]
24 |     } else if (sourceValue !== undefined) {
25 |       result[key] = sourceValue as TTarget[keyof TTarget]
26 |     }
27 |   }
28 | 
29 |   return result
30 | }
31 | 


--------------------------------------------------------------------------------
/src/agents/env-context.ts:
--------------------------------------------------------------------------------
 1 | /**
 2 |  * Creates OmO-specific environment context (time, timezone, locale).
 3 |  * Note: Working directory, platform, and date are already provided by OpenCode's system.ts,
 4 |  * so we only include fields that OpenCode doesn't provide to avoid duplication.
 5 |  * See: https://github.com/code-yeongyu/oh-my-opencode/issues/379
 6 |  */
 7 | export function createEnvContext(): string {
 8 |   const now = new Date()
 9 |   const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone
10 |   const locale = Intl.DateTimeFormat().resolvedOptions().locale
11 | 
12 |   const dateStr = now.toLocaleDateString(locale, {
13 |     weekday: "short",
14 |     year: "numeric",
15 |     month: "short",
16 |     day: "numeric",
17 |   })
18 | 
19 |   const timeStr = now.toLocaleTimeString(locale, {
20 |     hour: "2-digit",
21 |     minute: "2-digit",
22 |     second: "2-digit",
23 |     hour12: true,
24 |   })
25 | 
26 |   return `
27 | <omo-env>
28 |   Current date: ${dateStr}
29 |   Current time: ${timeStr}
30 |   Timezone: ${timezone}
31 |   Locale: ${locale}
32 | </omo-env>`
33 | }
34 | 


--------------------------------------------------------------------------------
/src/cli/doctor/checks/config.test.ts:
--------------------------------------------------------------------------------
 1 | import { describe, it, expect } from "bun:test"
 2 | import * as config from "./config"
 3 | 
 4 | describe("config check", () => {
 5 |   describe("checkConfig", () => {
 6 |     it("returns a valid CheckResult", async () => {
 7 |       //#given config check is available
 8 |       //#when running the consolidated config check
 9 |       const result = await config.checkConfig()
10 | 
11 |       //#then should return a properly shaped CheckResult
12 |       expect(result.name).toBe("Configuration")
13 |       expect(["pass", "fail", "warn", "skip"]).toContain(result.status)
14 |       expect(typeof result.message).toBe("string")
15 |       expect(Array.isArray(result.issues)).toBe(true)
16 |     })
17 | 
18 |     it("includes issues array even when config is valid", async () => {
19 |       //#given a normal environment
20 |       //#when running config check
21 |       const result = await config.checkConfig()
22 | 
23 |       //#then issues should be an array (possibly empty)
24 |       expect(Array.isArray(result.issues)).toBe(true)
25 |     })
26 |   })
27 | })
28 | 


--------------------------------------------------------------------------------
/src/hooks/atlas/atlas-hook.ts:
--------------------------------------------------------------------------------
 1 | import type { PluginInput } from "@opencode-ai/plugin"
 2 | import { createAtlasEventHandler } from "./event-handler"
 3 | import { createToolExecuteAfterHandler } from "./tool-execute-after"
 4 | import { createToolExecuteBeforeHandler } from "./tool-execute-before"
 5 | import type { AtlasHookOptions, SessionState } from "./types"
 6 | 
 7 | export function createAtlasHook(ctx: PluginInput, options?: AtlasHookOptions) {
 8 |   const sessions = new Map<string, SessionState>()
 9 |   const pendingFilePaths = new Map<string, string>()
10 | 
11 |   function getState(sessionID: string): SessionState {
12 |     let state = sessions.get(sessionID)
13 |     if (!state) {
14 |       state = { promptFailureCount: 0 }
15 |       sessions.set(sessionID, state)
16 |     }
17 |     return state
18 |   }
19 | 
20 |   return {
21 |     handler: createAtlasEventHandler({ ctx, options, sessions, getState }),
22 |     "tool.execute.before": createToolExecuteBeforeHandler({ ctx, pendingFilePaths }),
23 |     "tool.execute.after": createToolExecuteAfterHandler({ ctx, pendingFilePaths }),
24 |   }
25 | }
26 | 


--------------------------------------------------------------------------------
/src/cli/doctor/checks/tools-lsp.ts:
--------------------------------------------------------------------------------
 1 | import type { LspServerInfo } from "../types"
 2 | import { isServerInstalled } from "../../../tools/lsp/config"
 3 | 
 4 | const DEFAULT_LSP_SERVERS: Array<{ id: string; binary: string; extensions: string[] }> = [
 5 |   { id: "typescript-language-server", binary: "typescript-language-server", extensions: [".ts", ".tsx", ".js", ".jsx"] },
 6 |   { id: "pyright", binary: "pyright-langserver", extensions: [".py"] },
 7 |   { id: "rust-analyzer", binary: "rust-analyzer", extensions: [".rs"] },
 8 |   { id: "gopls", binary: "gopls", extensions: [".go"] },
 9 | ]
10 | 
11 | export function getLspServersInfo(): LspServerInfo[] {
12 |   return DEFAULT_LSP_SERVERS.map((server) => ({
13 |     id: server.id,
14 |     installed: isServerInstalled([server.binary]),
15 |     extensions: server.extensions,
16 |     source: "builtin",
17 |   }))
18 | }
19 | 
20 | export function getLspServerStats(servers: LspServerInfo[]): { installed: number; total: number } {
21 |   return {
22 |     installed: servers.filter((server) => server.installed).length,
23 |     total: servers.length,
24 |   }
25 | }
26 | 


--------------------------------------------------------------------------------
