# AWS関数 変更履歴

## [2.3.0] - 2025-10-07

### 🐛 バグ修正 & 📊 改善

#### クリーンアップ機能の強化
- **session-manager-plugin子プロセスの完全停止**: 親プロセス（aws cli）停止時に残る子プロセスも確実に停止
- **ポート解放の確実性向上**: `lsof`を使用してポート使用プロセスを特定し、TERM/KILLシグナルで確実に停止
- **待機時間の追加**: プロセス停止後に1秒待機してポート解放を確認

**技術詳細**:
```zsh
# session-manager-pluginプロセスも停止（子プロセス対策）
plugin_processes=$(lsof -ti:$RDS_SSM_LOCAL_PORT 2>/dev/null)
if [[ "$cmd_line" =~ "session-manager-plugin" ]]; then
    kill -TERM "$pid" 2>/dev/null
    sleep 1
    if kill -0 "$pid" 2>/dev/null; then
        kill -KILL "$pid" 2>/dev/null
    fi
fi
```

#### パスワード認証エラー時の詳細トラブルシューティング
- **接続失敗の検出**: データベースクライアントの終了コードをキャプチャ
- **4つの主要原因の提示**:
  1. パスワード認証エラー（Secrets Manager不一致）
  2. ユーザー名の不一致
  3. ポートフォワーディングの問題
  4. データベース名の誤り
- **具体的な対処方法**: 各原因に対する詳細な解決手順
- **診断コマンドの提供**: 問題切り分けのための実行可能コマンド

**使用例**:
```bash
rds-ssm

# データベース接続時にパスワード認証エラーが発生した場合:

❌ データベース接続に失敗しました（終了コード: 2）

🔍 考えられる原因と対処方法:

1. パスワード認証エラー
   💡 Secrets Managerのパスワードが正しくない可能性があります
   ✅ 対処方法:
      - AWS ConsoleでRDSのマスターパスワードを確認
      - Secrets Managerのパスワードを更新:
        aws secretsmanager update-secret --profile xxx \
          --secret-id <secret-name> \
          --secret-string '{"username":"dhadmin","password":"NEW_PASSWORD"}'
      - または、rds-ssm実行時に手動入力オプションを選択

2. ユーザー名が正しくない
   💡 RDSのマスターユーザー名と一致していない可能性があります
   ✅ 対処方法:
      - AWS ConsoleでRDSのマスターユーザー名を確認
      - データベース名入力時に正しいユーザー名を入力

3. ポートフォワーディングが正常に動作していない
   💡 ローカルポート5432がRDSに到達していない可能性があります
   ✅ 対処方法:
      - 別のターミナルで接続状況を確認:
        lsof -i :5432
      - ポートフォワーディングのログを確認:
        cat /tmp/ssm-port-forward-5432.log
        cat /tmp/ssm-port-forward-5432.err

4. データベース名が正しくない
   💡 指定したデータベース名が存在しない可能性があります
   ✅ 対処方法:
      - PostgreSQL: デフォルトは 'postgres'
      - MySQL: デフォルトは 'mysql' または RDS識別子

💡 診断コマンド:
   # ポートフォワーディングの動作確認:
   nc -zv localhost 5432

   # 接続テスト（パスワード手動入力）:
   PGPASSWORD='YOUR_PASSWORD' psql -h localhost -p 5432 -U dhadmin -d postgres
```

**メリット**:
- ✅ クリーンアップの完全性向上（残存プロセスゼロ）
- ✅ パスワード認証エラーの迅速な原因特定
- ✅ ユーザー自身での問題解決を支援
- ✅ Secrets Manager更新方法の明示

---

## [2.2.0] - 2025-10-07

### 📊 改善

#### ポートフォワーディング診断機能の強化
- **タイムアウトの延長**: 30秒 → 60秒に延長
- **詳細なログ記録**: stdout/stderrを分離して記録
  - 標準出力: `/tmp/ssm-port-forward-{port}.log`
  - エラー出力: `/tmp/ssm-port-forward-{port}.err`
- **プロセス監視**: SSMプロセスの異常終了を即座に検出
- **段階的診断**: セッション開始とポート確立を個別に確認
- **進捗表示**: 10秒ごとの経過時間表示
- **詳細なトラブルシューティング情報**:
  - 考えられる原因の提示
  - 診断コマンドの提供
  - 自動クリーンアップ機能

**使用例**:
```bash
rds-ssm

# 出力例（成功時）:
⏳ 接続確立を待機中（最大60秒）...
   SSMセッション開始を確認中...
   ✅ SSMセッション開始を確認
   🔗 ポートフォワーディング確立を待機中...
........ [10s].......... [20s]...
✅ ポートフォワーディング確立完了

# 出力例（失敗時）:
❌ SSMプロセスが異常終了しました

📋 標準出力:
Starting session with SessionId: dh_y.ohi-xxx...

📋 エラーログ:
Command died with <Signals.SIGTERM: 15>

🔍 考えられる原因:
   1. EC2インスタンスからRDSエンドポイントへの接続ができない
      → セキュリティグループでポート5432が開いているか確認してください
   2. RDSエンドポイントの名前解決に失敗している
      → EC2のVPCとRDSのVPCが同じか確認してください
   3. IAM権限が不足している
      → SSM、RDS関連の権限を確認してください

💡 診断コマンド:
   # EC2からRDSへの接続性を確認:
   aws ssm start-session --profile xxx --target i-xxx
   # EC2内で実行:
   nc -zv rds-endpoint.amazonaws.com 5432
   nslookup rds-endpoint.amazonaws.com
```

**技術詳細**:
- プロセス生存確認: `kill -0 $ssm_pid`で毎秒チェック
- セッション開始検出: ログファイル内の"Starting session"文字列を検出
- ポート確立検出: `lsof -i :$local_port`でポートのリッスン状態を確認
- 自動クリーンアップ: タイムアウトまたは異常終了時にSSMプロセスを自動停止

**メリット**:
- ✅ 問題の早期発見と迅速な診断
- ✅ より詳細なエラー情報による効率的なトラブルシューティング
- ✅ 長時間のネットワーク接続にも対応（60秒タイムアウト）
- ✅ ユーザーへの明確なフィードバックと次のアクション提示

---

## [2.1.0] - 2025-10-07

### ✨ 追加機能

#### ローカルポート自動選択（デフォルト動作）
- **変更内容**: ローカルポートのデフォルト動作を**自動選択**に変更
- **従来**: ユーザーが空欄入力 → デフォルトポート（5432/3306）を使用
- **現在**: ユーザーが空欄入力 → 自動的に空きポートを検索して使用

**使用例**:
```bash
rds-ssm

# ポート設定時の対話:
🔍 ローカルポートを設定します...
ポート番号を指定 (空欄=自動選択, デフォルト候補: 5432): [Enter]
   自動選択モード: 使用可能なポートを検索中...
   ✅ ポート 5433 を使用します（5432 は使用中）

# または手動指定:
ポート番号を指定 (空欄=自動選択, デフォルト候補: 5432): 5555
   ✅ 指定されたポート 5555 を使用します
```

**技術詳細**:
- 空欄入力（Enterのみ）で自動的に`_rds_ssm_find_available_port()`を呼び出し
- デフォルトポート（PostgreSQL: 5432, MySQL: 3306）から+10範囲を検索
- 手動でポート番号を入力することも可能（従来通り）

**メリット**:
- ✅ ポート競合によるエラーを事前に防止
- ✅ ユーザーが何も入力しなくても最適なポートを自動選択
- ✅ 複数のRDS接続を同時に維持可能（異なるポートを自動割り当て）

### 📝 ドキュメント更新
- README.md: ローカルポート設定の使用例を追加
- インタラクティブなプロンプトメッセージを改善

---

## [2.0.0] - 2025-10-07

### ✨ 追加機能

#### ポート競合自動解決
- **新関数**: `_rds_ssm_find_available_port()`
  - ポートが使用中の場合、自動的に空きポートを検索（+10範囲）
  - 非SSMプロセスがポートを占有している場合でも、自動的に代替ポートを使用
  - ユーザーに使用ポートを明確に通知

**使用例**:
```bash
# PostgreSQLのデフォルトポート5432が使用中の場合
rds-ssm

# 出力例:
# ℹ️  非SSMプロセスがポート 5432 を使用中です
#    空きポートを自動検索します...
# ℹ️  ポート 5432 は使用中のため、ポート 5433 を使用します
# ✅ 使用可能なポート 5433 を発見しました
# 📊 ポートフォワーディング情報:
#    プロセスID: 460760
#    使用ポート: localhost:5433 → mydb.ap-northeast-1.rds.amazonaws.com:5432
```

**技術詳細**:
- 検索範囲: 希望ポート番号から +10（例: 5432-5441）
- タイムアウト: 最大10回試行
- ポート判定: `lsof -ti:PORT` でポート使用状況を確認
- 環境変数: `RDS_SSM_LOCAL_PORT` に実際に使用したポートを保存

### 📊 改善

#### ポートフォワーディング情報の表示強化
- **変更前**:
  ```
  📊 ポートフォワーディングプロセス ID: 460760
  ```

- **変更後**:
  ```
  📊 ポートフォワーディング情報:
     プロセスID: 460760
     使用ポート: localhost:5433 → mydb.region.rds.amazonaws.com:5432
  ```

### 🏗️ アーキテクチャ変更

#### モジュール化
- **変更前**: 単一ファイル `aws.zsh` (3,131行)
- **変更後**: モジュール構成（7ファイル）

**新しいディレクトリ構造**:
```
zsh/functions/
├── aws.zsh (164行)          # エントリーポイント
└── aws/
    ├── README.md            # ドキュメント
    ├── CHANGELOG.md         # 変更履歴
    ├── core.zsh (127行)     # 共通関数
    ├── ec2.zsh (69行)       # EC2関連
    ├── ecs.zsh (29行)       # ECS関連
    ├── logs.zsh (64行)      # CloudWatch Logs
    ├── rds.zsh (132行)      # RDS-SSMメイン
    └── rds-helpers.zsh (2,826行) # RDS内部実装
```

**メリット**:
- ✅ 保守性向上（機能ごとに分離）
- ✅ 拡張性向上（新サービス追加が容易）
- ✅ 可読性向上（各ファイル29-2,826行に削減）
- ✅ 依存関係の明確化
- ✅ テスト容易性の向上

#### デバッグモード追加
```bash
export ZSH_FUNCTIONS_DEBUG=true
source ~/dots/zsh/functions/aws.zsh

# 出力例:
# 📂 AWS関数ディレクトリ: /home/y_ohi/dots/zsh/functions/aws
# ✅ core.zsh を読み込みました
# ✅ ec2.zsh を読み込みました
# ✅ ecs.zsh を読み込みました
# ✅ logs.zsh を読み込みました
# ✅ rds-helpers.zsh を読み込みました
# ✅ rds.zsh を読み込みました
```

### 📝 ドキュメント

#### 新規作成
- `README.md`: 完全なドキュメント（360行）
  - 各モジュールの詳細説明
  - 使用方法とオプション
  - トラブルシューティング
  - カスタマイズ方法
  - セキュリティ機能
- `CHANGELOG.md`: 変更履歴（このファイル）

#### 更新
- `aws-help`: モジュール構成の表示を追加

### 🐛 バグ修正

なし（新規機能追加のみ）

---

## [1.0.0] - 2025-10-06以前

### 初期バージョン
- EC2、RDS、ECS、CloudWatch Logs関連の基本機能
- SSM経由の安全な接続
- fzfによる対話的なリソース選択
- Secrets Manager統合
- IAM認証サポート
- 並列処理によるパフォーマンス最適化

---

## 今後の予定

### v2.4.0（予定）
- [ ] 環境変数によるポート事前指定機能（`RDS_LOCAL_PORT`）
- [ ] S3関連関数の追加
- [ ] Lambda関連関数の追加

### v3.0.0（予定）
- [ ] 設定ファイル対応（YAML/JSON）
- [ ] プロファイル別デフォルト設定
- [ ] テストスイートの追加
- [ ] CI/CD統合

---

## 互換性

### 破壊的変更
なし。既存のコマンドはすべて互換性を維持しています。

### 非推奨
なし

### 削除
なし

---

## アップグレード方法

```bash
# 1. バックアップ（自動作成済み）
ls ~/dots/zsh/functions/aws.zsh.backup

# 2. 新バージョンの読み込み
source ~/dots/zsh/functions/aws.zsh

# 3. 動作確認
aws-help
```

---

## ロールバック方法

```bash
# バックアップから復元
mv ~/dots/zsh/functions/aws.zsh.backup ~/dots/zsh/functions/aws.zsh
rm -rf ~/dots/zsh/functions/aws/
source ~/dots/zsh/functions/aws.zsh
```

---

## 貢献者

- y_ohi - 初期開発、v2.0.0モジュール化

---

## フィードバック

問題や改善提案がある場合は、以下の方法でお知らせください：
- GitHub Issues
- プルリクエスト
- メール
